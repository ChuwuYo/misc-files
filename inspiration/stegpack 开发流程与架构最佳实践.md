# stegpack 规划文档（WebAssembly + 桌面双端）

## 一、项目目标

- 构建支持 13 种常见文件格式的「加壳 / 去壳」工具，满足跨平台的桌面客户端与 Web 端同步发布。
- 提供一致的核心能力（inject/extract）、可选加密、自动/手动格式识别、进度与错误可视化。
- 保持低依赖、轻量打包、可扩展，适配社交平台的二次压缩与内容审查容忍度。

---

## 二、范围与格式支持

- 图片：PNG（zTXt chunk）、JPEG（COM 段）、GIF（注释扩展 0x21 0xFE）
- 音视频：MP3（ID3v2 尾部填充）、MP4（free box）
- 文档：PDF（文件尾 %%EOF 之后）
- Office：docx / xlsx / pptx（作为 ZIP 尾部追加数据）
- 压缩包：zip / 7z / rar（尾部追加，视兼容性与容忍度）
- 可执行文件：exe（PE：覆盖 DOS Stub 或 .rsrc 节末尾）

说明与约束提示：

- ZIP 明确允许尾部冗余数据；7z/rar 对尾部冗余容忍度依实现而异，需在“风险与对策”中单独约束。
- 社交平台重编码会影响部分容器（尤其是视频、图片），采用对重编码最稳健的嵌入点并保持回归测试。

---

## 三、选型与总体架构

- 核心语言：Rust 1.78（单一代码库，面向二进制安全与高性能处理）
- 桌面端：Tauri（Rust 后端 + 任意前端框架，轻量打包）
- Web 端：WebAssembly（wasm）构建，同一套 Rust 核心编译为 wasm，在浏览器执行
- 前端：React / Vue / Svelte 任一；建议组件化、可复用 UI 逻辑
- 加密：AES-256-GCM（可选），密码派生使用 KDF（scrypt 或 Argon2），随机数使用浏览器或系统安全源

分层设计（逻辑共享）：

- 核心库（Rust）：无平台耦合，不做文件 IO，仅处理字节流与格式协议；面向 native 与 wasm 双目标。
- 适配层：
  - 桌面：文件系统访问、加密随机源、并发执行（Tauri 命令/任务）
  - Web：File/Blob/ArrayBuffer 读写、WebCrypto 随机源、wasm 内存管理
- 界面层（Web 前端）：文件拖放/选择、选项面板、进度与日志、结果下载/保存

---

## 四、WebAssembly 技术方案

兼容性与目标产物：

- 目标平台：现代浏览器（Chromium/Firefox/Safari 当前稳定版本）
- 产物：一个 wasm 模块 + 前端静态资源（同 UI 可被 Tauri 复用）
- 绑定：选择 wasm-bindgen 工具链；前端通过 JS/TS 调用暴露的 inject/extract 能力

二进制与库兼容建议：

- 压缩/解压算法选择 wasm 友好实现（纯 Rust），避免 C FFI：
  - DEFLATE/ZIP：优先选择 pure-Rust 实现（如 miniz_oxide 等）
  - MP4：采用纯解析策略（盒结构扫描、注入 free box），避免依赖系统解码器
  - PDF：仅在 EOF 后追加，避免解析完整对象图
  - JPEG/GIF：自定义段扫描/写入，绕开重量级编解码器
- Office（三件套）：作为 ZIP 容器尾部追加，无需重打包；保留严格校验的回退策略
- 7z/rar：采取“仅尾部追加、非破坏性写入”和“严格兼容性警告”，并在 UI 上明确风险提示与验收检查

大文件与内存策略：

- 浏览器内存预算敏感，避免一次性复制大缓冲：
  - 分块读写：通过 JS 层切片，将片段映射/写入 wasm 内存后即处理、落盘为 Blob
  - 避免多重拷贝：使用单次 ArrayBuffer → Uint8Array 视图策略
  - 进度回调：在处理长文件（视频、PDF）时提供进度事件，避免页面假死
- 失败恢复与幂等：
  - 注入前后校验：为 payload 包装版本、格式、长度、校验和
  - 提取阶段：严格 marker 检测与校验，杜绝误读

安全与加密：

- 加密（可选）：AES-256-GCM，随机 nonce，存储盐与参数；默认开启 payload 完整性校验（SHA-256）
- 密钥派生：scrypt 或 Argon2（参数可配置，默认中等强度）
- 随机源：浏览器使用 crypto.getRandomValues；桌面使用系统级 RNG
- 密钥与明文生命周期：最小驻留时间、显式内存清零（在可行范围内）

---

## 五、桌面客户端（Tauri）方案

- 权限与安全：最小化 FS 权限；仅允许用户选择的路径；关闭不必要的 API
- IPC 设计：UI 调用注入/提取、加密开关、格式自动识别、进度订阅、错误上报
- 资源与打包：小体积打包；对 Windows/macOS/Linux 提供签名与自动更新策略（可选）
- 文件关联（可选）：注册右键菜单或拖拽到图标快速处理
- 与 Web 端一致性：相同 UI 代码复用；核心处理逻辑完全一致（同一 Rust 库不同目标）

---

## 六、UI 交互设计

核心流程：

- 加壳（Inject）：选择壳文件 → 选择 payload → 选择输出 → 可选设置（加密、密码、KDF 参数、嵌入策略）→ 执行 → 下载/保存结果
- 去壳（Extract）：选择已加壳文件 → 选择输出 → 可选输入密码 → 执行 → 下载/保存 payload

主要模块：

- 文件区：拖放/选择、历史记录、最近使用
- 选项区：自动/手动格式识别、加密开关、密码与强度提示、KDF 参数（简单/高级）
- 状态区：实时进度、日志（可折叠）、异常与兼容性提示（如 7z/rar 风险）
- 结果区：导出按钮、复制校验和、复制 CLI 参数（桌面端）
- 设置：国际化、主题、性能偏好（内存占用策略）、隐私与安全说明

可用性与可访问性：

- 键盘操作、屏幕阅读器标签、对比度与主题配色
- 大文件操作时的非阻塞 UI 与取消操作

---

## 七、一致性与扩展性

- 核心 API 一致：相同的输入输出约定（字节流、嵌入点、校验与错误）
- 格式扩展：新增格式需提供嵌入点规范说明、社交平台兼容性验证、失败回退策略
- 插件化：格式处理以插件注册方式接入；UI 自动生成支持列表与说明
- 国际化：中英双语起步，抽象文案字典，避免硬编码

---

## 八、测试与验证

测试范围：

- 单元测试：各格式嵌入/提取、校验、加密、错误路径
- 兼容性测试：多平台、不同浏览器、不同社交平台二次压缩
- 性能与内存：文件大小分档（小/中/大），记录耗时与峰值内存
- 安全测试：密钥派生参数正确性、随机源可用性、完整性校验与篡改检测

验证矩阵（示例基线，持续扩充）：

- 社交平台：微信（PNG/JPEG/GIF/MP4）、微博（PNG/JPEG/MP4/PDF）、QQ（PNG/JPEG/docx/zip/exe）
- 浏览器：Chromium 家族 / Firefox / Safari 当前稳定版
- 桌面 OS：Windows / macOS / Linux 主流发行版

---

## 九、风险与对策

- 平台重编码风险（图片/视频）：采用对重编码容忍的嵌入点；若失败提供“稳健模式”（更保守的写入）
- 7z/rar 尾部追加不一致：对目标解压器进行白名单兼容验证；UI 明确标注风险并建议 ZIP 替代
- 大文件内存压力（Web）：分块处理、进度回调、结果以流式 Blob 生成
- 库兼容性（wasm）：避免 C FFI；选择纯 Rust 实现；对不兼容库做隔离与可替换封装
- 合规与滥用：在 UI 与文档中标注用途边界与法律风险，默认开启完整性校验与加密

---

## 十、里程碑与交付物

- M1：核心库雏形（PNG/JPEG/GIF/ZIP 注入/提取、校验），CLI 验证
- M2：扩展至 13 种格式，完成回归与社交平台基线测试
- M3：Tauri 桌面端 GUI（文件流程、进度、错误、加密），打包签名
- M4：WebAssembly 版 Web 应用（同等能力、分块处理、浏览器兼容）
- M5：优化与文档（国际化、主题、性能参数、格式白皮书、风险指引）

---

## 十一、项目结构

（留空）

---

# stegpack 开发流程

## 开发流程总览（瀑布式 +迭代流）

1. **需求确认阶段**
   
   - 明确支持格式、目标平台（桌面/Web）、功能边界（加壳/去壳/加密）
   - 设计 UI 交互流程与用户场景
   - 输出规划文档（已完成）

2. **架构设计阶段**
   
   - 模块划分（核心逻辑 / 平台适配 / UI）
   - 接口定义（inject/extract trait、加密模块、wasm 绑定）
   - 技术选型（Rust + Tauri + wasm-bindgen + 前端框架）

3. **核心功能开发阶段**
   
   - 实现 inject/extract trait 接口
   - 每种格式模块化实现（格式识别、嵌入点处理）
   - 加密模块（AES-256-GCM + KDF）
   - 单元测试覆盖

4. **平台适配阶段**
   
   - Tauri 桌面端集成（命令调用、文件访问、进度反馈）
   - WebAssembly 构建（wasm-bindgen、前端调用、Blob 处理）

5. **UI 开发阶段**
   
   - 前端组件开发（文件选择、选项面板、进度条、结果区）
   - 状态管理（React/Vue 状态流、错误处理）
   - 国际化与主题支持

6. **测试与验证阶段**
   
   - 格式兼容性测试（社交平台、压缩行为）
   - 性能测试（大文件、内存占用）
   - 安全测试（加密正确性、随机源、校验机制）

7. **打包与发布阶段**
   
   - Tauri 打包（签名、平台构建）
   - Web 端部署（静态资源 + wasm）
   - 文档编写与用户指南

8. **维护与扩展阶段**
   
   - 新格式支持（插件化）
   - UI 优化（动画、响应）
   - 社区反馈与版本迭代

---

# stegpack 架构最佳实践

### 1. 核心逻辑模块（Rust）

core/
├── lib.rs           // 公共接口定义（inject/extract）
├── formats/         // 每种格式一个模块
│   ├── mod.rs
│   ├── png.rs
│   ├── jpeg.rs
│   └── ...
├── crypto/          // 加密模块（AES + KDF）
├── utils/           // 通用工具（校验、marker、压缩）
└── error.rs         // 错误类型与处理

### 2. 桌面端模块（Tauri）

src-tauri/
├── main.rs          // Tauri 启动入口
├── commands.rs      // CLI 命令绑定 inject/extract
├── fs.rs            // 文件读写封装
├── state.rs         // 状态管理（进度、错误）
└── config.rs        // 用户配置（加密参数、默认路径）

### 3. WebAssembly 模块

wasm/
├── lib.rs           // wasm-bindgen 接口
├── memory.rs        // wasm 内存管理
├── adapter.rs       // JS <-> Rust 数据转换
└── crypto.rs        // WebCrypto 适配

### 4. 前端 UI 模块（React/Vue/Svelte）

ui/
├── components/
│   ├── FileSelector.tsx
│   ├── FormatPicker.tsx
│   ├── EncryptPanel.tsx
│   ├── ProgressBar.tsx
│   ├── ResultViewer.tsx
│   └── IntegrityCheckButton.tsx   // 检查是否被破坏的按钮
├── pages/
│   ├── InjectPage.tsx
│   └── ExtractPage.tsx
├── store/
│   └── state.ts
├── i18n/
│   └── zh.ts / en.ts
└── theme/
    └── dark.ts / light.ts

---

# UI 交互设计

核心流程：

- 加壳（Inject）：选择壳文件 → 选择 payload → 选择输出 → 可选设置（加密、密码、KDF 参数、嵌入策略）→ 执行 → 下载/保存结果
- 去壳（Extract）：选择已加壳文件 → 选择输出 → 可选输入密码 → 执行 → 下载/保存 payload

主要模块：

- 文件区：拖放/选择、历史记录、最近使用
- 选项区：自动/手动格式识别、加密开关、密码与强度提示、KDF 参数（简单/高级）
- 状态区：实时进度、日志（可折叠）、异常与兼容性提示（如 7z/rar 风险）
- 结果区：导出按钮、复制校验和、复制 CLI 参数（桌面端）
- 设置：国际化、主题、性能偏好（内存占用策略）、隐私与安全说明
- **完整性检查按钮**：在 UI 中提供“检查是否被破坏”的功能，用户可选定文件后进行结构校验与嵌入点验证，提示是否可安全提取

可用性与可访问性：

- 键盘操作、屏幕阅读器标签、对比度与主题配色
- 大文件操作时的非阻塞 UI 与取消操作

---

# 保障机制与风险控制

- 使用规范允许的嵌入点，确保格式结构不被破坏
- 添加 marker + 长度 + 校验，保障提取准确性
- 可选 AES-256-GCM 加密，防止泄露与篡改
- UI 提供“完整性检查”功能，辅助用户验证文件是否安全
- 对社交平台压缩行为进行测试验证，提供格式兼容矩阵
- 对高风险格式（如 7z/rar）提供提示与稳健模式

---

# 项目维护建议

- 插件机制：格式模块注册机制，支持动态扩展
- 配置持久化：用户偏好、加密参数、历史记录
- 社区反馈：收集兼容性问题与新需求
- 安全审计：定期检查加密模块与依赖库更新
