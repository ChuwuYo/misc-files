<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>番茄钟</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f7fff8; --card:#ffffff; --accent:#7bd389; --accent-2:#ffd1e3; --muted:#8a8a8a; --pixel:#333;
    --glass: rgba(255,255,255,0.6);
    --shadow: 4px 4px 0 rgba(0,0,0,0.07);
  }
  [data-theme="dark"]{
    --bg:#071022; --card:#0b1b2b; --accent:#6ae3b7; --accent-2:#ff9ec3; --muted:#9fb0c3; --pixel:#e6eef6; --glass: rgba(255,255,255,0.03); --shadow: 4px 4px 0 rgba(0,0,0,0.6);
  }
  /* candy / pastel variants */
  [data-theme="peach"]{
    --bg:#fff6f6; --card:#fff; --accent:#ff9fa8; --accent-2:#ffd4a3; --muted:#9b7b7b; --pixel:#432b2b;
  }

  html,body{
    height:100%;
    margin:0;
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: linear-gradient(180deg, var(--bg), #ffffff00);
    color:var(--pixel);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  .app{
    max-width:1100px;
    margin:20px auto;
    padding:18px;
    display:grid;
    grid-template-columns: 1fr 360px;
    gap:18px;
  }
  /* responsive */
  @media (max-width:880px){
    .app{ grid-template-columns: 1fr; padding:12px; }
  }

  header{
    grid-column:1/-1;
    display:flex;
    align-items:center;
    gap:12px;
    margin-bottom:6px;
  }
  h1{
    margin:0;
    font-family: 'Press Start 2P', monospace;
    font-size:18px;
    letter-spacing:1px;
    color:var(--pixel);
  }

  .main-card, .side-card{
    background: linear-gradient(180deg, var(--card), color-mix(in srgb, var(--card) 90%, transparent));
    border:4px solid rgba(0,0,0,0.06);
    border-radius:10px;
    padding:14px;
    box-shadow: var(--shadow);
  }

  .main-card{ display:flex; gap:12px; align-items:center; min-height:240px; }
  .left{
    width:48%;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:10px;
  }
  .right{
    width:52%;
    display:flex;
    flex-direction:column;
    gap:10px;
    align-items:center;
  }

  /* Pixel character (SVG container) */
  .sprite{
    width:180px;
    height:180px;
    image-rendering: pixelated;
    background: linear-gradient(180deg, color-mix(in srgb,var(--accent) 20%, transparent), transparent);
    border-radius:6px;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
    padding:6px;
  }
  .sprite svg{ width:140px; height:140px; }

  /* timer display */
  .timer{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:6px;
    user-select:none;
  }
  .time-large{
    font-family:'Press Start 2P', monospace;
    font-size:48px;
    line-height:1;
    color:var(--pixel);
    text-shadow: 2px 2px 0 rgba(0,0,0,0.06);
  }
  .phase{
    font-family:'Press Start 2P', monospace;
    font-size:12px;
    color:var(--muted);
  }

  /* pixel progress bar (block segments) */
  .progress{
    width:100%;
    height:26px;
    background: linear-gradient(90deg, rgba(0,0,0,0.02), transparent);
    border-radius:6px;
    padding:6px;
    box-sizing:border-box;
    display:flex;
    align-items:center;
  }
  .blocks{
    height:100%;
    width:100%;
    display:flex;
    gap:4px;
    align-items:center;
  }
  .block{
    flex:1 1 auto;
    background:linear-gradient(180deg, rgba(255,255,255,0.6), rgba(0,0,0,0.03));
    border:3px solid rgba(0,0,0,0.06);
    border-radius:3px;
    height:100%;
    transition:background .3s, transform .12s;
    box-shadow: 2px 2px 0 rgba(0,0,0,0.04);
  }
  .block.active{
    background: linear-gradient(180deg, color-mix(in srgb,var(--accent) 50%, #fff), var(--accent));
    transform: translateY(-2px);
    box-shadow: 2px 6px 0 rgba(0,0,0,0.06);
  }

  /* controls */
  .controls{
    display:flex;
    gap:8px;
    margin-top:6px;
  }
  button.btn{
    font-family:'Press Start 2P', monospace;
    font-size:12px;
    padding:10px 14px;
    border-radius:6px;
    border:4px solid rgba(0,0,0,0.06);
    background:var(--glass);
    cursor:pointer;
    color:var(--pixel);
    box-shadow: var(--shadow);
    transition: transform .08s;
    user-select:none;
  }
  button.btn:active{ transform: translateY(2px); }
  button.primary{
    background: linear-gradient(180deg, var(--accent), color-mix(in srgb,var(--accent) 60%, #fff));
    color: #07211a;
    border-color: rgba(0,0,0,0.06);
  }
  button.warn{
    background: linear-gradient(180deg, var(--accent-2), color-mix(in srgb,var(--accent-2) 60%, #fff));
    color:#2a0a14;
  }

  /* side card layout */
  .side-card{ display:flex; flex-direction:column; gap:10px; }
  .setting-row{ display:flex; justify-content:space-between; gap:8px; align-items:center; padding:6px; border-radius:6px; background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent); }
  .setting-row label{ font-size:12px; color:var(--muted); font-weight:600; }
  .setting-row input[type="number"]{ width:78px; padding:6px; font-family: monospace; border-radius:6px; border:2px solid rgba(0,0,0,0.05); background: transparent; color:var(--pixel); }
  .setting-row input[type="range"]{ width:150px; }

  .stats{ padding:8px; border-radius:6px; background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent); display:flex; justify-content:space-between; align-items:center; }
  .muted{ color:var(--muted); font-size:12px; }

  footer.help{
    grid-column:1/-1;
    margin-top:8px;
    font-size:12px;
    color:var(--muted);
    display:flex;
    justify-content:space-between;
    align-items:center;
  }

  /* theme buttons */
  .theme-row{ display:flex; gap:8px; }
  .swatch{ width:34px; height:34px; border-radius:6px; border:3px solid rgba(0,0,0,0.06); cursor:pointer; box-shadow: var(--shadow); }

  /* little badge */
  .badge{ font-family:'Press Start 2P', monospace; font-size:11px; padding:6px 8px; border-radius:6px; background:var(--card); border:2px solid rgba(0,0,0,0.04); box-shadow: var(--shadow); }

  /* small tweaks for mobile */
  @media (max-width:560px){
    .sprite{ width:140px; height:140px; }
    .time-large{ font-size:36px; }
  }
</style>
</head>
<body data-theme="default">
  <div class="app" role="application" aria-label="番茄钟应用">
    <header>
      <h1>番茄钟</h1>
      <div style="flex:1"></div>
      <div class="badge" id="todayBadge" title="今天完成的番茄数">今日：0</div>
    </header>

    <section class="main-card" aria-labelledby="main-timer">
      <div class="left">
        <div class="sprite" aria-hidden="true">
          <!-- Cute pixel character (inline SVG) -->
          <svg viewBox="0 0 32 32" shape-rendering="crispEdges" preserveAspectRatio="xMidYMid meet">
            <!-- background -->
            <rect x="0" y="0" width="32" height="32" fill="transparent"/>
            <!-- hair -->
            <rect x="9" y="4" width="14" height="1" fill="#2b2f4a"/>
            <rect x="8" y="5" width="16" height="2" fill="#2b2f4a"/>
            <rect x="7" y="7" width="18" height="2" fill="#2b2f4a"/>
            <rect x="8" y="9" width="16" height="1" fill="#f6c2e0"/>
            <!-- face -->
            <rect x="10" y="11" width="12" height="6" fill="#ffd9b3"/>
            <!-- eyes -->
            <rect x="12" y="13" width="1" height="1" fill="#1f2329"/>
            <rect x="19" y="13" width="1" height="1" fill="#1f2329"/>
            <!-- blush -->
            <rect x="11" y="15" width="1" height="1" fill="#ffb6c9"/>
            <rect x="20" y="15" width="1" height="1" fill="#ffb6c9"/>
            <!-- body -->
            <rect x="9" y="17" width="14" height="9" fill="#7bd389"/>
            <rect x="9" y="25" width="14" height="1" fill="#6ac07a"/>
            <!-- eyes sparkle -->
            <rect x="12" y="12" width="1" height="1" fill="#ffffff"/>
            <rect x="19" y="12" width="1" height="1" fill="#ffffff"/>
          </svg>
        </div>

        <div class="timer" id="main-timer">
          <div class="time-large" id="timeDisplay">25:00</div>
          <div class="phase" id="phaseDisplay">工作</div>

          <div class="controls" role="group" aria-label="计时控制">
            <button class="btn primary" id="startPauseBtn">开始</button>
            <button class="btn" id="resetBtn">重置</button>
            <button class="btn warn" id="skipBtn">跳过</button>
          </div>
        </div>
      </div>

      <div class="right">
        <div style="width:100%">
          <div style="display:flex; gap:10px; align-items:center; justify-content:space-between;">
            <div class="muted">进度</div>
            <div class="muted">自动播放 
              <label style="margin-left:6px;">
                <input type="checkbox" id="autoPlay"> 
              </label>
            </div>
          </div>
          <div class="progress" aria-hidden="true" style="margin-top:8px;">
            <div class="blocks" id="progressBlocks"></div>
          </div>
        </div>

        <div class="stats">
          <div>
            <div class="muted">当前阶段完成计数</div>
            <div style="font-family:'Press Start 2P', monospace; font-size:18px;" id="cycleCount">0</div>
          </div>
          <div>
            <div class="muted">总共已完成</div>
            <div style="font-family:'Press Start 2P', monospace; font-size:18px;" id="totalCount">0</div>
          </div>
        </div>

        <div style="width:100%">
          <div class="muted" style="font-size:12px;margin-bottom:6px">快捷键：空格（开始/暂停），R（重置），S（跳过）</div>

          <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
            <button class="btn" id="themeLight">浅</button>
            <button class="btn" id="themeDark">暗</button>
            <button class="btn" id="themePeach">糖果</button>
          </div>

          <div class="setting-row">
            <label>工作（分钟）</label>
            <input type="number" id="workInput" min="1" max="180">
          </div>
          <div class="setting-row">
            <label>短休（分钟）</label>
            <input type="number" id="shortInput" min="1" max="60">
          </div>
          <div class="setting-row">
            <label>长休（分钟）</label>
            <input type="number" id="longInput" min="1" max="120">
          </div>
          <div class="setting-row">
            <label>长休每隔（次工作）</label>
            <input type="number" id="longAfter" min="1" max="10">
          </div>
          <div class="setting-row">
            <label>音量</label>
            <input type="range" id="volumeInput" min="0" max="100" value="60">
          </div>
          <div class="setting-row">
            <label>启用音效</label>
            <input type="checkbox" id="soundToggle" checked>
          </div>

          <div style="display:flex; gap:8px; margin-top:8px;">
            <button class="btn" id="resetStatsBtn">重置今日统计</button>
            <button class="btn" id="exportBtn">导出设置</button>
            <button class="btn" id="importBtn">导入设置</button>
          </div>
        </div>
      </div>
    </section>

    <section class="side-card" aria-label="设置与说明">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <div class="muted">当前主题</div>
          <div id="currentTheme" style="font-family:'Press Start 2P', monospace; margin-top:6px;">默认</div>
        </div>
        <div>
          <div class="muted">今日完成</div>
          <div style="font-family:'Press Start 2P', monospace; font-size:18px;" id="todayCount">0</div>
        </div>
      </div>

      <div style="margin-top:8px;">
        <div class="muted">说明</div>
        <div style="margin-top:6px; font-size:13px; color:var(--muted); line-height:1.45;">
          一个像素风番茄钟：可调节时长、音量与自动播放。按空格开始/暂停，R 重置当前时段，S 跳过。完成一个工作时段会计入今天的番茄数。
        </div>
      </div>
    </section>

    <footer class="help">
      <div>提示：把页面加入主屏幕，随时开启你的生产力模式 ✨</div>
      <div class="muted">按键：空格（开始/暂停） · R（重置） · S（跳过）</div>
    </footer>
  </div>

<script>
(function(){
  // --- Helpers ---
  const qs = (s, el=document) => el.querySelector(s);
  const qsa = (s, el=document) => Array.from(el.querySelectorAll(s));
  const formatTime = (sec) => {
    const mm = String(Math.floor(sec/60)).padStart(2,'0');
    const ss = String(sec%60).padStart(2,'0');
    return mm+':'+ss;
  };
  const todayKey = () => {
    const d = new Date();
    return d.toISOString().slice(0,10);
  };

  // --- Default settings and storage ---
  const STORAGE_KEYS = {
    SETTINGS: 'pomodoro.settings.v1',
    STATS: 'pomodoro.stats.v1'
  };
  const defaultSettings = {
    workMin: 25,
    shortMin: 5,
    longMin: 15,
    longAfter: 4,
    volume: 60,
    soundOn: true,
    autoPlay: false,
    theme: 'default',
    blocks: 30
  };
  function loadSettings(){
    try{
      const raw = localStorage.getItem(STORAGE_KEYS.SETTINGS);
      if(raw) {
        return Object.assign({}, defaultSettings, JSON.parse(raw));
      }
    }catch(e){}
    return Object.assign({}, defaultSettings);
  }
  function saveSettings(s){
    localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(s));
  }
  function loadStats(){
    try{
      const raw = localStorage.getItem(STORAGE_KEYS.STATS);
      if(raw) return JSON.parse(raw);
    }catch(e){}
    return {};
  }
  function saveStats(stats){
    localStorage.setItem(STORAGE_KEYS.STATS, JSON.stringify(stats));
  }

  // --- DOM refs ---
  const startPauseBtn = qs('#startPauseBtn');
  const resetBtn = qs('#resetBtn');
  const skipBtn = qs('#skipBtn');
  const timeDisplay = qs('#timeDisplay');
  const phaseDisplay = qs('#phaseDisplay');
  const progressBlocks = qs('#progressBlocks');
  const workInput = qs('#workInput');
  const shortInput = qs('#shortInput');
  const longInput = qs('#longInput');
  const longAfterInput = qs('#longAfter');
  const volumeInput = qs('#volumeInput');
  const soundToggle = qs('#soundToggle');
  const autoPlayChk = qs('#autoPlay');
  const themeLight = qs('#themeLight');
  const themeDark = qs('#themeDark');
  const themePeach = qs('#themePeach');
  const currentTheme = qs('#currentTheme');
  const todayBadge = qs('#todayBadge');
  const todayCountEl = qs('#todayCount');
  const cycleCountEl = qs('#cycleCount');
  const totalCountEl = qs('#totalCount');
  const resetStatsBtn = qs('#resetStatsBtn');
  const exportBtn = qs('#exportBtn');
  const importBtn = qs('#importBtn');

  // --- State ---
  let settings = loadSettings();
  let stats = loadStats();

  let state = {
    phase: 'work', // work, short, long
    running: false,
    remainingSec: settings.workMin * 60,
    intervalId: null,
    cyclesCompleted: 0, // number of finished work sessions (today or since load)
  };

  // WebAudio setup
  let audioCtx = null;
  function ensureAudio(){
    if(!audioCtx){
      try{
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }catch(e){
        audioCtx = null;
      }
    }
  }
  function playBeep(type='end'){
    if(!settings.soundOn) return;
    ensureAudio();
    if(!audioCtx) return;
    const t = audioCtx.currentTime;
    const vol = Math.max(0, Math.min(1, settings.volume/100));
    const gain = audioCtx.createGain();
    gain.gain.value = vol;
    gain.connect(audioCtx.destination);

    const osc = audioCtx.createOscillator();
    osc.type = (type==='start') ? 'sawtooth' : 'square';
    const base = (type==='start') ? 880 : 440;
    osc.frequency.setValueAtTime(base, t);

    // simple envelope
    gain.gain.setValueAtTime(0.0001, t);
    gain.gain.exponentialRampToValueAtTime(vol*1.0, t+0.01);
    if(type==='end'){
      gain.gain.exponentialRampToValueAtTime(0.0001, t+0.5);
      osc.frequency.exponentialRampToValueAtTime(base/2, t+0.5);
      osc.start(t);
      osc.stop(t+0.52);
    } else if(type==='start'){
      gain.gain.exponentialRampToValueAtTime(0.0001, t+0.25);
      osc.frequency.exponentialRampToValueAtTime(base*1.5, t+0.25);
      osc.start(t);
      osc.stop(t+0.3);
    } else {
      // short click
      gain.gain.exponentialRampToValueAtTime(0.0001, t+0.12);
      osc.start(t);
      osc.stop(t+0.14);
    }
  }

  // --- UI helpers ---
  function renderBlocks(){
    const blocks = settings.blocks || 30;
    progressBlocks.innerHTML = '';
    for(let i=0;i<blocks;i++){
      const b = document.createElement('div');
      b.className = 'block';
      progressBlocks.appendChild(b);
    }
  }
  function updateProgress(){
    const blocks = qsa('.block', progressBlocks);
    const total = state.totalSecCurrent();
    const done = total - state.remainingSec;
    const ratio = Math.max(0, Math.min(1, done/total || 0));
    const active = Math.round(ratio * blocks.length);
    blocks.forEach((b,i)=>{
      b.classList.toggle('active', i < active);
    });
  }
  function updateDisplays(){
    timeDisplay.textContent = formatTime(state.remainingSec);
    const phaseName = state.phase === 'work' ? '工作' : (state.phase==='short' ? '短休' : '长休');
    phaseDisplay.textContent = phaseName;
    // top badge and counters
    todayBadge.textContent = `今日：${getTodayCount()}`;
    todayCountEl.textContent = getTodayCount();
    cycleCountEl.textContent = String(state.cyclesCompleted);
    totalCountEl.textContent = String(getTotalCount());
    // document.title change when running
    if(state.running){
      document.title = `${formatTime(state.remainingSec)} — 番茄钟`;
    } else {
      document.title = '番茄钟';
    }
    updateProgress();
  }

  // --- Timer logic helpers ---
  function setPhase(phase){
    state.phase = phase;
    if(phase === 'work') state.remainingSec = settings.workMin * 60;
    else if(phase === 'short') state.remainingSec = settings.shortMin * 60;
    else state.remainingSec = settings.longMin * 60;
    updateDisplays();
  }
  state.totalSecCurrent = function(){
    if(this.phase === 'work') return settings.workMin * 60;
    if(this.phase === 'short') return settings.shortMin * 60;
    return settings.longMin * 60;
  };

  function tick(){
    if(!state.running) return;
    if(state.remainingSec > 0){
      state.remainingSec--;
      // every minute reminder optional: here we'll give a soft tick when less than 10s
      if(state.remainingSec <= 5 && settings.soundOn){
        // final beep countdown
        playBeep('tick');
      }
      updateDisplays();
    } else {
      // stage finished
      handleStageEnd();
    }
  }

  function handleStageEnd(){
    // play end sound
    if(settings.soundOn) playBeep('end');
    if(state.phase === 'work'){
      // completed a work session
      incrementTodayCount();
      state.cyclesCompleted++;
    }
    // decide next phase
    if(state.phase === 'work'){
      // decide whether long or short
      if(state.cyclesCompleted > 0 && (state.cyclesCompleted % settings.longAfter === 0)){
        setPhase('long');
      } else {
        setPhase('short');
      }
    } else {
      // after any rest -> work
      setPhase('work');
    }
    // if autoPlay disabled, pause after switch
    if(!settings.autoPlay){
      pauseTimer();
    } else {
      // continue running
      // slight start beep
      if(settings.soundOn) playBeep('start');
    }
  }

  function startTimer(){
    if(state.running) return;
    state.running = true;
    if(!state.intervalId){
      state.intervalId = setInterval(tick, 1000);
    }
    startPauseBtn.textContent = '暂停';
    startPauseBtn.classList.remove('primary');
    startPauseBtn.classList.add('btn');
    // audio context resume for browsers that freeze it
    if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
    updateDisplays();
    if(settings.soundOn) playBeep('start');
  }
  function pauseTimer(){
    state.running = false;
    if(state.intervalId){
      clearInterval(state.intervalId);
      state.intervalId = null;
    }
    startPauseBtn.textContent = '开始';
    startPauseBtn.classList.add('primary');
    updateDisplays();
  }
  function toggleTimer(){
    if(state.running) pauseTimer();
    else startTimer();
  }
  function resetTimer(){
    if(state.phase === 'work') state.remainingSec = settings.workMin * 60;
    else if(state.phase === 'short') state.remainingSec = settings.shortMin * 60;
    else state.remainingSec = settings.longMin * 60;
    updateDisplays();
  }
  function skipTimer(){
    // end current stage immediately
    state.remainingSec = 0;
    updateDisplays();
    // call handler immediately
    handleStageEnd();
  }

  // --- Stats management ---
  function getTodayCount(){
    const key = todayKey();
    return Number(stats[key] || 0);
  }
  function incrementTodayCount(){
    const key = todayKey();
    stats[key] = Number(stats[key] || 0) + 1;
    saveStats(stats);
    updateDisplays();
  }
  function resetToday(){
    const key = todayKey();
    stats[key] = 0;
    saveStats(stats);
    updateDisplays();
  }
  function getTotalCount(){
    return Object.values(stats).reduce((a,b)=>a+Number(b||0),0);
  }

  // --- Event wiring ---
  startPauseBtn.addEventListener('click', (e)=>{
    e.preventDefault();
    toggleTimer();
  });
  resetBtn.addEventListener('click', (e)=>{
    e.preventDefault();
    resetTimer();
    if(state.running){
      // keep running
    } else {
      pauseTimer();
    }
  });
  skipBtn.addEventListener('click', (e)=>{
    e.preventDefault();
    skipTimer();
  });

  // settings inputs
  function applySettingsToUI(){
    workInput.value = settings.workMin;
    shortInput.value = settings.shortMin;
    longInput.value = settings.longMin;
    longAfterInput.value = settings.longAfter;
    volumeInput.value = settings.volume;
    soundToggle.checked = !!settings.soundOn;
    autoPlayChk.checked = !!settings.autoPlay;
    document.body.setAttribute('data-theme', settings.theme==='default' ? 'default' : settings.theme);
    currentTheme.textContent = settings.theme === 'default' ? '默认' : (settings.theme==='dark' ? '暗' : '糖果');
    renderBlocks();
  }

  function bindSettings(){
    workInput.addEventListener('change', ()=>{
      const v = Math.max(1, Math.min(180, Number(workInput.value||defaultSettings.workMin)));
      settings.workMin = v;
      saveSettings(settings);
      if(state.phase === 'work') resetTimer();
      updateDisplays();
    });
    shortInput.addEventListener('change', ()=>{
      settings.shortMin = Math.max(1, Math.min(60, Number(shortInput.value||defaultSettings.shortMin)));
      saveSettings(settings);
      if(state.phase === 'short') resetTimer();
      updateDisplays();
    });
    longInput.addEventListener('change', ()=>{
      settings.longMin = Math.max(1, Math.min(120, Number(longInput.value||defaultSettings.longMin)));
      saveSettings(settings);
      if(state.phase === 'long') resetTimer();
      updateDisplays();
    });
    longAfterInput.addEventListener('change', ()=>{
      settings.longAfter = Math.max(1, Math.min(10, Number(longAfterInput.value||defaultSettings.longAfter)));
      saveSettings(settings);
    });
    volumeInput.addEventListener('input', ()=>{
      settings.volume = Number(volumeInput.value);
      saveSettings(settings);
    });
    soundToggle.addEventListener('change', ()=>{
      settings.soundOn = !!soundToggle.checked;
      saveSettings(settings);
    });
    autoPlayChk.addEventListener('change', ()=>{
      settings.autoPlay = !!autoPlayChk.checked;
      saveSettings(settings);
    });
    themeLight.addEventListener('click', ()=>{ settings.theme='default'; applyTheme(); saveSettings(settings); });
    themeDark.addEventListener('click', ()=>{ settings.theme='dark'; applyTheme(); saveSettings(settings); });
    themePeach.addEventListener('click', ()=>{ settings.theme='peach'; applyTheme(); saveSettings(settings); });

    resetStatsBtn.addEventListener('click', ()=>{
      if(confirm('确认重置今日统计？')){ resetToday(); }
    });

    exportBtn.addEventListener('click', ()=>{
      const data = { settings, stats };
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'pomodoro-backup.json';
      a.click();
      URL.revokeObjectURL(url);
    });
    importBtn.addEventListener('click', ()=>{
      const inp = document.createElement('input');
      inp.type = 'file';
      inp.accept = 'application/json';
      inp.onchange = (ev)=>{
        const f = ev.target.files[0];
        if(!f) return;
        const reader = new FileReader();
        reader.onload = (e)=>{
          try{
            const obj = JSON.parse(e.target.result);
            if(obj.settings) settings = Object.assign({}, defaultSettings, obj.settings);
            if(obj.stats) stats = obj.stats;
            saveSettings(settings);
            saveStats(stats);
            applySettingsToUI();
            updateDisplays();
            alert('导入成功');
          }catch(err){
            alert('导入失败：文件格式不对');
          }
        };
        reader.readAsText(f);
      };
      inp.click();
    });
  }

  function applyTheme(){
    document.body.setAttribute('data-theme', settings.theme === 'default' ? 'default' : settings.theme);
    currentTheme.textContent = settings.theme === 'default' ? '默认' : (settings.theme==='dark' ? '暗' : '糖果');
  }

  // keyboard shortcuts
  window.addEventListener('keydown', (e)=>{
    const key = e.key.toLowerCase();
    if(key === ' '){
      e.preventDefault();
      toggleTimer();
    } else if(key === 'r'){
      e.preventDefault();
      resetTimer();
    } else if(key === 's'){
      e.preventDefault();
      skipTimer();
    }
  });

  // save settings on unload
  window.addEventListener('beforeunload', ()=> saveSettings(settings) );

  // init
  function init(){
    settings = loadSettings();
    stats = loadStats();
    applySettingsToUI();
    bindSettings();
    // initial phase/time
    setPhase('work');
    // small initial update
    updateDisplays();
    // render blocks and set their count
    renderBlocks();
    updateDisplays();
    // resume audio context on user gesture
    document.addEventListener('click', ()=> ensureAudio(), { once:true });

    // expose for debug (optional)
    window._pom = { state, settings, stats, saveSettings, saveStats };
  }

  init();
})();
</script>
</body>
</html>