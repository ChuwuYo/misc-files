<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>番茄钟</title>
  <style>
    :root{
      --bg:#e9fff5;
      --fg:#1a2b2b;
      --mint:#72d6b0;
      --mint-dark:#49b38f;
      --pink:#ff8fb3;
      --blue:#8fd3ff;
      --pixel-border:#0a0f0f;
      --card:#f7fffb;
      --shadow:#c7efe0;
      --danger:#ff5d6c;
      --warn:#ffa74a;
      --ok:#6ad56a;
      --grid:#d8f6ea;
    }
    [data-theme="sakura"]{
      --bg:#fff3f7; --card:#fff7fa; --shadow:#ffd7e5;
      --mint:#ff9ec1; --mint-dark:#ff6ea0; --grid:#ffe3ef; --fg:#2a2024;
    }
    [data-theme="sky"]{
      --bg:#edf8ff; --card:#f6fbff; --shadow:#cfe9ff;
      --mint:#7cc9ff; --mint-dark:#49aef0; --grid:#d9f0ff; --fg:#112533;
    }

    html,body{height:100%; background:var(--bg); color:var(--fg); font-family: "Trebuchet MS", "Pixelated", monospace; margin:0;}
    .grid-bg{
      position: fixed; inset:0; pointer-events:none;
      background-image:
        linear-gradient(var(--grid) 1px, transparent 1px),
        linear-gradient(90deg, var(--grid) 1px, transparent 1px);
      background-size: 24px 24px, 24px 24px;
      opacity:.7;
    }
    .container{
      position:relative; max-width:1000px; margin:0 auto; padding:24px;
    }
    .card{
      background:var(--card);
      border:4px solid var(--pixel-border);
      box-shadow: 6px 6px 0 var(--shadow);
      border-radius: 8px;
      padding:16px;
    }
    h1{
      margin:8px 0 16px; text-align:center;
      font-weight:800; letter-spacing:2px;
      text-shadow: 2px 2px 0 var(--shadow);
    }
    .layout{
      display:grid; grid-template-columns: 1fr 320px; gap:16px;
    }
    @media (max-width: 900px){
      .layout{ grid-template-columns: 1fr; }
    }

    /* Timer circle */
    .timer-wrap{
      display:flex; align-items:center; justify-content:center;
      padding:16px;
    }
    .timer-circle{
      position:relative; width:280px; height:280px;
      image-rendering: pixelated;
      background:
        radial-gradient(circle at 50% 50%, #ffffff 0%, #ffffff 40%, transparent 41%),
        conic-gradient(var(--mint) var(--progress, 0%), #e0e0e0 var(--progress, 0%));
      border:6px solid var(--pixel-border);
      box-shadow: 6px 6px 0 var(--shadow);
      border-radius:50%;
    }
    .timer-center{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      font-size:48px; font-weight:900; letter-spacing:2px;
    }
    .phase{
      text-align:center; font-weight:700; margin-top:8px;
    }
    .progressbar{
      height:14px; border:4px solid var(--pixel-border);
      background:#e0f5ef; margin-top:12px; box-shadow: 4px 4px 0 var(--shadow);
      position:relative;
    }
    .progressbar > .fill{
      position:absolute; left:0; top:0; bottom:0; width:0%;
      background: repeating-linear-gradient(
        45deg, var(--mint), var(--mint) 10px, var(--mint-dark) 10px, var(--mint-dark) 20px
      );
      transition: width .2s ease;
    }

    /* Controls */
    .controls{
      display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-top:12px;
    }
    .btn{
      padding:10px 14px; border:4px solid var(--pixel-border);
      background:var(--mint); color:#fff; font-weight:800;
      cursor:pointer; box-shadow:4px 4px 0 var(--shadow);
      transform: translate(0,0);
      transition: transform .05s ease, filter .1s ease;
      user-select:none;
    }
    .btn:hover{ filter: brightness(1.05); }
    .btn:active{ transform: translate(2px,2px); box-shadow:2px 2px 0 var(--shadow); }
    .btn.secondary{ background:var(--blue); }
    .btn.danger{ background:var(--danger); }
    .btn.warn{ background:var(--warn); }
    .btn.ok{ background:var(--ok); }
    .btn.mute{ background:#444; }

    /* Settings */
    .side{
      display:flex; flex-direction:column; gap:12px;
    }
    .group .title{
      font-weight:800; margin-bottom:6px; display:flex; align-items:center; gap:8px;
    }
    .group{
      border:4px solid var(--pixel-border); padding:12px; background:#fff;
      box-shadow:4px 4px 0 var(--shadow);
    }
    .row{ display:flex; align-items:center; gap:8px; margin:6px 0; }
    .row label{ width:120px; font-weight:700; }
    .row input[type="number"], .row select, .row input[type="text"]{
      border:4px solid var(--pixel-border); padding:8px; width:120px;
      background:#f5f9f8; font-weight:800;
    }
    .row input[type="checkbox"]{ transform: scale(1.3); }
    .volume{
      display:flex; align-items:center; gap:8px;
    }
    .volume input[type="range"]{ width:160px; }

    /* Tasks & stats */
    .stats{
      display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:8px;
    }
    .stat{
      background:#f9fffd; border:4px solid var(--pixel-border);
      padding:8px; font-weight:800; text-align:center;
      box-shadow: 4px 4px 0 var(--shadow);
    }
    .history{ margin-top:8px; }
    .history-item{
      display:flex; justify-content:space-between; gap:8px;
      border-bottom:2px dashed var(--grid); padding:6px 0; font-size:14px;
    }
    .small{ font-size:12px; opacity:.8; }

    .hidden{ display:none; }

    /* subtle animations */
    @keyframes flash {
      0%,100% { filter:brightness(1); }
      50% { filter:brightness(1.15); }
    }
    .flash{ animation: flash .8s ease 2; }

  </style>
</head>
<body>
  <div id="grid" class="grid-bg"></div>
  <div class="container" id="app" data-theme="mint">
    <h1>番茄钟</h1>
    <div class="layout">
      <div class="card">
        <div class="timer-wrap">
          <div class="timer-circle" id="timerCircle">
            <div class="timer-center" id="timeText">25:00</div>
          </div>
        </div>
        <div class="phase" id="phaseText">专注</div>
        <div class="progressbar"><div class="fill" id="progressFill"></div></div>

        <div class="controls">
          <button class="btn ok" id="btnStartPause">开始</button>
          <button class="btn warn" id="btnReset">重置</button>
          <button class="btn secondary" id="btnPrev">上一个</button>
          <button class="btn secondary" id="btnNext">跳过</button>
          <button class="btn mute" id="btnMute">静音</button>
        </div>

        <div class="group" style="margin-top:12px;">
          <div class="title">任务</div>
          <div class="row">
            <label for="taskName">当前任务</label>
            <input type="text" id="taskName" placeholder="输入任务名称"/>
          </div>
          <div class="stats">
            <div class="stat">
              今日专注累计<br><span id="todayMinutes">0</span> 分钟
            </div>
            <div class="stat">
              当前任务完成番茄<br><span id="taskTomatoes">0</span> 次
            </div>
          </div>
          <div class="history" id="historyList"></div>
          <div style="text-align:center; margin-top:8px;">
            <button class="btn danger" id="btnClearStats">清空今日统计</button>
          </div>
        </div>
      </div>

      <div class="side">
        <div class="group">
          <div class="title">设置</div>
          <div class="row">
            <label for="focusMin">专注(分)</label>
            <input type="number" id="focusMin" min="1" max="180" value="25"/>
          </div>
          <div class="row">
            <label for="shortMin">短休(分)</label>
            <input type="number" id="shortMin" min="1" max="60" value="5"/>
          </div>
          <div class="row">
            <label for="longMin">长休(分)</label>
            <input type="number" id="longMin" min="5" max="180" value="15"/>
          </div>
          <div class="row">
            <label for="longGap">长休间隔</label>
            <input type="number" id="longGap" min="1" max="12" value="4"/>
          </div>
          <div class="row">
            <label for="autoStart">自动开始</label>
            <input type="checkbox" id="autoStart"/>
          </div>
        </div>

        <div class="group">
          <div class="title">提示与主题</div>
          <div class="row">
            <label for="soundType">提示音</label>
            <select id="soundType">
              <option value="chime">chime</option>
              <option value="pop">pop</option>
              <option value="bell">bell</option>
            </select>
          </div>
          <div class="row volume">
            <label for="volume">音量</label>
            <input type="range" id="volume" min="0" max="1" step="0.01" value="0.7"/>
            <span id="volText">70%</span>
          </div>
          <div class="row">
            <label for="theme">主题</label>
            <select id="theme">
              <option value="mint">薄荷绿</option>
              <option value="sakura">樱花粉</option>
              <option value="sky">天空蓝</option>
            </select>
          </div>
          <div class="row">
            <label for="gridToggle">网格背景</label>
            <input type="checkbox" id="gridToggle" checked/>
          </div>
        </div>

        <div class="group">
          <div class="title">说明</div>
          <div class="small">
            键盘快捷键：Space 开始/暂停，R 重置，N 下一阶段，P 上一阶段，M 静音。
            设置会自动保存。每完成一次专注会增加“当前任务番茄”与“今日累计分钟数”。
          </div>
        </div>
      </div>
    </div>
  </div>

  <audio id="audioChime"></audio>
  <audio id="audioPop"></audio>
  <audio id="audioBell"></audio>

  <script>
    // ===== Utility & State =====
    const el = id => document.getElementById(id);
    const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
    const now = () => Date.now();

    const defaultSettings = {
      focusMin: 25,
      shortMin: 5,
      longMin: 15,
      longGap: 4,
      autoStart: false,
      soundType: 'chime',
      volume: 0.7,
      mute: false,
      theme: 'mint',
      grid: true,
      taskName: ''
    };

    let settings = loadSettings();
    let phase = 'focus';           // 'focus' | 'shortBreak' | 'longBreak'
    let running = false;
    let startTs = null;            // timestamp when started
    let endTs = null;              // target end timestamp
    let remainMs = settings.focusMin * 60 * 1000; // remaining milliseconds
    let focusCount = 0;            // completed focus in current cycle
    let lastNavTs = 0;             // for debounce navigation
    const NAV_DEBOUNCE = 500;

    const todayKey = getTodayKey();
    let stats = loadStats(todayKey); // {minutes: number, history: Array}

    // ===== Initialize UI =====
    function applyTheme(){
      document.getElementById('app').setAttribute('data-theme', settings.theme);
    }
    function applyGrid(){
      el('grid').style.display = settings.grid ? 'block' : 'none';
    }
    function applyInputs(){
      el('focusMin').value = settings.focusMin;
      el('shortMin').value = settings.shortMin;
      el('longMin').value = settings.longMin;
      el('longGap').value = settings.longGap;
      el('autoStart').checked = settings.autoStart;
      el('soundType').value = settings.soundType;
      el('volume').value = settings.volume;
      el('volText').textContent = Math.round(settings.volume*100) + '%';
      el('theme').value = settings.theme;
      el('gridToggle').checked = settings.grid;
      el('taskName').value = settings.taskName || '';
    }
    function updatePhaseText(){
      const map = {focus:'专注', shortBreak:'短休', longBreak:'长休'};
      el('phaseText').textContent = map[phase];
    }
    function msForPhase(ph){
      if(ph === 'focus') return clamp(Number(el('focusMin').value)||settings.focusMin,1,180) * 60 * 1000;
      if(ph === 'shortBreak') return clamp(Number(el('shortMin').value)||settings.shortMin,1,60) * 60 * 1000;
      if(ph === 'longBreak') return clamp(Number(el('longMin').value)||settings.longMin,5,180) * 60 * 1000;
    }
    function setRemainForPhase(ph){
      remainMs = msForPhase(ph);
      updateTimerUI(remainMs, msForPhase(ph));
    }

    function formatTime(ms){
      const t = Math.max(0, Math.round(ms/1000));
      const m = Math.floor(t/60);
      const s = t%60;
      return String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
    }

    function updateTimerUI(ms, total){
      el('timeText').textContent = formatTime(ms);
      const progress = 100 * (1 - ms/total);
      el('progressFill').style.width = progress + '%';
      const circle = el('timerCircle');
      circle.style.setProperty('--progress', progress + '%');
      document.title = (running ? '▶ ' : '❚❚ ') + '番茄钟';
    }

    function saveSettings(){
      localStorage.setItem('pomodoro_settings', JSON.stringify(settings));
    }
    function loadSettings(){
      try{
        const s = JSON.parse(localStorage.getItem('pomodoro_settings')) || {};
        const merged = {...defaultSettings, ...s};
        // sanity
        merged.focusMin = clamp(Number(merged.focusMin)||defaultSettings.focusMin,1,180);
        merged.shortMin = clamp(Number(merged.shortMin)||defaultSettings.shortMin,1,60);
        merged.longMin = clamp(Number(merged.longMin)||defaultSettings.longMin,5,180);
        merged.longGap = clamp(Number(merged.longGap)||defaultSettings.longGap,1,12);
        merged.volume = clamp(Number(merged.volume)||defaultSettings.volume,0,1);
        merged.autoStart = !!merged.autoStart;
        merged.mute = !!merged.mute;
        merged.grid = merged.grid !== false;
        merged.theme = ['mint','sakura','sky'].includes(merged.theme) ? merged.theme : 'mint';
        merged.soundType = ['chime','pop','bell'].includes(merged.soundType) ? merged.soundType : 'chime';
        return merged;
      }catch(e){
        return {...defaultSettings};
      }
    }

    function getTodayKey(){
      const d = new Date();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }
    function loadStats(key){
      try{
        const map = JSON.parse(localStorage.getItem('pomodoro_stats')) || {};
        return map[key] || {minutes:0, history:[]};
      }catch(e){
        return {minutes:0, history:[]};
      }
    }
    function saveStats(key){
      const map = JSON.parse(localStorage.getItem('pomodoro_stats')) || {};
      map[key] = stats;
      localStorage.setItem('pomodoro_stats', JSON.stringify(map));
    }
    function pushHistory(item){
      stats.history.unshift(item);
      stats.history = stats.history.slice(0,5);
      renderHistory();
      saveStats(todayKey);
    }
    function renderHistory(){
      const list = el('historyList');
      list.innerHTML = '';
      if(stats.history.length === 0){
        list.innerHTML = '<div class="small">暂无记录</div>';
        return;
      }
      stats.history.forEach(h=>{
        const div = document.createElement('div');
        div.className = 'history-item';
        div.innerHTML = `
          <span>[${h.type}] ${h.task||'无任务'}</span>
          <span class="small">${h.start} → ${h.end}</span>
        `;
        list.appendChild(div);
      });
      el('todayMinutes').textContent = stats.minutes;
    }

    // ===== Audio: lightweight tones via WebAudio =====
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    let audioCtx = null;

    function playTone(kind){
      if(settings.mute) return;
      if(!audioCtx) audioCtx = new AudioCtx();
      const ctx = audioCtx;
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      g.gain.value = settings.volume;
      o.connect(g).connect(ctx.destination);
      const nowt = ctx.currentTime;
      // different flavors
      if(kind==='chime'){
        o.type = 'sine'; o.frequency.setValueAtTime(880, nowt);
        g.gain.exponentialRampToValueAtTime(Math.max(0.0001, settings.volume/20), nowt+0.6);
        o.start();
        o.stop(nowt+0.6);
      }else if(kind==='pop'){
        o.type = 'triangle'; o.frequency.setValueAtTime(660, nowt);
        o.frequency.exponentialRampToValueAtTime(330, nowt+0.15);
        g.gain.exponentialRampToValueAtTime(Math.max(0.0001, settings.volume/30), nowt+0.2);
        o.start(); o.stop(nowt+0.2);
      }else{
        // bell
        const o2 = ctx.createOscillator();
        const g2 = ctx.createGain();
        o.type='sine'; o.frequency.setValueAtTime(600, nowt);
        o2.type='sine'; o2.frequency.setValueAtTime(1200, nowt);
        g.gain.value = settings.volume * 0.8;
        g2.gain.value = settings.volume * 0.4;
        o.connect(g).connect(ctx.destination);
        o2.connect(g2).connect(ctx.destination);
        g.gain.exponentialRampToValueAtTime(0.0001, nowt+0.6);
        g2.gain.exponentialRampToValueAtTime(0.0001, nowt+0.6);
        o.start(); o2.start();
        o.stop(nowt+0.6); o2.stop(nowt+0.6);
      }
    }
    function playPhaseEnd(){
      playTone(settings.soundType);
    }
    function playPhaseStart(){
      // subtle, shorter
      if(settings.mute) return;
      if(!audioCtx) audioCtx = new AudioCtx();
      const ctx = audioCtx;
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      g.gain.value = settings.volume * 0.5;
      o.type = 'square';
      o.frequency.setValueAtTime(500, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.12);
      o.connect(g).connect(ctx.destination);
      o.start(); o.stop(ctx.currentTime+0.12);
    }

    // ===== Timer engine (timestamp-based) =====
    function startTimer(){
      if(running) return;
      running = true;
      startTs = now();
      endTs = startTs + remainMs;
      el('btnStartPause').textContent = '暂停';
      tick(); // immediate render
    }
    function pauseTimer(){
      if(!running) return;
      running = false;
      remainMs = Math.max(0, endTs - now());
      el('btnStartPause').textContent = '开始';
      updateTimerUI(remainMs, msForPhase(phase));
    }
    function resetTimer(){
      running = false;
      setRemainForPhase(phase);
      el('btnStartPause').textContent = '开始';
    }
    function nextPhase(){
      const t = now();
      if(t - lastNavTs < NAV_DEBOUNCE) return;
      lastNavTs = t;
      // compute next
      if(phase === 'focus'){
        focusCount++;
        // stats update: record completed focus only if we were at end or user clicked skip after running?
        // We treat skip from focus as completed if remaining < 1000ms or timer had started.
        pushFocusStatsIfMeaningful();
        if(focusCount >= settings.longGap){
          phase = 'longBreak';
          focusCount = 0;
        }else{
          phase = 'shortBreak';
        }
      }else{
        phase = 'focus';
      }
      setRemainForPhase(phase);
      updatePhaseText();
      el('timerCircle').classList.add('flash');
      setTimeout(()=>el('timerCircle').classList.remove('flash'), 900);
      playPhaseStart();
      if(settings.autoStart) startTimer(); else pauseTimer();
    }
    function prevPhase(){
      const t = now();
      if(t - lastNavTs < NAV_DEBOUNCE) return;
      lastNavTs = t;
      // go back
      if(phase === 'focus'){
        // if at focus, previous is break. Determine long or short based on last counts
        phase = (focusCount === 0 ? 'longBreak' : 'shortBreak');
        if(phase === 'shortBreak' && focusCount>0) focusCount--; // stepping back a focus count if applicable
      }else{
        // from break back to focus
        // if coming from longBreak, set gap back
        if(phase==='longBreak') focusCount = settings.longGap - 1;
        phase = 'focus';
      }
      setRemainForPhase(phase);
      updatePhaseText();
      if(settings.autoStart) startTimer(); else pauseTimer();
    }

    function pushFocusStatsIfMeaningful(){
      // If we were running focus and at least 1 minute elapsed, credit stats.
      if(currentWasFocusAndMeaningful()){
        const spentMin = Math.round((msForPhase('focus') - Math.max(0, endTs - now())) / 60000);
        const addMin = Math.max(1, spentMin);
        stats.minutes += addMin;
        el('todayMinutes').textContent = stats.minutes;
        pushHistory({
          type: '专注',
          task: settings.taskName || el('taskName').value || '',
          start: new Date(startTs).toLocaleTimeString(),
          end: new Date().toLocaleTimeString()
        });
        // task tomato increment
        const current = Number(el('taskTomatoes').textContent)||0;
        el('taskTomatoes').textContent = String(current+1);
        saveStats(todayKey);
      }
    }
    function currentWasFocusAndMeaningful(){
      if(phase !== 'focus') return false;
      // meaningful if started and elapsed >= 60s or finished
      if(!startTs) return false;
      const elapsed = Math.max(0, now() - startTs);
      return elapsed >= 60000 || (endTs - now() <= 500);
    }

    function tick(){
      if(!running) return;
      const total = msForPhase(phase);
      const left = Math.max(0, endTs - now());
      updateTimerUI(left, total);
      if(left <= 0){
        running = false;
        el('btnStartPause').textContent = '开始';
        playPhaseEnd();
        // stats only for completed focus
        if(phase === 'focus'){
          focusCount++;
          stats.minutes += Math.round(total/60000);
          el('todayMinutes').textContent = stats.minutes;
          pushHistory({
            type: '专注',
            task: settings.taskName || el('taskName').value || '',
            start: new Date(startTs).toLocaleTimeString(),
            end: new Date().toLocaleTimeString()
          });
          const current = Number(el('taskTomatoes').textContent)||0;
          el('taskTomatoes').textContent = String(current+1);
          saveStats(todayKey);
        }else{
          pushHistory({
            type: (phase==='shortBreak'?'短休':'长休'),
            task: settings.taskName || el('taskName').value || '',
            start: new Date(startTs).toLocaleTimeString(),
            end: new Date().toLocaleTimeString()
          });
        }
        // advance phase
        if(phase === 'focus'){
          if(focusCount >= settings.longGap){
            phase = 'longBreak';
            focusCount = 0;
          }else{
            phase = 'shortBreak';
          }
        }else{
          phase = 'focus';
        }
        setRemainForPhase(phase);
        updatePhaseText();
        el('timerCircle').classList.add('flash');
        setTimeout(()=>el('timerCircle').classList.remove('flash'), 900);
        if(settings.autoStart) startTimer();
        return;
      }
      // use requestAnimationFrame for smoothness, but throttle logic
      requestAnimationFrame(tick);
    }

    // ===== Event bindings =====
    // Buttons
    el('btnStartPause').addEventListener('click', ()=>{
      if(running) pauseTimer(); else startTimer();
    });
    el('btnReset').addEventListener('click', resetTimer);
    el('btnNext').addEventListener('click', nextPhase);
    el('btnPrev').addEventListener('click', prevPhase);
    el('btnMute').addEventListener('click', ()=>{
      settings.mute = !settings.mute;
      el('btnMute').textContent = settings.mute ? '取消静音' : '静音';
      saveSettings();
    });

    // Inputs
    el('focusMin').addEventListener('change', ()=>{
      settings.focusMin = clamp(Number(el('focusMin').value)||25,1,180);
      saveSettings();
      if(phase==='focus') setRemainForPhase('focus');
    });
    el('shortMin').addEventListener('change', ()=>{
      settings.shortMin = clamp(Number(el('shortMin').value)||5,1,60);
      saveSettings();
      if(phase==='shortBreak') setRemainForPhase('shortBreak');
    });
    el('longMin').addEventListener('change', ()=>{
      settings.longMin = clamp(Number(el('longMin').value)||15,5,180);
      saveSettings();
      if(phase==='longBreak') setRemainForPhase('longBreak');
    });
    el('longGap').addEventListener('change', ()=>{
      settings.longGap = clamp(Number(el('longGap').value)||4,1,12);
      saveSettings();
    });
    el('autoStart').addEventListener('change', ()=>{
      settings.autoStart = el('autoStart').checked;
      saveSettings();
    });
    el('soundType').addEventListener('change', ()=>{
      settings.soundType = el('soundType').value;
      saveSettings();
      playTone(settings.soundType);
    });
    el('volume').addEventListener('input', ()=>{
      settings.volume = clamp(Number(el('volume').value)||0.7,0,1);
      el('volText').textContent = Math.round(settings.volume*100)+'%';
      saveSettings();
    });
    el('theme').addEventListener('change', ()=>{
      settings.theme = el('theme').value;
      applyTheme(); saveSettings();
    });
    el('gridToggle').addEventListener('change', ()=>{
      settings.grid = el('gridToggle').checked;
      applyGrid(); saveSettings();
    });
    el('taskName').addEventListener('input', ()=>{
      settings.taskName = el('taskName').value;
      saveSettings();
    });

    // Keyboard shortcuts
    window.addEventListener('keydown', (e)=>{
      // avoid typing conflicts
      const isTyping = ['INPUT','TEXTAREA','SELECT'].includes(document.activeElement?.tagName);
      if(isTyping && e.code!=='Space') return;
      if(e.code==='Space'){ e.preventDefault(); if(running) pauseTimer(); else startTimer(); }
      else if(e.key==='r' || e.key==='R'){ resetTimer(); }
      else if(e.key==='n' || e.key==='N'){ nextPhase(); }
      else if(e.key==='p' || e.key==='P'){ prevPhase(); }
      else if(e.key==='m' || e.key==='M'){ el('btnMute').click(); }
    });

    // Clear stats with confirm
    el('btnClearStats').addEventListener('click', ()=>{
      const ok = confirm('确定清空今日统计与历史记录吗？');
      if(!ok) return;
      stats = {minutes:0, history:[]};
      saveStats(todayKey);
      renderHistory();
      el('taskTomatoes').textContent = '0';
    });

    // ===== Initial render =====
    (function init(){
      applyTheme();
      applyGrid();
      applyInputs();
      setRemainForPhase(phase);
      updatePhaseText();
      renderHistory();
      // mute button text
      el('btnMute').textContent = settings.mute ? '取消静音' : '静音';
    })();

  </script>
</body>
</html>