<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>番茄钟</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #6A67CE;
            --secondary-color: #FF9F68;
            --accent-color: #4ECDC4;
            --text-color: #2D3047;
            --bg-color: #F9F7F7;
            --panel-color: #FFFFFF;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --pixel-size: 4px;
        }

        .dark-theme {
            --primary-color: #8B86FF;
            --secondary-color: #FFB347;
            --accent-color: #67E6DC;
            --text-color: #E6E6E6;
            --bg-color: #1A1A2E;
            --panel-color: #16213E;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --success-color: #81C784;
            --warning-color: #FFB74D;
        }

        .green-theme {
            --primary-color: #4CAF50;
            --secondary-color: #8BC34A;
            --accent-color: #CDDC39;
            --bg-color: #F1F8E9;
            --panel-color: #FFFFFF;
        }

        .pink-theme {
            --primary-color: #E91E63;
            --secondary-color: #F48FB1;
            --accent-color: #FF80AB;
            --bg-color: #FCE4EC;
            --panel-color: #FFFFFF;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            image-rendering: pixelated;
        }

        body {
            font-family: 'Press Start 2P', cursive, monospace;
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 800px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
        }

        /* 标题样式 */
        header {
            text-align: center;
            margin-bottom: 10px;
        }

        h1 {
            font-size: 3rem;
            color: var(--primary-color);
            text-shadow: 
                var(--pixel-size) var(--pixel-size) 0 var(--shadow-color),
                calc(var(--pixel-size) * 2) calc(var(--pixel-size) * 2) 0 rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            letter-spacing: 2px;
        }

        /* 主计时器区域 */
        .timer-container {
            background-color: var(--panel-color);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 600px;
            box-shadow: 
                0 10px 30px var(--shadow-color),
                inset 0 0 0 4px var(--primary-color),
                inset 0 0 0 8px var(--accent-color);
            position: relative;
            overflow: hidden;
            border: 8px solid var(--primary-color);
        }

        .timer-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 10px;
            background: repeating-linear-gradient(
                90deg,
                var(--primary-color),
                var(--primary-color) 10px,
                var(--accent-color) 10px,
                var(--accent-color) 20px
            );
        }

        /* 阶段指示器 */
        .phase-indicator {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .phase {
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 0.9rem;
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 4px solid transparent;
            transition: all 0.3s ease;
        }

        .phase.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--accent-color);
            box-shadow: 0 0 15px rgba(106, 103, 206, 0.5);
        }

        /* 计时器显示 */
        .timer-display {
            text-align: center;
            margin-bottom: 40px;
        }

        .time {
            font-size: 5.5rem;
            color: var(--primary-color);
            text-shadow: 
                4px 4px 0 var(--shadow-color),
                8px 8px 0 rgba(0, 0, 0, 0.05);
            margin-bottom: 10px;
            letter-spacing: 5px;
        }

        .phase-label {
            font-size: 1.5rem;
            color: var(--secondary-color);
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        /* 进度条 */
        .progress-container {
            width: 100%;
            height: 30px;
            background-color: var(--bg-color);
            border-radius: 15px;
            margin-bottom: 40px;
            overflow: hidden;
            border: 4px solid var(--primary-color);
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            transition: width 1s linear;
            position: relative;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                90deg,
                transparent,
                transparent 10px,
                rgba(255, 255, 255, 0.3) 10px,
                rgba(255, 255, 255, 0.3) 20px
            );
        }

        /* 控制按钮 */
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .btn {
            padding: 18px 30px;
            font-family: 'Press Start 2P', cursive;
            font-size: 1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            border: 4px solid transparent;
            background-color: var(--panel-color);
            color: var(--text-color);
            box-shadow: 
                0 6px 0 var(--shadow-color),
                inset 0 0 0 2px var(--primary-color);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 8px 0 var(--shadow-color),
                inset 0 0 0 2px var(--primary-color);
        }

        .btn:active {
            transform: translateY(2px);
            box-shadow: 
                0 2px 0 var(--shadow-color),
                inset 0 0 0 2px var(--primary-color);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.2);
        }

        .btn-primary:hover {
            box-shadow: 0 8px 0 rgba(0, 0, 0, 0.2);
        }

        .btn-primary:active {
            box-shadow: 0 2px 0 rgba(0, 0, 0, 0.2);
        }

        /* 番茄计数 */
        .counter-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        .counter {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: var(--panel-color);
            padding: 15px 25px;
            border-radius: 10px;
            border: 4px solid var(--accent-color);
        }

        .counter-value {
            font-size: 2.5rem;
            color: var(--primary-color);
        }

        .counter-label {
            font-size: 1rem;
            color: var(--text-color);
        }

        /* 设置面板 */
        .settings-container {
            width: 100%;
            max-width: 600px;
            background-color: var(--panel-color);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px var(--shadow-color);
            border: 4px solid var(--accent-color);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 4px dashed var(--accent-color);
        }

        .settings-title {
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .settings-content {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 25px;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .setting-label {
            font-size: 0.9rem;
            color: var(--text-color);
            display: flex;
            justify-content: space-between;
        }

        .setting-value {
            color: var(--primary-color);
        }

        .slider {
            width: 100%;
            height: 25px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--bg-color);
            border-radius: 10px;
            border: 4px solid var(--primary-color);
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: 4px solid var(--accent-color);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            border: 4px solid var(--primary-color);
            border-radius: 30px;
            transition: .4s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 3px;
            background-color: var(--primary-color);
            border-radius: 50%;
            transition: .4s;
        }

        input:checked + .toggle-slider {
            background-color: var(--accent-color);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .theme-selector {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .theme-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 4px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-btn:hover {
            transform: scale(1.1);
        }

        .theme-btn.active {
            border-color: var(--text-color);
            transform: scale(1.1);
        }

        .theme-default {
            background: linear-gradient(135deg, #6A67CE, #4ECDC4, #FF9F68);
        }

        .theme-dark {
            background: linear-gradient(135deg, #1A1A2E, #16213E, #0F3460);
        }

        .theme-green {
            background: linear-gradient(135deg, #4CAF50, #8BC34A, #CDDC39);
        }

        .theme-pink {
            background: linear-gradient(135deg, #E91E63, #F48FB1, #FF80AB);
        }

        /* 快捷键提示 */
        .shortcuts {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 20px;
            font-size: 0.8rem;
            color: var(--text-color);
            opacity: 0.8;
        }

        .shortcut {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: var(--panel-color);
            padding: 8px 15px;
            border-radius: 8px;
            border: 3px solid var(--primary-color);
        }

        .key {
            background-color: var(--primary-color);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            h1 {
                font-size: 2.2rem;
            }
            
            .timer-container {
                padding: 30px 20px;
            }
            
            .time {
                font-size: 4rem;
            }
            
            .phase-label {
                font-size: 1.2rem;
            }
            
            .btn {
                padding: 15px 20px;
                font-size: 0.9rem;
            }
            
            .settings-content {
                grid-template-columns: 1fr;
            }
            
            .phase-indicator {
                gap: 10px;
            }
            
            .phase {
                padding: 8px 16px;
                font-size: 0.7rem;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.8rem;
            }
            
            .time {
                font-size: 3rem;
                letter-spacing: 3px;
            }
            
            .phase-label {
                font-size: 1rem;
            }
            
            .controls {
                gap: 10px;
            }
            
            .btn {
                padding: 12px 15px;
                font-size: 0.8rem;
            }
            
            .counter-value {
                font-size: 1.8rem;
            }
            
            .counter-label {
                font-size: 0.8rem;
            }
        }

        /* 动画 */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 0.5s ease-in-out;
        }

        @keyframes pixelate {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }

        .pixelate {
            animation: pixelate 0.2s ease;
        }

        /* 像素装饰元素 */
        .pixel-decoration {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: var(--accent-color);
            z-index: -1;
        }

        .pixel-1 {
            top: 10%;
            left: 5%;
        }

        .pixel-2 {
            top: 20%;
            right: 10%;
        }

        .pixel-3 {
            bottom: 15%;
            left: 15%;
        }

        .pixel-4 {
            bottom: 25%;
            right: 5%;
        }

        /* 像素化字体效果 */
        .pixel-font {
            font-family: 'Press Start 2P', cursive;
            letter-spacing: 1px;
            line-height: 1.5;
        }

        /* 通知 */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background-color: var(--panel-color);
            color: var(--text-color);
            border-radius: 10px;
            border: 4px solid var(--primary-color);
            box-shadow: 0 5px 15px var(--shadow-color);
            transform: translateX(150%);
            transition: transform 0.3s ease;
            z-index: 1000;
            font-size: 0.9rem;
        }

        .notification.show {
            transform: translateX(0);
        }

        /* 隐藏设置面板 */
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 标题 -->
        <header>
            <h1>番茄钟</h1>
        </header>
        
        <!-- 主计时器 -->
        <div class="timer-container">
            <div class="phase-indicator">
                <div class="phase" id="work-phase">工作</div>
                <div class="phase" id="short-break-phase">短休</div>
                <div class="phase" id="long-break-phase">长休</div>
            </div>
            
            <div class="timer-display">
                <div class="time" id="time-display">25:00</div>
                <div class="phase-label" id="current-phase-label">准备开始工作</div>
            </div>
            
            <div class="progress-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            
            <div class="controls">
                <button class="btn btn-primary" id="start-btn">
                    <i class="fas fa-play"></i> 开始
                </button>
                <button class="btn" id="pause-btn">
                    <i class="fas fa-pause"></i> 暂停
                </button>
                <button class="btn" id="reset-btn">
                    <i class="fas fa-redo"></i> 重置
                </button>
                <button class="btn" id="skip-btn">
                    <i class="fas fa-forward"></i> 跳过
                </button>
            </div>
            
            <div class="counter-container">
                <div class="counter">
                    <div class="counter-label">今日完成:</div>
                    <div class="counter-value" id="tomato-count">0</div>
                    <div class="counter-label">番茄</div>
                </div>
            </div>
        </div>
        
        <!-- 设置面板 -->
        <div class="settings-container">
            <div class="settings-header">
                <div class="settings-title">设置</div>
                <button class="btn" id="toggle-settings-btn">
                    <i class="fas fa-cog"></i> 隐藏设置
                </button>
            </div>
            
            <div class="settings-content" id="settings-content">
                <div class="setting-group">
                    <div class="setting-label">
                        <span>工作时间</span>
                        <span class="setting-value" id="work-time-value">25</span>
                    </div>
                    <input type="range" min="5" max="60" value="25" class="slider" id="work-time-slider">
                </div>
                
                <div class="setting-group">
                    <div class="setting-label">
                        <span>短休时间</span>
                        <span class="setting-value" id="short-break-value">5</span>
                    </div>
                    <input type="range" min="1" max="30" value="5" class="slider" id="short-break-slider">
                </div>
                
                <div class="setting-group">
                    <div class="setting-label">
                        <span>长休时间</span>
                        <span class="setting-value" id="long-break-value">15</span>
                    </div>
                    <input type="range" min="5" max="60" value="15" class="slider" id="long-break-slider">
                </div>
                
                <div class="setting-group">
                    <div class="setting-label">
                        <span>长休间隔</span>
                        <span class="setting-value" id="long-break-interval-value">4</span>
                    </div>
                    <input type="range" min="2" max="8" value="4" class="slider" id="long-break-interval-slider">
                </div>
                
                <div class="setting-group">
                    <div class="setting-label">
                        <span>自动开始下一个时段</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="auto-next-toggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="setting-group">
                    <div class="setting-label">
                        <span>提示音</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="sound-toggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="setting-group">
                    <div class="setting-label">
                        <span>提示音量</span>
                        <span class="setting-value" id="volume-value">70</span>
                    </div>
                    <input type="range" min="0" max="100" value="70" class="slider" id="volume-slider">
                </div>
                
                <div class="setting-group">
                    <div class="setting-label">
                        <span>主题</span>
                    </div>
                    <div class="theme-selector">
                        <div class="theme-btn theme-default active" data-theme="default"></div>
                        <div class="theme-btn theme-dark" data-theme="dark"></div>
                        <div class="theme-btn theme-green" data-theme="green"></div>
                        <div class="theme-btn theme-pink" data-theme="pink"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 快捷键提示 -->
        <div class="shortcuts">
            <div class="shortcut">
                <span class="key">空格</span>
                <span>开始/暂停</span>
            </div>
            <div class="shortcut">
                <span class="key">R</span>
                <span>重置</span>
            </div>
            <div class="shortcut">
                <span class="key">S</span>
                <span>跳过</span>
            </div>
            <div class="shortcut">
                <span class="key">C</span>
                <span>隐藏/显示设置</span>
            </div>
        </div>
        
        <!-- 像素装饰 -->
        <div class="pixel-decoration pixel-1"></div>
        <div class="pixel-decoration pixel-2"></div>
        <div class="pixel-decoration pixel-3"></div>
        <div class="pixel-decoration pixel-4"></div>
        
        <!-- 通知 -->
        <div class="notification" id="notification"></div>
    </div>
    
    <!-- 音效 -->
    <audio id="start-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-unlock-game-notification-253.mp3" type="audio/mpeg">
    </audio>
    <audio id="end-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3" type="audio/mpeg">
    </audio>
    <audio id="tick-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-retro-game-emergency-alarm-1000.mp3" type="audio/mpeg">
    </audio>

    <script>
        // 番茄钟应用
        class PomodoroTimer {
            constructor() {
                // 状态变量
                this.isRunning = false;
                this.isPaused = false;
                this.currentPhase = 'work'; // work, shortBreak, longBreak
                this.timeLeft = 25 * 60; // 秒数
                this.totalTime = 25 * 60;
                this.intervalId = null;
                this.tomatoCount = 0;
                this.completedWorkSessions = 0;
                
                // 默认设置
                this.settings = {
                    workTime: 25,
                    shortBreakTime: 5,
                    longBreakTime: 15,
                    longBreakInterval: 4,
                    autoStartNext: true,
                    soundEnabled: true,
                    volume: 70,
                    theme: 'default'
                };
                
                // DOM 元素
                this.elements = {
                    timeDisplay: document.getElementById('time-display'),
                    phaseLabel: document.getElementById('current-phase-label'),
                    progressBar: document.getElementById('progress-bar'),
                    startBtn: document.getElementById('start-btn'),
                    pauseBtn: document.getElementById('pause-btn'),
                    resetBtn: document.getElementById('reset-btn'),
                    skipBtn: document.getElementById('skip-btn'),
                    tomatoCount: document.getElementById('tomato-count'),
                    workPhase: document.getElementById('work-phase'),
                    shortBreakPhase: document.getElementById('short-break-phase'),
                    longBreakPhase: document.getElementById('long-break-phase'),
                    notification: document.getElementById('notification'),
                    settingsContent: document.getElementById('settings-content'),
                    toggleSettingsBtn: document.getElementById('toggle-settings-btn'),
                    
                    // 设置滑块
                    workTimeSlider: document.getElementById('work-time-slider'),
                    shortBreakSlider: document.getElementById('short-break-slider'),
                    longBreakSlider: document.getElementById('long-break-slider'),
                    longBreakIntervalSlider: document.getElementById('long-break-interval-slider'),
                    volumeSlider: document.getElementById('volume-slider'),
                    
                    // 设置值显示
                    workTimeValue: document.getElementById('work-time-value'),
                    shortBreakValue: document.getElementById('short-break-value'),
                    longBreakValue: document.getElementById('long-break-value'),
                    longBreakIntervalValue: document.getElementById('long-break-interval-value'),
                    volumeValue: document.getElementById('volume-value'),
                    
                    // 切换开关
                    autoNextToggle: document.getElementById('auto-next-toggle'),
                    soundToggle: document.getElementById('sound-toggle'),
                    
                    // 主题按钮
                    themeButtons: document.querySelectorAll('.theme-btn'),
                    
                    // 音效
                    startSound: document.getElementById('start-sound'),
                    endSound: document.getElementById('end-sound'),
                    tickSound: document.getElementById('tick-sound')
                };
                
                // 初始化
                this.init();
            }
            
            init() {
                this.loadSettings();
                this.setupEventListeners();
                this.updateTimerDisplay();
                this.updatePhaseIndicator();
                this.updatePageTitle();
                this.applyTheme();
                
                // 加载今日番茄计数
                this.loadTomatoCount();
            }
            
            setupEventListeners() {
                // 控制按钮
                this.elements.startBtn.addEventListener('click', () => this.startTimer());
                this.elements.pauseBtn.addEventListener('click', () => this.pauseTimer());
                this.elements.resetBtn.addEventListener('click', () => this.resetTimer());
                this.elements.skipBtn.addEventListener('click', () => this.skipPhase());
                
                // 设置滑块
                this.elements.workTimeSlider.addEventListener('input', (e) => {
                    this.settings.workTime = parseInt(e.target.value);
                    this.elements.workTimeValue.textContent = this.settings.workTime;
                    if (this.currentPhase === 'work' && !this.isRunning) {
                        this.timeLeft = this.settings.workTime * 60;
                        this.totalTime = this.timeLeft;
                        this.updateTimerDisplay();
                    }
                    this.saveSettings();
                });
                
                this.elements.shortBreakSlider.addEventListener('input', (e) => {
                    this.settings.shortBreakTime = parseInt(e.target.value);
                    this.elements.shortBreakValue.textContent = this.settings.shortBreakTime;
                    if (this.currentPhase === 'shortBreak' && !this.isRunning) {
                        this.timeLeft = this.settings.shortBreakTime * 60;
                        this.totalTime = this.timeLeft;
                        this.updateTimerDisplay();
                    }
                    this.saveSettings();
                });
                
                this.elements.longBreakSlider.addEventListener('input', (e) => {
                    this.settings.longBreakTime = parseInt(e.target.value);
                    this.elements.longBreakValue.textContent = this.settings.longBreakTime;
                    if (this.currentPhase === 'longBreak' && !this.isRunning) {
                        this.timeLeft = this.settings.longBreakTime * 60;
                        this.totalTime = this.timeLeft;
                        this.updateTimerDisplay();
                    }
                    this.saveSettings();
                });
                
                this.elements.longBreakIntervalSlider.addEventListener('input', (e) => {
                    this.settings.longBreakInterval = parseInt(e.target.value);
                    this.elements.longBreakIntervalValue.textContent = this.settings.longBreakInterval;
                    this.saveSettings();
                });
                
                this.elements.volumeSlider.addEventListener('input', (e) => {
                    this.settings.volume = parseInt(e.target.value);
                    this.elements.volumeValue.textContent = this.settings.volume;
                    this.setAudioVolume();
                    this.saveSettings();
                });
                
                // 切换开关
                this.elements.autoNextToggle.addEventListener('change', (e) => {
                    this.settings.autoStartNext = e.target.checked;
                    this.saveSettings();
                });
                
                this.elements.soundToggle.addEventListener('change', (e) => {
                    this.settings.soundEnabled = e.target.checked;
                    this.saveSettings();
                });
                
                // 主题按钮
                this.elements.themeButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const theme = btn.getAttribute('data-theme');
                        this.setTheme(theme);
                    });
                });
                
                // 切换设置面板
                this.elements.toggleSettingsBtn.addEventListener('click', () => {
                    this.toggleSettings();
                });
                
                // 键盘快捷键
                document.addEventListener('keydown', (e) => {
                    // 忽略在输入框中的按键
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                    
                    switch(e.key.toLowerCase()) {
                        case ' ':
                            e.preventDefault();
                            if (this.isRunning) {
                                this.pauseTimer();
                            } else {
                                this.startTimer();
                            }
                            break;
                        case 'r':
                            e.preventDefault();
                            this.resetTimer();
                            break;
                        case 's':
                            e.preventDefault();
                            this.skipPhase();
                            break;
                        case 'c':
                            e.preventDefault();
                            this.toggleSettings();
                            break;
                    }
                });
            }
            
            startTimer() {
                if (this.isRunning) return;
                
                this.isRunning = true;
                this.isPaused = false;
                
                // 更新按钮状态
                this.elements.startBtn.disabled = true;
                this.elements.pauseBtn.disabled = false;
                
                // 播放开始音效
                if (this.settings.soundEnabled) {
                    this.playSound('start');
                }
                
                // 添加动画效果
                this.elements.startBtn.classList.add('pixelate');
                setTimeout(() => {
                    this.elements.startBtn.classList.remove('pixelate');
                }, 200);
                
                // 开始计时
                this.intervalId = setInterval(() => {
                    this.timeLeft--;
                    this.updateTimerDisplay();
                    this.updatePageTitle();
                    
                    // 每10秒播放一次滴答声（最后30秒）
                    if (this.settings.soundEnabled && this.timeLeft <= 30 && this.timeLeft > 0 && this.timeLeft % 10 === 0) {
                        this.playSound('tick');
                    }
                    
                    // 时间到
                    if (this.timeLeft <= 0) {
                        this.timerComplete();
                    }
                }, 1000);
                
                // 显示通知
                this.showNotification(`${this.getPhaseName(this.currentPhase)} 开始！`);
            }
            
            pauseTimer() {
                if (!this.isRunning) return;
                
                this.isRunning = false;
                this.isPaused = true;
                clearInterval(this.intervalId);
                
                // 更新按钮状态
                this.elements.startBtn.disabled = false;
                this.elements.pauseBtn.disabled = true;
                
                // 添加动画效果
                this.elements.pauseBtn.classList.add('pixelate');
                setTimeout(() => {
                    this.elements.pauseBtn.classList.remove('pixelate');
                }, 200);
                
                // 显示通知
                this.showNotification('计时器已暂停');
            }
            
            resetTimer() {
                this.isRunning = false;
                this.isPaused = false;
                clearInterval(this.intervalId);
                
                // 重置当前阶段的时间
                switch(this.currentPhase) {
                    case 'work':
                        this.timeLeft = this.settings.workTime * 60;
                        break;
                    case 'shortBreak':
                        this.timeLeft = this.settings.shortBreakTime * 60;
                        break;
                    case 'longBreak':
                        this.timeLeft = this.settings.longBreakTime * 60;
                        break;
                }
                
                this.totalTime = this.timeLeft;
                
                // 更新按钮状态
                this.elements.startBtn.disabled = false;
                this.elements.pauseBtn.disabled = true;
                
                // 更新显示
                this.updateTimerDisplay();
                this.updatePageTitle();
                
                // 添加动画效果
                this.elements.resetBtn.classList.add('pixelate');
                setTimeout(() => {
                    this.elements.resetBtn.classList.remove('pixelate');
                }, 200);
                
                // 显示通知
                this.showNotification('计时器已重置');
            }
            
            skipPhase() {
                // 添加动画效果
                this.elements.skipBtn.classList.add('pixelate');
                setTimeout(() => {
                    this.elements.skipBtn.classList.remove('pixelate');
                }, 200);
                
                // 如果计时器正在运行，先停止
                if (this.isRunning) {
                    clearInterval(this.intervalId);
                    this.isRunning = false;
                }
                
                // 切换到下一个阶段
                this.switchToNextPhase();
                
                // 如果设置了自动开始，则启动计时器
                if (this.settings.autoStartNext) {
                    setTimeout(() => this.startTimer(), 500);
                }
                
                // 显示通知
                this.showNotification(`已跳过，进入${this.getPhaseName(this.currentPhase)}`);
            }
            
            timerComplete() {
                clearInterval(this.intervalId);
                this.isRunning = false;
                
                // 更新按钮状态
                this.elements.startBtn.disabled = false;
                this.elements.pauseBtn.disabled = true;
                
                // 播放结束音效
                if (this.settings.soundEnabled) {
                    this.playSound('end');
                }
                
                // 增加计数（如果是工作阶段完成）
                if (this.currentPhase === 'work') {
                    this.tomatoCount++;
                    this.completedWorkSessions++;
                    this.elements.tomatoCount.textContent = this.tomatoCount;
                    this.saveTomatoCount();
                }
                
                // 显示完成通知
                const phaseName = this.getPhaseName(this.currentPhase);
                this.showNotification(`${phaseName} 完成！`, true);
                
                // 切换到下一个阶段
                this.switchToNextPhase();
                
                // 如果设置了自动开始，则启动计时器
                if (this.settings.autoStartNext) {
                    setTimeout(() => this.startTimer(), 1000);
                }
            }
            
            switchToNextPhase() {
                // 根据当前阶段决定下一个阶段
                if (this.currentPhase === 'work') {
                    // 判断是否应该进入长休息
                    if (this.completedWorkSessions >= this.settings.longBreakInterval) {
                        this.currentPhase = 'longBreak';
                        this.completedWorkSessions = 0;
                    } else {
                        this.currentPhase = 'shortBreak';
                    }
                } else {
                    this.currentPhase = 'work';
                }
                
                // 设置新阶段的时间
                switch(this.currentPhase) {
                    case 'work':
                        this.timeLeft = this.settings.workTime * 60;
                        break;
                    case 'shortBreak':
                        this.timeLeft = this.settings.shortBreakTime * 60;
                        break;
                    case 'longBreak':
                        this.timeLeft = this.settings.longBreakTime * 60;
                        break;
                }
                
                this.totalTime = this.timeLeft;
                
                // 更新显示
                this.updateTimerDisplay();
                this.updatePhaseIndicator();
                this.updatePageTitle();
            }
            
            updateTimerDisplay() {
                // 更新时间显示
                const minutes = Math.floor(this.timeLeft / 60);
                const seconds = this.timeLeft % 60;
                this.elements.timeDisplay.textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // 更新阶段标签
                this.elements.phaseLabel.textContent = this.getPhaseDisplayName();
                
                // 更新进度条
                const progressPercentage = 100 - (this.timeLeft / this.totalTime * 100);
                this.elements.progressBar.style.width = `${progressPercentage}%`;
                
                // 根据剩余时间改变颜色
                if (this.timeLeft <= 60) { // 最后60秒
                    this.elements.timeDisplay.style.color = 'var(--warning-color)';
                } else {
                    this.elements.timeDisplay.style.color = 'var(--primary-color)';
                }
            }
            
            updatePhaseIndicator() {
                // 移除所有活动状态
                this.elements.workPhase.classList.remove('active');
                this.elements.shortBreakPhase.classList.remove('active');
                this.elements.longBreakPhase.classList.remove('active');
                
                // 根据当前阶段添加活动状态
                switch(this.currentPhase) {
                    case 'work':
                        this.elements.workPhase.classList.add('active');
                        break;
                    case 'shortBreak':
                        this.elements.shortBreakPhase.classList.add('active');
                        break;
                    case 'longBreak':
                        this.elements.longBreakPhase.classList.add('active');
                        break;
                }
            }
            
            updatePageTitle() {
                // 更新页面标题显示剩余时间
                if (this.isRunning) {
                    const minutes = Math.floor(this.timeLeft / 60);
                    const seconds = this.timeLeft % 60;
                    document.title = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')} - 番茄钟`;
                } else {
                    document.title = '番茄钟';
                }
            }
            
            getPhaseName(phase) {
                switch(phase) {
                    case 'work': return '工作';
                    case 'shortBreak': return '短休息';
                    case 'longBreak': return '长休息';
                    default: return '';
                }
            }
            
            getPhaseDisplayName() {
                switch(this.currentPhase) {
                    case 'work': return '专注工作';
                    case 'shortBreak': return '短暂休息';
                    case 'longBreak': return '长时间休息';
                    default: return '';
                }
            }
            
            toggleSettings() {
                const isHidden = this.elements.settingsContent.classList.contains('hidden');
                if (isHidden) {
                    this.elements.settingsContent.classList.remove('hidden');
                    this.elements.toggleSettingsBtn.innerHTML = '<i class="fas fa-cog"></i> 隐藏设置';
                } else {
                    this.elements.settingsContent.classList.add('hidden');
                    this.elements.toggleSettingsBtn.innerHTML = '<i class="fas fa-cog"></i> 显示设置';
                }
                
                // 添加动画效果
                this.elements.toggleSettingsBtn.classList.add('pixelate');
                setTimeout(() => {
                    this.elements.toggleSettingsBtn.classList.remove('pixelate');
                }, 200);
            }
            
            showNotification(message, isImportant = false) {
                this.elements.notification.textContent = message;
                this.elements.notification.classList.add('show');
                
                // 重要通知使用不同颜色
                if (isImportant) {
                    this.elements.notification.style.borderColor = 'var(--accent-color)';
                    this.elements.notification.style.backgroundColor = 'var(--panel-color)';
                } else {
                    this.elements.notification.style.borderColor = 'var(--primary-color)';
                    this.elements.notification.style.backgroundColor = 'var(--panel-color)';
                }
                
                // 3秒后隐藏通知
                setTimeout(() => {
                    this.elements.notification.classList.remove('show');
                }, 3000);
            }
            
            playSound(type) {
                let sound;
                switch(type) {
                    case 'start':
                        sound = this.elements.startSound;
                        break;
                    case 'end':
                        sound = this.elements.endSound;
                        break;
                    case 'tick':
                        sound = this.elements.tickSound;
                        break;
                    default:
                        return;
                }
                
                // 设置音量
                sound.volume = this.settings.volume / 100;
                
                // 播放声音
                sound.currentTime = 0;
                sound.play().catch(e => console.log("音频播放失败:", e));
            }
            
            setAudioVolume() {
                // 确保音量值是有效的有限数字
                let volume = this.settings.volume;
                
                // 如果音量值不是有限数字，使用默认值
                if (typeof volume !== 'number' || !isFinite(volume)) {
                    volume = 70; // 默认音量
                    this.settings.volume = volume;
                }
                
                // 确保音量在0-100范围内
                volume = Math.max(0, Math.min(100, volume));
                const volumeDecimal = volume / 100;
                
                // 更新所有音频元素的音量
                this.elements.startSound.volume = volumeDecimal;
                this.elements.endSound.volume = volumeDecimal;
                this.elements.tickSound.volume = volumeDecimal;
            }
            
            setTheme(theme) {
                this.settings.theme = theme;
                
                // 移除所有主题类
                document.body.classList.remove('dark-theme', 'green-theme', 'pink-theme');
                
                // 添加新主题类
                if (theme !== 'default') {
                    document.body.classList.add(`${theme}-theme`);
                }
                
                // 更新主题按钮状态
                this.elements.themeButtons.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-theme') === theme) {
                        btn.classList.add('active');
                    }
                });
                
                this.saveSettings();
            }
            
            applyTheme() {
                // 应用保存的主题
                this.setTheme(this.settings.theme);
            }
            
            loadSettings() {
                const savedSettings = localStorage.getItem('pomodoroSettings');
                if (savedSettings) {
                    this.settings = JSON.parse(savedSettings);
                    
                    // 更新UI以反映加载的设置
                    this.elements.workTimeSlider.value = this.settings.workTime;
                    this.elements.workTimeValue.textContent = this.settings.workTime;
                    this.elements.shortBreakSlider.value = this.settings.shortBreakTime;
                    this.elements.shortBreakValue.textContent = this.settings.shortBreakTime;
                    this.elements.longBreakSlider.value = this.settings.longBreakTime;
                    this.elements.longBreakValue.textContent = this.settings.longBreakTime;
                    this.elements.longBreakIntervalSlider.value = this.settings.longBreakInterval;
                    this.elements.longBreakIntervalValue.textContent = this.settings.longBreakInterval;
                    this.elements.volumeSlider.value = this.settings.volume;
                    this.elements.volumeValue.textContent = this.settings.volume;
                    this.elements.autoNextToggle.checked = this.settings.autoStartNext;
                    this.elements.soundToggle.checked = this.settings.soundEnabled;
                    
                    // 设置时间
                    this.timeLeft = this.settings.workTime * 60;
                    this.totalTime = this.timeLeft;
                    
                    this.setAudioVolume();
                }
            }
            
            saveSettings() {
                localStorage.setItem('pomodoroSettings', JSON.stringify(this.settings));
            }
            
            loadTomatoCount() {
                const today = new Date().toDateString();
                const savedData = localStorage.getItem('pomodoroStats');
                
                if (savedData) {
                    const stats = JSON.parse(savedData);
                    if (stats.date === today) {
                        this.tomatoCount = stats.count;
                        this.elements.tomatoCount.textContent = this.tomatoCount;
                    }
                }
            }
            
            saveTomatoCount() {
                const today = new Date().toDateString();
                const stats = {
                    date: today,
                    count: this.tomatoCount
                };
                localStorage.setItem('pomodoroStats', JSON.stringify(stats));
            }
        }
        
        // 初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            const pomodoroTimer = new PomodoroTimer();
        });
    </script>
</body>
</html>