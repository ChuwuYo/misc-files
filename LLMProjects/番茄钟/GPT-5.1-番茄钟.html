<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>番茄钟</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg-main: #f7f9ff;
      --bg-panel: #ffffff;
      --bg-accent: #b8f2e6;
      --bg-accent-soft: #dffaf3;
      --border-strong: #303446;
      --text-main: #303446;
      --text-muted: #6c707c;
      --danger: #ff6b6b;
      --success: #4caf50;
      --shadow-soft: 0 0 0 2px #303446;
      --pixel-size: 3px;
      --btn-bg: #ffe0f0;
      --btn-bg-hover: #ffd2e8;
      --btn-bg-active: #ffbedc;
      --progress-bg: #f0f0ff;
      --progress-fill: #5ec2b7;
    }

    body.dark {
      --bg-main: #202334;
      --bg-panel: #26293b;
      --bg-accent: #364156;
      --bg-accent-soft: #333a50;
      --border-strong: #f2f2f2;
      --text-main: #f2f2f2;
      --text-muted: #9ca0b5;
      --btn-bg: #3d3254;
      --btn-bg-hover: #4b3f67;
      --btn-bg-active: #332a4a;
      --progress-bg: #1d1f2e;
      --progress-fill: #ff8fb1;
    }

    /* 主题色 */
    body.theme-mint {
      --bg-accent: #b8f2e6;
      --bg-accent-soft: #dffaf3;
      --progress-fill: #5ec2b7;
      --btn-bg: #e4fff9;
      --btn-bg-hover: #d5f7f0;
      --btn-bg-active: #c4ece3;
    }
    body.theme-sakura {
      --bg-accent: #ffe0f0;
      --bg-accent-soft: #fff2f9;
      --progress-fill: #ff8fb1;
      --btn-bg: #ffe8f4;
      --btn-bg-hover: #ffd9ec;
      --btn-bg-active: #ffc6e2;
    }
    body.theme-star {
      --bg-accent: #dce7ff;
      --bg-accent-soft: #eef3ff;
      --progress-fill: #7389ff;
      --btn-bg: #e7edff;
      --btn-bg-hover: #d9e2ff;
      --btn-bg-active: #cad6ff;
    }
    body.theme-peach {
      --bg-accent: #ffe4c4;
      --bg-accent-soft: #fff2df;
      --progress-fill: #ffb184;
      --btn-bg: #ffeccd;
      --btn-bg-hover: #ffdeb3;
      --btn-bg-active: #ffd29a;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Press Start 2P", "VT323", "Courier New", monospace;
      background: var(--bg-main);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 12px;
      transition: background 0.3s, color 0.3s;
    }

    .pixel-bg-enabled body {
      image-rendering: pixelated;
    }

    .app-shell {
      width: 100%;
      max-width: 1100px;
      background: var(--bg-panel);
      border: var(--pixel-size) solid var(--border-strong);
      box-shadow: 0 0 0 3px #00000033;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    .pixel-grid-bg {
      position: absolute;
      inset: 0;
      background-image: linear-gradient(
          to right,
          rgba(0, 0, 0, 0.04) 1px,
          transparent 1px
        ),
        linear-gradient(
          to bottom,
          rgba(0, 0, 0, 0.04) 1px,
          transparent 1px
        );
      background-size: 16px 16px;
      pointer-events: none;
      opacity: 0.5;
      mix-blend-mode: multiply;
    }
    body.dark .pixel-grid-bg {
      opacity: 0.2;
      mix-blend-mode: screen;
    }

    .app-inner {
      position: relative;
      display: flex;
      flex-direction: column;
      z-index: 1;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      background: var(--bg-accent-soft);
      border-bottom: var(--pixel-size) solid var(--border-strong);
    }

    .title-area {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .title-text {
      font-size: 16px;
      letter-spacing: 1px;
    }

    .pixel-logo {
      width: 18px;
      height: 18px;
      background:
        linear-gradient(#ff8fb1, #ff8fb1) 0 0 / 6px 6px no-repeat,
        linear-gradient(#ff8fb1, #ff8fb1) 12px 12px / 6px 6px no-repeat,
        linear-gradient(#5ec2b7, #5ec2b7) 0 12px / 6px 6px no-repeat,
        linear-gradient(#5ec2b7, #5ec2b7) 12px 0 / 6px 6px no-repeat;
      image-rendering: pixelated;
      border: 2px solid var(--border-strong);
    }

    .header-center {
      font-size: 10px;
      color: var(--text-muted);
      text-align: center;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .header-badge {
      font-size: 9px;
      padding: 4px 6px;
      border: var(--pixel-size) solid var(--border-strong);
      background: var(--bg-panel);
    }

    .icon-btn {
      cursor: pointer;
      border: var(--pixel-size) solid var(--border-strong);
      background: var(--btn-bg);
      padding: 5px 7px;
      font-size: 9px;
      text-transform: uppercase;
      transition: transform 0.05s, box-shadow 0.05s, background 0.15s;
      box-shadow: 0 0 0 0 var(--border-strong);
    }
    .icon-btn:hover {
      background: var(--btn-bg-hover);
      transform: translate(-1px, -1px);
      box-shadow: var(--shadow-soft);
    }
    .icon-btn:active {
      background: var(--btn-bg-active);
      transform: translate(1px, 1px);
      box-shadow: 0 0 0 0 var(--border-strong);
    }

    main {
      display: flex;
      flex-direction: row;
      gap: 0;
    }

    .timer-pane {
      flex: 3;
      border-right: var(--pixel-size) solid var(--border-strong);
      padding: 16px 18px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .settings-pane {
      flex: 2;
      padding: 14px 14px 10px;
      background: var(--bg-accent-soft);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* Timer area */
    .phase-tags {
      display: flex;
      gap: 6px;
      font-size: 9px;
    }
    .phase-tag {
      padding: 3px 6px;
      border: var(--pixel-size) solid var(--border-strong);
      background: var(--bg-panel);
      opacity: 0.4;
    }
    .phase-tag.active {
      background: var(--bg-accent);
      opacity: 1;
    }

    .timer-display-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-top: 2px;
    }

    .timer-big {
      font-size: clamp(36px, 7vw, 52px);
      letter-spacing: 4px;
    }

    .phase-label {
      font-size: 12px;
      padding: 4px 8px;
      border: var(--pixel-size) solid var(--border-strong);
      background: var(--bg-panel);
    }

    .pixel-character-wrap {
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .pixel-character {
      width: 64px;
      height: 64px;
      position: relative;
      image-rendering: pixelated;
      border: var(--pixel-size) solid var(--border-strong);
      background: #222;
      overflow: hidden;
    }

    .pixel-character-inner {
      position: absolute;
      inset: 0;
      /* 简单像素角色：头+身体+眼睛 */
      background:
        /* body */ linear-gradient(#ff8fb1, #ff8fb1) 24px 30px / 16px 20px no-repeat,
        /* head */ linear-gradient(#ffcfdf, #ffcfdf) 20px 12px / 24px 20px no-repeat,
        /* eyes */ linear-gradient(#000, #000) 24px 18px / 4px 4px no-repeat,
        linear-gradient(#000, #000) 36px 18px / 4px 4px no-repeat,
        /* desk */ linear-gradient(#5ec2b7, #5ec2b7) 0 52px / 64px 12px no-repeat;
    }

    .pixel-character.work {
      animation: bob 1.3s infinite alternate;
    }
    .pixel-character.break {
      filter: hue-rotate(-20deg) saturate(1.2);
    }

    @keyframes bob {
      from {
        transform: translateY(0);
      }
      to {
        transform: translateY(-3px);
      }
    }

    .character-caption {
      font-size: 10px;
      color: var(--text-muted);
    }

    /* Progress */
    .progress-wrap {
      margin-top: 8px;
    }
    .progress-label-row {
      display: flex;
      justify-content: space-between;
      font-size: 9px;
      color: var(--text-muted);
      margin-bottom: 2px;
    }
    .progress-bar {
      position: relative;
      width: 100%;
      height: 18px;
      background: var(--progress-bg);
      border: var(--pixel-size) solid var(--border-strong);
      overflow: hidden;
    }
    .progress-fill {
      position: absolute;
      height: 100%;
      left: 0;
      top: 0;
      background: repeating-linear-gradient(
        45deg,
        var(--progress-fill),
        var(--progress-fill) 6px,
        rgba(255, 255, 255, 0.3) 6px,
        rgba(255, 255, 255, 0.3) 12px
      );
      width: 0%;
      transition: width 0.4s linear;
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .btn {
      cursor: pointer;
      border: var(--pixel-size) solid var(--border-strong);
      background: var(--btn-bg);
      padding: 6px 10px;
      font-size: 11px;
      min-width: 70px;
      text-align: center;
      transition: transform 0.05s, box-shadow 0.05s, background 0.15s;
      box-shadow: 0 0 0 0 var(--border-strong);
    }
    .btn.primary {
      background: var(--bg-accent);
    }
    .btn.danger {
      background: #ffd6d6;
      border-color: #b52b3b;
    }
    .btn:hover {
      background: var(--btn-bg-hover);
      transform: translate(-1px, -1px);
      box-shadow: var(--shadow-soft);
    }
    .btn.primary:hover {
      background: var(--bg-accent-soft);
    }
    .btn:active {
      background: var(--btn-bg-active);
      transform: translate(1px, 1px);
      box-shadow: 0 0 0 0 var(--border-strong);
    }

    .stats-row {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      font-size: 10px;
    }

    .badge {
      padding: 3px 6px;
      border: var(--pixel-size) solid var(--border-strong);
      background: var(--bg-panel);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .hint-row {
      margin-top: 10px;
      font-size: 9px;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 6px;
      flex-wrap: wrap;
    }

    /* Settings pane */
    .settings-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 10px;
    }

    .settings-section-title {
      font-size: 9px;
      margin-top: 6px;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .settings-group {
      border: var(--pixel-size) solid var(--border-strong);
      padding: 6px 8px;
      background: var(--bg-panel);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .field-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 9px;
    }

    .field-row label {
      flex: 1;
    }

    .field-row input[type="number"],
    .field-row input[type="range"],
    .field-row select {
      flex: 1;
      font-family: inherit;
      font-size: 9px;
      padding: 3px 4px;
      border: var(--pixel-size) solid var(--border-strong);
      background: var(--bg-main);
      color: var(--text-main);
    }

    .field-row input[type="range"] {
      padding: 0;
      height: 18px;
    }

    .switch {
      position: relative;
      width: 32px;
      height: 16px;
      border: var(--pixel-size) solid var(--border-strong);
      background: var(--bg-main);
      cursor: pointer;
      flex-shrink: 0;
    }
    .switch-thumb {
      position: absolute;
      top: 1px;
      left: 1px;
      width: 12px;
      height: 12px;
      background: var(--border-strong);
      transition: transform 0.15s;
    }
    .switch.on {
      background: var(--bg-accent);
    }
    .switch.on .switch-thumb {
      transform: translateX(14px);
      background: var(--border-strong);
    }

    .theme-color-row {
      display: flex;
      gap: 4px;
    }

    .theme-dot {
      width: 16px;
      height: 16px;
      border: var(--pixel-size) solid var(--border-strong);
      cursor: pointer;
    }
    .theme-dot.mint {
      background: #b8f2e6;
    }
    .theme-dot.sakura {
      background: #ffe0f0;
    }
    .theme-dot.star {
      background: #dce7ff;
    }
    .theme-dot.peach {
      background: #ffe4c4;
    }
    .theme-dot.active {
      box-shadow: 0 0 0 2px var(--border-strong);
    }

    .settings-collapsed {
      display: none;
    }
    .settings-toggle-indicator {
      font-size: 9px;
      color: var(--text-muted);
      cursor: pointer;
    }

    footer {
      border-top: var(--pixel-size) solid var(--border-strong);
      padding: 4px 8px;
      font-size: 9px;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 6px;
      background: var(--bg-panel);
    }

    /* Responsive */
    @media (max-width: 900px) {
      main {
        flex-direction: column;
      }
      .timer-pane {
        border-right: none;
        border-bottom: var(--pixel-size) solid var(--border-strong);
      }
    }

    @media (max-width: 640px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
      }
      .header-right {
        align-self: stretch;
        justify-content: space-between;
      }
      .timer-display-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .controls-row {
        justify-content: flex-start;
      }
      .pixel-character-wrap {
        align-items: flex-start;
      }
      .header-center {
        align-self: stretch;
        text-align: left;
      }
    }

    /* Hide number input arrows (for aesthetics) */
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] {
      -moz-appearance: textfield;
      appearance: textfield;
    }
  </style>
</head>
<body class="theme-mint">
  <div class="app-shell">
    <div class="pixel-grid-bg" id="pixelBg"></div>
    <div class="app-inner">
      <header>
        <div class="title-area">
          <div class="pixel-logo"></div>
          <div class="title-text">番茄钟</div>
        </div>
        <div class="header-center">
          <div id="headerDate"></div>
        </div>
        <div class="header-right">
          <div class="header-badge" id="phaseStatusBadge">准备中</div>
          <button class="icon-btn" id="themeToggleBtn">Light</button>
          <button class="icon-btn" id="settingsToggleBtn">设置</button>
        </div>
      </header>

      <main>
        <!-- Timer Pane -->
        <section class="timer-pane">
          <div class="phase-tags">
            <div class="phase-tag active" data-phase-tag="work">工作</div>
            <div class="phase-tag" data-phase-tag="short">短休</div>
            <div class="phase-tag" data-phase-tag="long">长休</div>
          </div>

          <div class="timer-display-row">
            <div class="timer-big" id="timeDisplay">25:00</div>
            <div class="phase-label" id="phaseLabel">工作时间</div>
          </div>

          <div class="pixel-character-wrap">
            <div class="pixel-character work" id="pixelCharacter">
              <div class="pixel-character-inner"></div>
            </div>
            <div class="character-caption" id="characterCaption">
              今天也要元气满满地专注 25 分钟哦 (*´▽｀*)
            </div>
          </div>

          <div class="progress-wrap">
            <div class="progress-label-row">
              <div>进度</div>
              <div id="progressPercentLabel">0%</div>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill"></div>
            </div>
          </div>

          <div class="controls-row">
            <button class="btn primary" id="startPauseBtn">开始</button>
            <button class="btn" id="resetBtn">重置 (R)</button>
            <button class="btn" id="skipBtn">跳过 (S)</button>
          </div>

          <div class="stats-row">
            <div class="badge">
              今日完成番茄：
              <span id="todayCount">0</span>
            </div>
            <div class="badge">
              已完成工作轮数：
              <span id="completedWorkSessions">0</span>
            </div>
          </div>

          <div class="hint-row">
            <div>快捷键：Space 开始/暂停 · R 重置 · S 跳过</div>
            <div id="soundStatusHint">音效：开启</div>
          </div>
        </section>

        <!-- Settings Pane -->
        <aside class="settings-pane" id="settingsPane">
          <div class="settings-header">
            <div>设置中心</div>
            <div class="settings-toggle-indicator" id="settingsCollapseToggle">
              折叠
            </div>
          </div>

          <div id="settingsBody">
            <!-- 时间设置 -->
            <div class="settings-section-title">时间</div>
            <div class="settings-group">
              <div class="field-row">
                <label for="workMinutesInput">工作时长 (分钟)</label>
                <input type="number" id="workMinutesInput" min="5" max="120" />
              </div>
              <div class="field-row">
                <label for="shortBreakMinutesInput">短休时长</label>
                <input type="number" id="shortBreakMinutesInput" min="1" max="60" />
              </div>
              <div class="field-row">
                <label for="longBreakMinutesInput">长休时长</label>
                <input type="number" id="longBreakMinutesInput" min="5" max="120" />
              </div>
              <div class="field-row">
                <label for="longBreakIntervalInput">每几个番茄后长休</label>
                <input type="number" id="longBreakIntervalInput" min="2" max="8" />
              </div>
            </div>

            <!-- 行为设置 -->
            <div class="settings-section-title">行为</div>
            <div class="settings-group">
              <div class="field-row">
                <label>自动开始下一阶段</label>
                <div class="switch" id="autoStartNextSwitch">
                  <div class="switch-thumb"></div>
                </div>
              </div>
              <div class="field-row">
                <label>自动开始第一轮</label>
                <div class="switch" id="autoStartFirstSwitch">
                  <div class="switch-thumb"></div>
                </div>
              </div>
            </div>

            <!-- 音效设置 -->
            <div class="settings-section-title">音效</div>
            <div class="settings-group">
              <div class="field-row">
                <label>开启音效</label>
                <div class="switch" id="enableSoundSwitch">
                  <div class="switch-thumb"></div>
                </div>
              </div>
              <div class="field-row">
                <label for="volumeRange">音量</label>
                <input type="range" id="volumeRange" min="0" max="100" />
              </div>
              <div class="field-row">
                <label>背景音乐</label>
                <div class="switch" id="enableBgmSwitch">
                  <div class="switch-thumb"></div>
                </div>
              </div>
              <div class="field-row">
                <label for="bgmVolumeRange">BGM 音量</label>
                <input type="range" id="bgmVolumeRange" min="0" max="100" />
              </div>
            </div>

            <!-- 外观设置 -->
            <div class="settings-section-title">外观</div>
            <div class="settings-group">
              <div class="field-row">
                <label>主题色</label>
                <div class="theme-color-row">
                  <div class="theme-dot mint active" data-theme-color="mint"></div>
                  <div class="theme-dot sakura" data-theme-color="sakura"></div>
                  <div class="theme-dot star" data-theme-color="star"></div>
                  <div class="theme-dot peach" data-theme-color="peach"></div>
                </div>
              </div>
              <div class="field-row">
                <label>像素背景</label>
                <div class="switch" id="pixelBgSwitch">
                  <div class="switch-thumb"></div>
                </div>
              </div>
            </div>
          </div>
        </aside>
      </main>

      <footer>
        <div>像素二次元番茄钟 · 本地保存设置与统计</div>
        <div>保持专注，也要记得休息 (*´ω｀*)</div>
      </footer>
    </div>
  </div>

  <script>
    // ==========================
    // Data & Defaults
    // ==========================
    const DEFAULT_SETTINGS = {
      workMinutes: 25,
      shortBreakMinutes: 5,
      longBreakMinutes: 15,
      longBreakInterval: 4,
      autoStartNext: true,
      autoStartFirst: false,
      enableSound: true,
      volume: 0.7,
      enableBgm: false,
      bgmVolume: 0.2,
      themeMode: 'light',
      themeColor: 'mint',
      pixelBackground: true
    };

    let settings = { ...DEFAULT_SETTINGS };

    const defaultStats = () => ({
      date: new Date().toISOString().slice(0, 10),
      workCompleted: 0
    });
    let stats = defaultStats();

    const LS_SETTINGS_KEY = 'pomodoroSettings';
    const LS_STATS_KEY = 'pomodoroStats';

    // Timer state
    const state = {
      phase: 'work', // 'work' | 'short' | 'long'
      remainingSeconds: DEFAULT_SETTINGS.workMinutes * 60,
      isRunning: false,
      totalPhaseSeconds: DEFAULT_SETTINGS.workMinutes * 60,
      intervalId: null,
      completedWorkSessions: 0
    };

    // Audio context for sound
    let audioCtx = null;
    let bgmOscillators = [];
    let bgmGainNode = null;

    // ==========================
    // DOM
    // ==========================
    const timeDisplayEl = document.getElementById('timeDisplay');
    const phaseLabelEl = document.getElementById('phaseLabel');
    const phaseStatusBadgeEl = document.getElementById('phaseStatusBadge');
    const progressFillEl = document.getElementById('progressFill');
    const progressPercentLabelEl = document.getElementById('progressPercentLabel');
    const startPauseBtn = document.getElementById('startPauseBtn');
    const resetBtn = document.getElementById('resetBtn');
    const skipBtn = document.getElementById('skipBtn');
    const todayCountEl = document.getElementById('todayCount');
    const completedWorkSessionsEl = document.getElementById('completedWorkSessions');
    const soundStatusHintEl = document.getElementById('soundStatusHint');
    const headerDateEl = document.getElementById('headerDate');
    const phaseTagsEls = document.querySelectorAll('[data-phase-tag]');
    const pixelCharacterEl = document.getElementById('pixelCharacter');
    const characterCaptionEl = document.getElementById('characterCaption');
    const themeToggleBtn = document.getElementById('themeToggleBtn');
    const settingsToggleBtn = document.getElementById('settingsToggleBtn');
    const settingsPaneEl = document.getElementById('settingsPane');
    const settingsCollapseToggleEl = document.getElementById('settingsCollapseToggle');
    const settingsBodyEl = document.getElementById('settingsBody');
    const pixelBgEl = document.getElementById('pixelBg');

    const workMinutesInput = document.getElementById('workMinutesInput');
    const shortBreakMinutesInput = document.getElementById('shortBreakMinutesInput');
    const longBreakMinutesInput = document.getElementById('longBreakMinutesInput');
    const longBreakIntervalInput = document.getElementById('longBreakIntervalInput');

    const autoStartNextSwitch = document.getElementById('autoStartNextSwitch');
    const autoStartFirstSwitch = document.getElementById('autoStartFirstSwitch');
    const enableSoundSwitch = document.getElementById('enableSoundSwitch');
    const enableBgmSwitch = document.getElementById('enableBgmSwitch');
    const pixelBgSwitch = document.getElementById('pixelBgSwitch');
    const volumeRange = document.getElementById('volumeRange');
    const bgmVolumeRange = document.getElementById('bgmVolumeRange');

    const themeDots = document.querySelectorAll('.theme-dot');

    // ==========================
    // Helpers
    // ==========================
    function clamp(val, min, max) {
      return Math.min(max, Math.max(min, val));
    }

    function loadSettings() {
      try {
        const stored = localStorage.getItem(LS_SETTINGS_KEY);
        if (stored) {
          const parsed = JSON.parse(stored);
          settings = { ...DEFAULT_SETTINGS, ...parsed };
        }
      } catch (e) {
        console.warn('Failed to load settings', e);
        settings = { ...DEFAULT_SETTINGS };
      }
    }

    function saveSettings() {
      try {
        localStorage.setItem(LS_SETTINGS_KEY, JSON.stringify(settings));
      } catch (e) {
        console.warn('Failed to save settings', e);
      }
    }

    function loadStats() {
      try {
        const stored = localStorage.getItem(LS_STATS_KEY);
        if (stored) {
          const parsed = JSON.parse(stored);
          const today = new Date().toISOString().slice(0, 10);
          if (parsed.date === today) {
            stats = parsed;
          } else {
            stats = { date: today, workCompleted: 0 };
          }
        } else {
          stats = defaultStats();
        }
      } catch (e) {
        console.warn('Failed to load stats', e);
        stats = defaultStats();
      }
    }

    function saveStats() {
      try {
        localStorage.setItem(LS_STATS_KEY, JSON.stringify(stats));
      } catch (e) {
        console.warn('Failed to save stats', e);
      }
    }

    function secondsToMMSS(sec) {
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }

    function updateDocumentTitle() {
      if (state.isRunning) {
        document.title = `${secondsToMMSS(state.remainingSeconds)} 番茄钟`;
      } else {
        document.title = '番茄钟';
      }
    }

    function updateHeaderDate() {
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, '0');
      const d = String(now.getDate()).padStart(2, '0');
      const dayNames = ['日', '一', '二', '三', '四', '五', '六'];
      const day = dayNames[now.getDay()];
      headerDateEl.textContent = `${y}-${m}-${d} 周${day}`;
    }

    // ==========================
    // Audio (beep & BGM)
    // ==========================
    function ensureAudioCtx() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
    }

    function playBeep(type) {
      if (!settings.enableSound) return;
      ensureAudioCtx();
      const ctx = audioCtx;

      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      gain.gain.value = 0;

      const now = ctx.currentTime;
      const vol = settings.volume;

      if (type === 'start') {
        osc.type = 'square';
        osc.frequency.setValueAtTime(880, now);
        gain.gain.setValueAtTime(0, now);
        gain.gain.linearRampToValueAtTime(0.3 * vol, now + 0.01);
        gain.gain.linearRampToValueAtTime(0, now + 0.18);
      } else if (type === 'end') {
        osc.type = 'square';
        osc.frequency.setValueAtTime(880, now);
        osc.frequency.linearRampToValueAtTime(660, now + 0.2);
        gain.gain.setValueAtTime(0, now);
        gain.gain.linearRampToValueAtTime(0.35 * vol, now + 0.02);
        gain.gain.linearRampToValueAtTime(0, now + 0.35);
      } else {
        osc.type = 'square';
        osc.frequency.setValueAtTime(1200, now);
        gain.gain.setValueAtTime(0, now);
        gain.gain.linearRampToValueAtTime(0.2 * vol, now + 0.01);
        gain.gain.linearRampToValueAtTime(0, now + 0.1);
      }

      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start(now);
      osc.stop(now + 0.5);
    }

    function startBgm() {
      if (!settings.enableBgm) return;
      ensureAudioCtx();
      if (bgmOscillators.length > 0) return; // already running
      const ctx = audioCtx;

      bgmGainNode = ctx.createGain();
      bgmGainNode.gain.value = settings.bgmVolume * 0.4;

      // Simple 8-bit-ish chord pattern
      const notes = [261.63, 329.63, 392.0]; // C E G
      notes.forEach((freq, i) => {
        const osc = ctx.createOscillator();
        osc.type = 'square';
        osc.frequency.value = freq;
        osc.connect(bgmGainNode);
        osc.start();
        bgmOscillators.push(osc);
      });

      bgmGainNode.connect(ctx.destination);
    }

    function stopBgm() {
      if (bgmOscillators.length === 0) return;
      bgmOscillators.forEach(o => {
        try { o.stop(); } catch(e) {}
      });
      bgmOscillators = [];
      if (bgmGainNode) {
        try { bgmGainNode.disconnect(); } catch(e) {}
        bgmGainNode = null;
      }
    }

    function updateBgmVolume() {
      if (bgmGainNode) {
        bgmGainNode.gain.value = settings.bgmVolume * 0.4;
      }
    }

    // ==========================
    // Timer Logic
    // ==========================
    function getPhaseName(phase) {
      if (phase === 'work') return '工作时间';
      if (phase === 'short') return '短休时间';
      return '长休时间';
    }

    function updateUI() {
      timeDisplayEl.textContent = secondsToMMSS(state.remainingSeconds);
      phaseLabelEl.textContent = getPhaseName(state.phase);

      // progress
      const elapsed = state.totalPhaseSeconds - state.remainingSeconds;
      const ratio = state.totalPhaseSeconds > 0
        ? elapsed / state.totalPhaseSeconds
        : 0;
      const percent = clamp(Math.round(ratio * 100), 0, 100);
      progressFillEl.style.width = percent + '%';
      progressPercentLabelEl.textContent = percent + '%';

      // phase tags
      phaseTagsEls.forEach(el => {
        el.classList.toggle('active', el.dataset.phaseTag === state.phase);
      });

      // status badge
      if (state.isRunning) {
        phaseStatusBadgeEl.textContent = '计时中';
      } else {
        if (state.remainingSeconds === state.totalPhaseSeconds) {
          phaseStatusBadgeEl.textContent = '准备中';
        } else {
          phaseStatusBadgeEl.textContent = '已暂停';
        }
      }

      startPauseBtn.textContent = state.isRunning ? '暂停' : '开始';

      todayCountEl.textContent = stats.workCompleted;
      completedWorkSessionsEl.textContent = state.completedWorkSessions;

      soundStatusHintEl.textContent = `音效：${settings.enableSound ? '开启' : '关闭'}`;

      // character
      if (state.phase === 'work') {
        pixelCharacterEl.classList.add('work');
        pixelCharacterEl.classList.remove('break');
        characterCaptionEl.textContent =
          state.isRunning
            ? '嘀嗒嘀嗒——不要被魔法手机诱惑住啦 (ง •̀_•́)ง'
            : '按下开始，让像素小助手陪你专注一会儿~';
      } else {
        pixelCharacterEl.classList.remove('work');
        pixelCharacterEl.classList.add('break');
        characterCaptionEl.textContent =
          '休息一下喝口水，眼睛也要 Look 远远的~';
      }

      updateDocumentTitle();
    }

    function applySettingsToInputs() {
      workMinutesInput.value = settings.workMinutes;
      shortBreakMinutesInput.value = settings.shortBreakMinutes;
      longBreakMinutesInput.value = settings.longBreakMinutes;
      longBreakIntervalInput.value = settings.longBreakInterval;

      volumeRange.value = Math.round(settings.volume * 100);
      bgmVolumeRange.value = Math.round(settings.bgmVolume * 100);

      setSwitch(autoStartNextSwitch, settings.autoStartNext);
      setSwitch(autoStartFirstSwitch, settings.autoStartFirst);
      setSwitch(enableSoundSwitch, settings.enableSound);
      setSwitch(enableBgmSwitch, settings.enableBgm);
      setSwitch(pixelBgSwitch, settings.pixelBackground);

      document.body.classList.toggle('dark', settings.themeMode === 'dark');
      themeToggleBtn.textContent = settings.themeMode === 'dark' ? 'Dark' : 'Light';

      document.body.classList.remove('theme-mint', 'theme-sakura', 'theme-star', 'theme-peach');
      document.body.classList.add('theme-' + settings.themeColor);

      themeDots.forEach(dot => {
        dot.classList.toggle('active', dot.dataset.themeColor === settings.themeColor);
      });

      pixelBgEl.style.display = settings.pixelBackground ? 'block' : 'none';
    }

    function setSwitch(switchEl, on) {
      switchEl.classList.toggle('on', on);
    }

    function toggleSwitch(switchEl, key) {
      const newVal = !settings[key];
      settings[key] = newVal;
      setSwitch(switchEl, newVal);
      saveSettings();
      if (key === 'enableBgm') {
        if (newVal) startBgm(); else stopBgm();
      }
      if (key === 'pixelBackground') {
        pixelBgEl.style.display = newVal ? 'block' : 'none';
      }
      if (key === 'enableSound') {
        updateUI();
      }
    }

    function resetPhase(phase) {
      state.phase = phase;
      let minutes;
      if (phase === 'work') minutes = settings.workMinutes;
      else if (phase === 'short') minutes = settings.shortBreakMinutes;
      else minutes = settings.longBreakMinutes;

      state.totalPhaseSeconds = minutes * 60;
      state.remainingSeconds = state.totalPhaseSeconds;
    }

    function resetTimer() {
      clearInterval(state.intervalId);
      state.intervalId = null;
      state.isRunning = false;
      resetPhase('work');
      updateUI();
    }

    function nextPhase() {
      let next;
      if (state.phase === 'work') {
        // count completed work session
        state.completedWorkSessions++;
        stats.workCompleted++;
        saveStats();
        if (state.completedWorkSessions % settings.longBreakInterval === 0) {
          next = 'long';
        } else {
          next = 'short';
        }
      } else {
        next = 'work';
      }

      resetPhase(next);

      if (settings.autoStartNext) {
        state.isRunning = true;
        startInterval();
      } else {
        state.isRunning = false;
      }
      playBeep('start');
      updateUI();
    }

    function tick() {
      if (!state.isRunning) return;
      if (state.remainingSeconds <= 0) {
        // phase complete
        playBeep('end');
        nextPhase();
        return;
      }
      state.remainingSeconds--;
      updateUI();
    }

    function startInterval() {
      clearInterval(state.intervalId);
      state.intervalId = setInterval(tick, 1000);
    }

    function toggleStartPause() {
      if (state.isRunning) {
        state.isRunning = false;
        updateUI();
      } else {
        state.isRunning = true;
        playBeep('start');
        startInterval();
        updateUI();
      }
    }

    function skipCurrentPhase() {
      playBeep('end');
      nextPhase();
    }

    // ==========================
    // Event Handlers
    // ==========================
    startPauseBtn.addEventListener('click', () => {
      toggleStartPause();
    });

    resetBtn.addEventListener('click', () => {
      playBeep('misc');
      resetTimer();
    });

    skipBtn.addEventListener('click', () => {
      skipCurrentPhase();
    });

    themeToggleBtn.addEventListener('click', () => {
      settings.themeMode = settings.themeMode === 'dark' ? 'light' : 'dark';
      document.body.classList.toggle('dark', settings.themeMode === 'dark');
      themeToggleBtn.textContent = settings.themeMode === 'dark' ? 'Dark' : 'Light';
      saveSettings();
    });

    settingsToggleBtn.addEventListener('click', () => {
      const hidden = settingsPaneEl.classList.toggle('settings-collapsed');
      settingsToggleBtn.textContent = hidden ? '设置▼' : '设置';
    });

    settingsCollapseToggleEl.addEventListener('click', () => {
      const hidden = settingsBodyEl.style.display === 'none';
      settingsBodyEl.style.display = hidden ? 'block' : 'none';
      settingsCollapseToggleEl.textContent = hidden ? '折叠' : '展开';
    });

    themeDots.forEach(dot => {
      dot.addEventListener('click', () => {
        const color = dot.dataset.themeColor;
        settings.themeColor = color;
        document.body.classList.remove('theme-mint', 'theme-sakura', 'theme-star', 'theme-peach');
        document.body.classList.add('theme-' + color);
        themeDots.forEach(d => d.classList.toggle('active', d === dot));
        saveSettings();
      });
    });

    // Switches
    autoStartNextSwitch.addEventListener('click', () =>
      toggleSwitch(autoStartNextSwitch, 'autoStartNext')
    );
    autoStartFirstSwitch.addEventListener('click', () =>
      toggleSwitch(autoStartFirstSwitch, 'autoStartFirst')
    );
    enableSoundSwitch.addEventListener('click', () =>
      toggleSwitch(enableSoundSwitch, 'enableSound')
    );
    enableBgmSwitch.addEventListener('click', () =>
      toggleSwitch(enableBgmSwitch, 'enableBgm')
    );
    pixelBgSwitch.addEventListener('click', () =>
      toggleSwitch(pixelBgSwitch, 'pixelBackground')
    );

    // Inputs for time
    function onMinutesInputChange(key, inputEl, min, max) {
      let val = parseInt(inputEl.value, 10);
      if (isNaN(val)) val = settings[key];
      val = clamp(val, min, max);
      settings[key] = val;
      inputEl.value = val;
      saveSettings();

      // 如果当前阶段与设置相关，且处于初始状态（未开始）则同步重置时长
      const isPhaseMatch =
        (key === 'workMinutes' && state.phase === 'work') ||
        (key === 'shortBreakMinutes' && state.phase === 'short') ||
        (key === 'longBreakMinutes' && state.phase === 'long');

      // 如果正在运行则不强制改变当前倒计时，只影响下轮
      if (!state.isRunning && isPhaseMatch) {
        resetPhase(state.phase);
        updateUI();
      }
    }

    workMinutesInput.addEventListener('change', () =>
      onMinutesInputChange('workMinutes', workMinutesInput, 5, 120)
    );
    shortBreakMinutesInput.addEventListener('change', () =>
      onMinutesInputChange('shortBreakMinutes', shortBreakMinutesInput, 1, 60)
    );
    longBreakMinutesInput.addEventListener('change', () =>
      onMinutesInputChange('longBreakMinutes', longBreakMinutesInput, 5, 120)
    );
    longBreakIntervalInput.addEventListener('change', () => {
      let val = parseInt(longBreakIntervalInput.value, 10);
      if (isNaN(val)) val = settings.longBreakInterval;
      val = clamp(val, 2, 8);
      settings.longBreakInterval = val;
      longBreakIntervalInput.value = val;
      saveSettings();
    });

    // Volume ranges
    volumeRange.addEventListener('input', () => {
      settings.volume = clamp(volumeRange.value / 100, 0, 1);
      saveSettings();
    });

    bgmVolumeRange.addEventListener('input', () => {
      settings.bgmVolume = clamp(bgmVolumeRange.value / 100, 0, 1);
      updateBgmVolume();
      saveSettings();
    });

    // Keyboard shortcuts
    window.addEventListener('keydown', (e) => {
      const tag = e.target.tagName.toLowerCase();
      if (tag === 'input' || tag === 'textarea' || tag === 'select') {
        return;
      }
      if (e.code === 'Space') {
        e.preventDefault();
        toggleStartPause();
      } else if (e.key === 'r' || e.key === 'R') {
        e.preventDefault();
        resetTimer();
      } else if (e.key === 's' || e.key === 'S') {
        e.preventDefault();
        skipCurrentPhase();
      }
    });

    // ==========================
    // Init
    // ==========================
    function init() {
      loadSettings();
      loadStats();
      updateHeaderDate();
      applySettingsToInputs();

      // 初始化 timer 状态
      resetPhase('work');
      state.isRunning = false;
      state.completedWorkSessions = 0;

      // 显示统计
      todayCountEl.textContent = stats.workCompleted;

      // BGM
      if (settings.enableBgm) {
        startBgm();
      }

      updateUI();

      // 自动启动第一轮
      if (settings.autoStartFirst) {
        toggleStartPause();
      }
    }

    init();
  </script>
</body>
</html>