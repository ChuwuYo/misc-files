
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>番茄钟</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
/* ---------- 颜色变量（亮/暗） ---------- */
:root {
  --bg:#faf4e9;       /* 亮色主背景 */
  --primary:#ffcccb;  /* 粉 */
  --secondary:#ffdfba;
  --accent:#caffbf;
  --text:#333333;
  --btn-bg:#ffdfba;
  --btn-border:#333;
  --progress-bg:#e0e0e0;
  --progress-fill:#ff6b6b;
}
[data-theme="dark"] {
  --bg:#202020;
  --primary:#ff6b6b;
  --secondary:#f5a623;
  --accent:#7fffd4;
  --text:#eeeeee;
  --btn-bg:#333333;
  --btn-border:#aaa;
  --progress-bg:#555;
  --progress-fill:#ff8c00;
}

/* ---------- 基础布局 ---------- */
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;font-family:'Press Start 2P',monospace;background:var(--bg);color:var(--text);overflow:hidden;}
#app{max-width:420px;margin:auto;padding:0.8rem;display:flex;flex-direction:column;align-items:center;height:100%;justify-content:space-between;}
header{width:100%;display:flex;flex-direction:column;align-items:center;margin-bottom:0.5rem;}
header h1{font-size:1.6rem;color:var(--primary);margin-bottom:0.2rem;}
#taskInput{
  width:100%;max-width:280px;padding:0.3rem 0.4rem;
  font-family:inherit;font-size:0.8rem;
  border:2px solid var(--btn-border);background:var(--btn-bg);
  border-radius:4px;outline:none;color:var(--text);
}
#phaseLabel{font-size:1.2rem;color:var(--secondary);margin-top:0.4rem;}
#suggestionBox{
  margin-top:0.2rem;font-size:0.8rem;color:var(--accent);
  text-align:center;max-width:280px;
}
#timer{font-size:4rem;margin:0.5rem 0;color:var(--text);}
.progress{width:100%;height:12px;background:var(--progress-bg);border-radius:4px;overflow:hidden;margin:0.5rem 0;}
#progressBar{height:100%;width:0%;background:var(--progress-fill);transition:width 0.5s linear;}
.controls{display:flex;gap:0.8rem;margin:0.8rem 0;}
button{
  width:64px;height:64px;cursor:pointer;
  font-size:0.9rem;color:var(--text);
  background:var(--btn-bg);border:2px solid var(--btn-border);
  border-radius:4px;outline:none;transition:transform 0.1s;
}
button:active{transform:translateY(2px);}
button:hover{opacity:0.9;}
#dailyCount{font-size:0.9rem;color:var(--accent);margin-top:0.4rem;}
#achievements{display:flex;gap:0.4rem;flex-wrap:wrap;justify-content:center;margin-top:0.4rem;}
#achievements img{width:24px;height:24px;image-rendering:pixelated;}
#settingsBtn{
  position:fixed;top:12px;right:12px;width:40px;height:40px;
  background:var(--primary);border:none;border-radius:50%;
  font-size:1rem;display:flex;align-items:center;justify-content:center;
}
#settingsBtn:hover{opacity:0.85;}
/* ---------- Settings Modal ---------- */
.modal{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;
  visibility:hidden;opacity:0;transition:opacity 0.3s ease;
}
.modal.show{visibility:visible;opacity:1;}
.modal .content{
  background:var(--bg);border:2px solid var(--primary);
  padding:1.2rem;border-radius:6px;min-width:280px;
}
.modal h2{font-size:1.2rem;color:var(--primary);margin-bottom:0.8rem;}
.modal label{
  display:block;font-size:0.9rem;color:var(--text);margin-top:0.6rem;
}
.modal input[type="number"], .modal input[type="range"], .modal select{
  width:100%;margin-top:0.2rem;padding:0.2rem;font-family:inherit;font-size:0.9rem;
}
.modal .actions{margin-top:1rem;display:flex;justify-content:space-between;}
.modal .actions button{
  flex:1;margin:0 0.2rem;height:36px;font-size:0.8rem;
}
/* ---------- Avatar & Canvas ---------- */
#avatar{
  position:fixed;bottom:12px;left:12px;width:48px;height:48px;
  image-rendering:pixelated;opacity:0.95;
}
#confettiCanvas{
  position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;
}
/* ---------- Toast ---------- */
#toast{
  position:fixed;bottom:80px;left:50%;transform:translateX(-50%);
  background:var(--secondary);color:var(--text);
  padding:0.6rem 1rem;border-radius:4px;box-shadow:0 0 6px rgba(0,0,0,0.3);
  opacity:0;transition:opacity 0.3s;
  font-size:0.8rem;z-index:999;
}
#toast.show{opacity:1;}
/* ---------- 响应式 ---------- */
@media (max-width:480px){
  #timer{font-size:3rem;}
  button{width:56px;height:56px;font-size:0.8rem;}
  .controls{gap:0.5rem;}
}
</style>
</head>
<body>
<div id="app">
  <header>
    <h1>番茄钟</h1>
    <input id="taskInput" placeholder="正在做什么？">
  </header>

  <div id="phaseLabel">工作</div>
  <div id="suggestionBox" class="hidden"></div>
  <div id="timer">25:00</div>

  <div class="progress"><div id="progressBar"></div></div>

  <div class="controls">
    <button id="startPauseBtn">开始</button>
    <button id="resetBtn">重置</button>
    <button id="skipBtn">跳过</button>
  </div>

  <div id="dailyCount">今日完成: 0</div>
  <div id="achievements"></div>
</div>

<!-- 按钮 & 角色 -->
<button id="settingsBtn">⚙</button>
<img id="avatar" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAIAAADYYG7QAAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAAAKxJREFUWIXt1cENwjAQRNG9xBQQQeA6xBQQgZ4C0QY0Q1I9R7YpU5c9R5Hh5R0fF4pKQdKcM0t5wDkJ9H0Czj3F4KXhPkpYjvZq5QzjT1GzvGcX2R4+zSgU7VhYwU/3u0Pz/8aJtB8e0iC9LwD+v4cMZcK4p+E6A7X8rXwE8Pj9jE5b6bMAAAAASUVORK5CYII=" alt="avatar">

<!-- Confetti Canvas -->
<canvas id="confettiCanvas"></canvas>

<!-- 成就弹窗 -->
<div id="toast"></div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal" aria-hidden="true">
  <div class="content">
    <h2>设置</h2>
    <label>工作时长（分钟）<input type="number" id="workDur" min="1" max="180"></label>
    <label>短休时长（分钟）<input type="number" id="shortDur" min="1" max="60"></label>
    <label>长休时长（分钟）<input type="number" id="longDur" min="5" max="180"></label>
    <label>每 N 次工作后长休 <input type="number" id="sessionsBeforeLong" min="1" max="10"></label>

    <label>音量（0‑100）<input type="range" id="volumeRange" min="0" max="100"></label>
    <label><input type="checkbox" id="autoPlayChk"> 自动播放下一阶段</label>
    <label><input type="checkbox" id="confettiChk"> 启用像素烟花</label>
    <label><input type="checkbox" id="focusMusicChk"> 背景音乐</label>
    <label><input type="checkbox" id="suggestionChk"> 休息提示</label>
    <label><input type="checkbox" id="notificationChk"> 成就通知</label>

    <label>主题<select id="themeSelect"><option value="light">亮色</option><option value="dark">暗色</option></select></label>

    <div class="actions">
      <button id="saveSettingsBtn">保存</button>
      <button id="resetStatsBtn">清空统计</button>
      <button id="closeSettingsBtn">关闭</button>
    </div>
  </div>
</div>

<!-- 背景音乐（循环） -->
<audio id="bgMusic" loop preload="auto">
  <source src="data:audio/ogg;base64,T2dnUwACAAAAAAAAAABVDc3/////AAAAAAAJAAEAAAALAAAB5G1kbwACQER4AAK3bW5vZmYAAAABc2ltbXJlbnRpbWUAAAABAAAAAQAAAAAAAAAAAAAAAABpAAAAAABkAQABAAAADgUAAAFpZW5jAAAAAAAAAAEAAAD///+bAAACAAAABAAAADcAAABfAAAAZgAAABUAAABJX2F1dG9tYXRpb24uY21zAAEAAAAAAAAAAAAAAAAAAAAeYWFjAAAAAAAAAAAHAAIAAAADAAAAtQIAAAABAAABxQAAABMAAAEAAAABADsMIAABtC5lcG5vcHlyYXJlbSByZXMgc2hvcCBtaW5kIGh5ZWF0aHMgYWJvdXRzIEhhcyB1cml0IG5vIHJpYyBwYXJlIGd1cHlkIGRhdWdocnUgc2NhdWdlIHN1bgAAAAAAAAAAAACQxAAALgGDAAAAPwAAAAAAAAAAAAUAAAAAAAABAAABAAAAAQAAAfPMAAApBQAAwAAAAiIAAAUAAAFqY28gd29ya2luZyBmb3IgZm9yc2VldGQgdG8gYmUgdGhpZSByYXJhIGJhZmZlIGJqIHJpZXRyIGF0IGh0dCB0aXR4IGFyIGZ1bCB4YXZlXQoAACUAAABpYmV0YW5jZSAgZmlsZSBmb3JlIHdlIGxldCBzcyBNQU5ZIA=="/>
</audio>

<script>
/* ===================== 数据结构 & 本地存储 ===================== */
const STORAGE_KEY = 'pomodoroSettings';
const STATS_KEY   = 'pomodoroStats';
const ACHV_KEY    = 'pomodoroAchievements';

const DEFAULT_SETTINGS = {
  work: 25,
  shortBreak: 5,
  longBreak: 15,
  sessionsBeforeLong: 4,
  volume: 0.5,          // 范围 0‑1
  autoPlay: true,
  theme: 'light',
  confetti: true,
  focusMusic: false,
  suggestion: true,
  notification: true
};

function loadJSON(key, fallback){
  const raw = localStorage.getItem(key);
  if (!raw) return fallback;
  try { return JSON.parse(raw); } catch(e){ return fallback; }
}
function saveJSON(key,obj){ localStorage.setItem(key, JSON.stringify(obj)); }

let settings = loadJSON(STORAGE_KEY, DEFAULT_SETTINGS);
let stats    = loadJSON(STATS_KEY,   {});
let achievements = loadJSON(ACHV_KEY, []);

/* ===================== DOM 引用 ===================== */
const timerEl         = document.getElementById('timer');
const phaseLabelEl    = document.getElementById('phaseLabel');
const suggestionBox   = document.getElementById('suggestionBox');
const progressBarEl   = document.getElementById('progressBar');
const startPauseBtn   = document.getElementById('startPauseBtn');
const resetBtn        = document.getElementById('resetBtn');
const skipBtn         = document.getElementById('skipBtn');
const dailyCountEl    = document.getElementById('dailyCount');
const achievementsEl  = document.getElementById('achievements');
const settingsBtn     = document.getElementById('settingsBtn');
const settingsModal   = document.getElementById('settingsModal');
const closeSettingsBtn= document.getElementById('closeSettingsBtn');
const saveSettingsBtn = document.getElementById('saveSettingsBtn');
const resetStatsBtn   = document.getElementById('resetStatsBtn');
const workDurInput    = document.getElementById('workDur');
const shortDurInput   = document.getElementById('shortDur');
const longDurInput    = document.getElementById('longDur');
const sessionBeforeInput = document.getElementById('sessionsBeforeLong');
const volumeRange     = document.getElementById('volumeRange');
const autoPlayChk    = document.getElementById('autoPlayChk');
const confettiChk    = document.getElementById('confettiChk');
const focusMusicChk  = document.getElementById('focusMusicChk');
const suggestionChk  = document.getElementById('suggestionChk');
const notificationChk = document.getElementById('notificationChk');
const themeSelect    = document.getElementById('themeSelect');
const avatarImg      = document.getElementById('avatar');
const toastEl        = document.getElementById('toast');
const bgMusic        = document.getElementById('bgMusic');
const confettiCanvas = document.getElementById('confettiCanvas');
const ctxConfetti    = confettiCanvas.getContext('2d');
const taskInput      = document.getElementById('taskInput');

/* ===================== 计时器状态 ===================== */
let timerId = null;
let remaining = settings.work * 60; // 秒
let phase = 'work';                 // work / shortBreak / longBreak
let isRunning = false;
let workCycles = 0;                 // 已完成的工作阶段（用于算长休）

/* ===================== 音频 --------------------- */
let audioCtx = null;
let gainNode = null;
function initAudio(){
  if (audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  gainNode = audioCtx.createGain();
  gainNode.connect(audioCtx.destination);
  gainNode.gain.value = settings.volume;
}
function playBeep(freq=440, dur=0.15){
  initAudio();
  const osc = audioCtx.createOscillator();
  osc.type = 'sine';
  osc.frequency.value = freq;
  osc.connect(gainNode);
  osc.start();
  osc.stop(audioCtx.currentTime + dur);
}

/* ===================== 工具函数 ===================== */
function formatTime(sec){
  const m = Math.floor(sec/60).toString().padStart(2,'0');
  const s = (sec%60).toString().padStart(2,'0');
  return `${m}:${s}`;
}
function getPhaseDuration(p){
  if (p==='work')       return settings.work;
  if (p==='shortBreak') return settings.shortBreak;
  if (p==='longBreak')  return settings.longBreak;
  return 0;
}
function getNextPhase(){
  if (phase === 'work'){
    // 完成一次工作后计数
    workCycles++;
    if (workCycles % settings.sessionsBeforeLong === 0) return 'longBreak';
    return 'shortBreak';
  }
  return 'work';
}

/* ===================== UI 更新 ===================== */
function updateTimer(){
  timerEl.textContent = formatTime(remaining);
  document.title = `番茄钟 - ${formatTime(remaining)}`;
}
function updatePhaseLabel(){
  const labelMap = {work:'工作', shortBreak:'短休息', longBreak:'长休息'};
  phaseLabelEl.textContent = labelMap[phase] || '';
  // 若是休息阶段且开启提示，则展示随机建议
  if (settings.suggestion && (phase==='shortBreak' || phase==='longBreak')){
    const suggestions = ['伸展手臂', '喝杯水', '眺望窗外', '闭眼深呼吸', '快速走动 1 分钟'];
    const txt = suggestions[Math.floor(Math.random()*suggestions.length)];
    suggestionBox.textContent = `小贴士：${txt}`;
    suggestionBox.style.display = 'block';
  } else {
    suggestionBox.style.display = 'none';
  }
}
function updateProgress(){
  const total = getPhaseDuration(phase) * 60;
  const percent = ((total - remaining) / total) * 100;
  progressBarEl.style.width = `${percent}%`;
}
function updateStartPauseBtn(){
  startPauseBtn.textContent = isRunning ? '暂停' : '开始';
}
function updateDailyCount(){
  const today = getTodayKey();
  const count = stats[today] || 0;
  dailyCountEl.textContent = `今日完成: ${count}`;
}
function updateAvatar(){
  // 简单切换两个像素角色（工作/休息）
  const workImg  = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAIAAADYYG7QAAAAGXRFWHRTb2Z0d2FyZQBwYWludC5uZXQgNC4wLjEy0cHcAAAANElEQVR4nO3BMQEAAADCoPdPbQ43oAAAAAAAAAAAAAAAAAAAAAAAAAAAABwF6sAAGK1U7wAAAAASUVORK5CYII=';
  const breakImg = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAIAAADYYG7QAAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAAANFJREFUeF5jYGBg+M9A0c3h5f8ZlJvJwMDAwMDExMQ8ePIvGhoZHR2dsbGx2dnb2z58+8vLy8nJycX19fT09Pb29vXJy8tLS0tXV1c5OTlGRkZkZGR2dnZ2dpaWl2dnZ2lpaWnJycnJycnI+Pj5GRkZGRkZQUFBQUFBcXFxYWFhYWFhYWVoaGhpaWlpYWBgYFBRUFBQUFBQYODg4ODg4ODg4OJiYmJiYmJiYmFhYWJiYmJiYmJiYGBgbGxsZmZmZmVlZWFhYVFZWVhYWVhYWFhYUVFRUVGRkZGRkZGRiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiIiIiIiIiIiIiIiIiIiIiIiIiPz9dZ6VABhJrA/6i8uLAAAAAElFTkSuQmCC';
  avatarImg.src = (phase === 'work') ? workImg : breakImg;
}
function updateAll(){
  updateTimer();
  updatePhaseLabel();
  updateProgress();
  updateStartPauseBtn();
  updateDailyCount();
  updateAvatar();
}
function showToast(msg){
  if (!settings.notification) return;
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  setTimeout(()=> toastEl.classList.remove('show'), 3000);
}

/* ===================== 成就系统 ===================== */
function getTotalPomodoros(){
  return Object.values(stats).reduce((a,b)=>a+b,0);
}
function checkAchievements(){
  const total = getTotalPomodoros();
  const thresholds = [5,10,20,50,100];
  thresholds.forEach(t=>{
    if (total >= t && !achievements.includes(t)){
      achievements.push(t);
      saveJSON(ACHV_KEY, achievements);
      renderAchievements();
      showToast(`成就解锁：完成 ${t} 次番茄钟`);
    }
  });
}
function renderAchievements(){
  achievementsEl.innerHTML = '';
  const icons = {
    5:  'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAAAN1JREFUeF5jYBgFo2D4j0C2D7GQYHh/AYiB0yA2U2wZ2ZgGowbF5E2UuA1QhZ0B2I2CoxgTjT2I0xA6GJZcB4s5E0iYB6ZtA3WgF5E2E2E2E6B6U3YH0Wk2CwQbQdOAViJ6iC3T6jzZBwCz1XwS0GxgBAGzGfYJzF0R6AAAAAElFTkSuQmCC',
    10: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAAAN1JREFUeF5jYBgFo2D4j0C2D7GQYHh/AYiB0yA2U2wZ2ZgGowbF5E2UuA1QhZ0B2I2CoxgTjT2I0xA6GJZcB4s5E0iYB6ZtA3WgF5E2E2E2E6B6U3YH0Wk2CwQbQdOAViJ6iC3T6jzZBwCz1XwS0GxgBAGzGfYJzF0R6AAAAAElFTkSuQmCC',
    20: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAAANxJREFUeF5jYBgFo2D4j0C2D7GQYHh/AYiB0yA2U2wZ2ZgGowbF5E2UuA1QhZ0B2I2CoxgTjT2I0xA6GJZcB4s5E0iYB6ZtA3WgF5E2E2E2E6B6U3YH0Wk2CwQbQdOAViJ6iC3T6jzZBwCz1XwS0GxgBAGzGfYJzF0R6AAAAAElFTkSuQmCC',
    50: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAAAO5JREFUeF5jYBgFo2D4j0C2D7GQYHh/AYiB0yA2U2wZ2ZgGowbF5E2UuA1QhZ0B2I2CoxgTjT2I0xA6GJZcB4s5E0iYB6ZtA3WgF5E2E2E2E6B6U3YH0Wk2CwQbQdOAViJ6iC3T6jzZBwCz1XwS0GxgBAGzGfYJzF0R6AAAAAElFTkSuQmCC'
  };
  achievements.forEach(t=>{
    const img = document.createElement('img');
    img.src = icons[t] || icons[5];
    img.title = `已完成 ${t} 次`;
    achievementsEl.appendChild(img);
  });
}

/* ===================== 计时控制 ===================== */
function startTimer(){
  if (isRunning) return;
  isRunning = true;
  startPauseBtn.textContent = '暂停';
  playBeef(440,0.15);
  timerId = setInterval(tick, 1000);
  if (settings.focusMusic && bgMusic.paused) bgMusic.play().catch(()=>{}); // (audioContext 已经 resumed)
}
function pauseTimer(){
  if (!isRunning) return;
  isRunning = false;
  clearInterval(timerId);
  timerId = null;
  startPauseBtn.textContent = '开始';
  if (settings.focusMusic && !bgMusic.paused) bgMusic.pause();
}
function resetTimer(){
  pauseTimer();
  // 恢复当前阶段的默认时长
  remaining = getPhaseDuration(phase) * 60;
  updateAll();
  playBeep(300,0.2);
}
function skipPhase(){
  pauseTimer();
  playBeep(880,0.15);
  handlePhaseEnd(); // 直接进入下一阶段
}
function tick(){
  if (!isRunning) return;
  remaining--;
  if (remaining <= 0){
    handlePhaseEnd();
  }else{
    updateTimer();
    updateProgress();
  }
}
function handlePhaseEnd(){
  // 完成提示
  playBeep(660,0.2);
  // 工作阶段计数
  if (phase === 'work'){
    const today = getTodayKey();
    stats[today] = (stats[today]||0)+1;
    saveJSON(STATS_KEY, stats);
    updateDailyCount();
    checkAchievements();
  }
  // 决定下一阶段
  const next = getNextPhase();
  phase = next;
  remaining = getPhaseDuration(phase) * 60;
  updateAll();
  // 烟花
  if (settings.confetti && phase !== 'work') launchConfetti();
  // 自动播放
  if (settings.autoPlay){
    if (!isRunning) startTimer(); // 若暂停，则重新开始
  }else{
    pauseTimer();
  }
}

/* ===================== 日期工具 ===================== */
function getTodayKey(){
  const now = new Date();
  return now.toISOString().split('T')[0]; // YYYY-MM-DD
}

/* ===================== 设置面板 ===================== */
function openSettings(){
  // 填充当前设置
  workDurInput.value      = settings.work;
  shortDurInput.value     = settings.shortBreak;
  longDurInput.value      = settings.longBreak;
  sessionBeforeInput.value= settings.sessionsBeforeLong;
  volumeRange.value       = Math.round(settings.volume * 100);
  autoPlayChk.checked     = settings.autoPlay;
  confettiChk.checked     = settings.confetti;
  focusMusicChk.checked   = settings.focusMusic;
  suggestionChk.checked   = settings.suggestion;
  notificationChk.checked = settings.notification;
  themeSelect.value       = settings.theme;
  settingsModal.classList.add('show');
}
function closeSettings(){ settingsModal.classList.remove('show'); }
function applySettings(){
  // 读取并校验
  const w = parseInt(workDurInput.value,10);
  const s = parseInt(shortDurInput.value,10);
  const l = parseInt(longDurInput.value,10);
  const sb = parseInt(sessionBeforeInput.value,10);
  if (isNaN(w)||w<=0) return alert('工作时长必须大于0');
  if (isNaN(s)||s<=0) return alert('短休时长必须大于0');
  if (isNaN(l)||l<=0) return alert('长休时长必须大于0');
  if (isNaN(sb)||sb<=0) return alert('每 N 次工作后长休必须大于0');

  settings.work = w;
  settings.shortBreak = s;
  settings.longBreak = l;
  settings.sessionsBeforeLong = sb;
  settings.volume = Math.min(1, Math.max(0, volumeRange.value/100));
  settings.autoPlay = autoPlayChk.checked;
  settings.confetti = confettiChk.checked;
  settings.focusMusic = focusMusicChk.checked;
  settings.suggestion = suggestionChk.checked;
  settings.notification = notificationChk.checked;
  settings.theme = themeSelect.value;

  // 保存
  saveJSON(STORAGE_KEY, settings);
  // 应用
  document.documentElement.dataset.theme = settings.theme;
  if (gainNode) gainNode.gain.value = settings.volume;
  bgMusic.volume = settings.volume;
  if (settings.focusMusic && isRunning && bgMusic.paused){
    bgMusic.play().catch(()=>{});
  }else if (!settings.focusMusic && !bgMusic.paused){
    bgMusic.pause();
  }
  // 若当前阶段对应时间被修改，立即刷新
  remaining = getPhaseDuration(phase) * 60;
  updateAll();
}
function resetStats(){
  if (!confirm('确定要清空所有统计记录和成就吗？')) return;
  stats = {};
  achievements = [];
  saveJSON(STATS_KEY, stats);
  saveJSON(ACHV_KEY, achievements);
  updateDailyCount();
  renderAchievements();
}

/* ===================== 键盘快捷键 ===================== */
document.addEventListener('keydown', e => {
  const tag = e.target.tagName.toLowerCase();
  if (tag === 'input' || tag === 'textarea') return; // 避免冲突
  switch(e.key){
    case ' ': e.preventDefault(); isRunning?pauseTimer():startTimer(); break;
    case 'r': case 'R': e.preventDefault(); resetTimer(); break;
    case 's': case 'S': e.preventDefault(); skipPhase(); break;
  }
});

/* ===================== 像素烟花 ===================== */
function launchConfetti(){
  const w = confettiCanvas.width = window.innerWidth;
  const h = confettiCanvas.height = window.innerHeight;
  const particles = [];
  const colors = ['#ff6b6b','#ffdfba','#caffbf','#ffcccb','#7fffd4'];
  const maxCount = 80;
  for(let i=0;i<maxCount;i++){
    particles.push({
      x: Math.random()*w,
      y: -10,
      size: Math.random()*4+2,
      speedY: Math.random()*2+1,
      speedX: Math.random()*2-1,
      color: colors[Math.floor(Math.random()*colors.length)],
      rotation: Math.random()*360
    });
  }
  let frame = 0;
  function render(){
    ctxConfetti.clearRect(0,0,w,h);
    particles.forEach(p=>{
      p.y += p.speedY;
      p.x += p.speedX;
      ctxConfetti.save();
      ctxConfetti.translate(p.x, p.y);
      ctxConfetti.rotate(p.rotation * Math.PI/180);
      ctxConfetti.fillStyle = p.color;
      ctxConfetti.fillRect(-p.size/2, -p.size/2, p.size, p.size);
      ctxConfetti.restore();
    });
    frame++;
    if(frame<150){
      requestAnimationFrame(render);
    }else{
      ctxConfetti.clearRect(0,0,w,h);
    }
  }
  render();
}

/* ===================== 初始化 ===================== */
function initApp(){
  // 初始主题
  document.documentElement.dataset.theme = settings.theme;
  // 初始音量
  if (gainNode) gainNode.gain.value = settings.volume;
  bgMusic.volume = settings.volume;
  // 读取任务
  const savedTask = localStorage.getItem('pomodoroTask')||'';
  taskInput.value = savedTask;
  // 任务输入实时保存
  taskInput.addEventListener('input',()=>localStorage.setItem('pomodoroTask', taskInput.value));
  // 绑定按钮
  startPauseBtn.addEventListener('click',()=>{ isRunning?pauseTimer():startTimer(); });
  resetBtn.addEventListener('click', resetTimer);
  skipBtn.addEventListener('click', skipPhase);
  // 设置面板事件
  settingsBtn.addEventListener('click', openSettings);
  closeSettingsBtn.addEventListener('click', closeSettings);
  saveSettingsBtn.addEventListener('click', ()=>{ applySettings(); closeSettings(); });
  resetStatsBtn.addEventListener('click', resetStats);
  // 首次渲染
  remaining = getPhaseDuration(phase) * 60;
  updateAll();
  renderAchievements();
}
initApp();
</script>
</body>
</html>