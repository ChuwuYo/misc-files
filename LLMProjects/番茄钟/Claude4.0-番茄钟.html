<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åƒç´ ç•ªèŒ„é’Ÿ - Pixel Pomodoro</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        :root {
            --primary: #6750A4;
            --primary-variant: #4F378B;
            --secondary: #625B71;
            --background: #FFFBFE;
            --surface: #F7F2FA;
            --surface-variant: #E7E0EC;
            --on-primary: #FFFFFF;
            --on-secondary: #FFFFFF;
            --on-background: #1C1B1F;
            --on-surface: #1C1B1F;
            --outline: #79747E;
            --error: #BA1A1A;
            --success: #006D3B;
            --warning: #8B5000;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Press Start 2P', monospace;
            background: var(--background);
            color: var(--on-background);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-image: 
                radial-gradient(circle at 1px 1px, var(--outline) 1px, transparent 0);
            background-size: 20px 20px;
        }

        .container {
            background: var(--surface);
            border: 4px solid var(--outline);
            border-radius: 16px;
            padding: 32px;
            max-width: 600px;
            width: 100%;
            box-shadow: 8px 8px 0px var(--outline);
            image-rendering: pixelated;
        }

        .header {
            text-align: center;
            margin-bottom: 32px;
        }

        .title {
            font-size: 16px;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 8px;
            color: var(--secondary);
        }

        .timer-section {
            text-align: center;
            margin-bottom: 32px;
        }

        .timer-display {
            position: relative;
            display: inline-block;
            margin-bottom: 24px;
        }

        .progress-ring {
            width: 200px;
            height: 200px;
            transform: rotate(-90deg);
        }

        .progress-ring-bg {
            fill: none;
            stroke: var(--surface-variant);
            stroke-width: 8;
        }

        .progress-ring-fill {
            fill: none;
            stroke: var(--primary);
            stroke-width: 8;
            stroke-linecap: square;
            transition: stroke-dasharray 0.5s ease;
        }

        .timer-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: var(--on-surface);
        }

        .status-text {
            font-size: 12px;
            margin-bottom: 16px;
            color: var(--secondary);
        }

        .status-work { color: var(--error); }
        .status-break { color: var(--success); }
        .status-long-break { color: var(--warning); }

        .controls {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 32px;
        }

        .btn {
            font-family: inherit;
            font-size: 10px;
            padding: 12px 20px;
            border: 3px solid var(--outline);
            background: var(--primary);
            color: var(--on-primary);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            min-width: 80px;
        }

        .btn:hover {
            background: var(--primary-variant);
            transform: translate(-2px, -2px);
            box-shadow: 4px 4px 0px var(--outline);
        }

        .btn:active {
            transform: translate(0, 0);
            box-shadow: 2px 2px 0px var(--outline);
        }

        .btn-secondary {
            background: var(--surface-variant);
            color: var(--on-surface);
        }

        .btn-secondary:hover {
            background: var(--secondary);
            color: var(--on-secondary);
        }

        .settings {
            border-top: 2px solid var(--outline);
            padding-top: 24px;
        }

        .settings-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            cursor: pointer;
        }

        .settings-title {
            font-size: 12px;
            color: var(--primary);
        }

        .settings-content {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .settings-content.show {
            display: grid;
        }

        .setting-group {
            border: 2px solid var(--outline);
            border-radius: 8px;
            padding: 16px;
            background: var(--surface-variant);
        }

        .setting-label {
            font-size: 8px;
            color: var(--on-surface);
            margin-bottom: 8px;
            display: block;
        }

        .setting-input {
            width: 100%;
            font-family: inherit;
            font-size: 10px;
            padding: 8px;
            border: 2px solid var(--outline);
            border-radius: 4px;
            background: var(--background);
            color: var(--on-background);
        }

        .setting-checkbox {
            transform: scale(1.5);
            margin-right: 8px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 8px;
        }

        .theme-selector {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .theme-btn {
            width: 24px;
            height: 24px;
            border: 2px solid var(--outline);
            border-radius: 4px;
            cursor: pointer;
        }

        .theme-default { background: #6750A4; }
        .theme-forest { background: #2E7D32; }
        .theme-sunset { background: #F57C00; }
        .theme-ocean { background: #1976D2; }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .timer-text {
                font-size: 18px;
            }
            
            .progress-ring {
                width: 150px;
                height: 150px;
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary);
            color: var(--on-primary);
            padding: 16px;
            border-radius: 8px;
            border: 2px solid var(--outline);
            font-size: 8px;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">åƒç´ ç•ªèŒ„é’Ÿ</h1>
            <p class="subtitle">PIXEL POMODORO TIMER</p>
        </div>

        <div class="timer-section">
            <div class="timer-display">
                <svg class="progress-ring">
                    <circle class="progress-ring-bg" cx="100" cy="100" r="90"></circle>
                    <circle class="progress-ring-fill" cx="100" cy="100" r="90" 
                            stroke-dasharray="565.48" stroke-dashoffset="565.48"></circle>
                </svg>
                <div class="timer-text" id="timerDisplay">25:00</div>
            </div>
            <div class="status-text status-work" id="statusText">å·¥ä½œæ—¶é—´ - ç¬¬1è½®</div>
        </div>

        <div class="controls">
            <button class="btn" id="startBtn">å¼€å§‹</button>
            <button class="btn btn-secondary" id="pauseBtn">æš‚åœ</button>
            <button class="btn btn-secondary" id="resetBtn">é‡ç½®</button>
            <button class="btn btn-secondary" id="skipBtn">è·³è¿‡</button>
        </div>

        <div class="settings">
            <div class="settings-header" id="settingsToggle">
                <span class="settings-title">è®¾ç½®é€‰é¡¹</span>
                <span id="settingsArrow">â–¼</span>
            </div>
            <div class="settings-content" id="settingsContent">
                <div class="setting-group">
                    <label class="setting-label">å·¥ä½œæ—¶é—´ (åˆ†é’Ÿ)</label>
                    <input type="number" class="setting-input" id="workTime" value="25" min="1" max="120">
                </div>
                <div class="setting-group">
                    <label class="setting-label">çŸ­ä¼‘æ¯æ—¶é—´ (åˆ†é’Ÿ)</label>
                    <input type="number" class="setting-input" id="shortBreak" value="5" min="1" max="60">
                </div>
                <div class="setting-group">
                    <label class="setting-label">é•¿ä¼‘æ¯æ—¶é—´ (åˆ†é’Ÿ)</label>
                    <input type="number" class="setting-input" id="longBreak" value="15" min="1" max="120">
                </div>
                <div class="setting-group">
                    <label class="setting-label">é•¿ä¼‘æ¯é—´éš” (è½®)</label>
                    <input type="number" class="setting-input" id="longBreakInterval" value="4" min="2" max="10">
                </div>
                <div class="setting-group">
                    <label class="checkbox-label">
                        <input type="checkbox" class="setting-checkbox" id="autoStart" checked>
                        è‡ªåŠ¨å¼€å§‹ä¸‹ä¸€è½®
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" class="setting-checkbox" id="soundEnabled" checked>
                        å£°éŸ³æé†’
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" class="setting-checkbox" id="notificationEnabled" checked>
                        æ¡Œé¢é€šçŸ¥
                    </label>
                </div>
                <div class="setting-group">
                    <label class="setting-label">ä¸»é¢˜é¢œè‰²</label>
                    <div class="theme-selector">
                        <div class="theme-btn theme-default" data-theme="default"></div>
                        <div class="theme-btn theme-forest" data-theme="forest"></div>
                        <div class="theme-btn theme-sunset" data-theme="sunset"></div>
                        <div class="theme-btn theme-ocean" data-theme="ocean"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats">
            <div class="stats-title">ä»Šæ—¥ç»Ÿè®¡</div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="completedPomodoros">0</div>
                    <div class="stat-label">å®Œæˆç•ªèŒ„</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalWorkTime">0</div>
                    <div class="stat-label">å·¥ä½œæ—¶é—´(åˆ†)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalBreakTime">0</div>
                    <div class="stat-label">ä¼‘æ¯æ—¶é—´(åˆ†)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="currentStreak">0</div>
                    <div class="stat-label">è¿ç»­å¤©æ•°</div>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        class PixelPomodoro {
            constructor() {
                this.timer = null;
                this.isRunning = false;
                this.currentTime = 0;
                this.currentSession = 'work';
                this.completedPomodoros = 0;
                this.currentRound = 1;
                
                // è®¾ç½®
                this.settings = {
                    workTime: 25,
                    shortBreak: 5,
                    longBreak: 15,
                    longBreakInterval: 4,
                    autoStart: true,
                    soundEnabled: true,
                    notificationEnabled: true,
                    theme: 'default'
                };

                // ç»Ÿè®¡æ•°æ®
                this.stats = {
                    completedPomodoros: 0,
                    totalWorkTime: 0,
                    totalBreakTime: 0,
                    currentStreak: 0
                };

                this.initializeElements();
                this.loadSettings();
                this.loadStats();
                this.bindEvents();
                this.requestNotificationPermission();
                this.resetTimer();
            }

            initializeElements() {
                // è®¡æ—¶å™¨å’Œæ§åˆ¶å…ƒç´ 
                this.timerDisplay = document.getElementById('timerDisplay');
                this.statusText = document.getElementById('statusText');
                this.startBtn = document.getElementById('startBtn');
                this.pauseBtn = document.getElementById('pauseBtn');
                this.resetBtn = document.getElementById('resetBtn');
                this.skipBtn = document.getElementById('skipBtn');
                this.progressRing = document.querySelector('.progress-ring-fill');
                this.notification = document.getElementById('notification');
                
                // è®¾ç½®è¾“å…¥æ¡†
                this.workTimeInput = document.getElementById('workTime');
                this.shortBreakInput = document.getElementById('shortBreak');
                this.longBreakInput = document.getElementById('longBreak');
                this.longBreakIntervalInput = document.getElementById('longBreakInterval');
                this.autoStartCheckbox = document.getElementById('autoStart');
                this.soundEnabledCheckbox = document.getElementById('soundEnabled');
                this.notificationEnabledCheckbox = document.getElementById('notificationEnabled');

                // ç»Ÿè®¡æ˜¾ç¤º
                this.completedPomodorosEl = document.getElementById('completedPomodoros');
                this.totalWorkTimeEl = document.getElementById('totalWorkTime');
                this.totalBreakTimeEl = document.getElementById('totalBreakTime');
                this.currentStreakEl = document.getElementById('currentStreak');
            }

            bindEvents() {
                this.startBtn.addEventListener('click', () => this.startTimer());
                this.pauseBtn.addEventListener('click', () => this.pauseTimer());
                this.resetBtn.addEventListener('click', () => this.resetTimer());
                this.skipBtn.addEventListener('click', () => this.skipSession());

                // è®¾ç½®åˆ‡æ¢
                document.getElementById('settingsToggle').addEventListener('click', () => {
                    const content = document.getElementById('settingsContent');
                    const arrow = document.getElementById('settingsArrow');
                    content.classList.toggle('show');
                    arrow.textContent = content.classList.contains('show') ? 'â–²' : 'â–¼';
                });

                // è®¾ç½®è¾“å…¥ç›‘å¬
                this.workTimeInput && this.workTimeInput.addEventListener('change', () => this.updateSettings());
                this.shortBreakInput && this.shortBreakInput.addEventListener('change', () => this.updateSettings());
                this.longBreakInput && this.longBreakInput.addEventListener('change', () => this.updateSettings());
                this.longBreakIntervalInput && this.longBreakIntervalInput.addEventListener('change', () => this.updateSettings());
                this.autoStartCheckbox && this.autoStartCheckbox.addEventListener('change', () => this.updateSettings());
                this.soundEnabledCheckbox && this.soundEnabledCheckbox.addEventListener('change', () => this.updateSettings());
                this.notificationEnabledCheckbox && this.notificationEnabledCheckbox.addEventListener('change', () => this.updateSettings());

                // ä¸»é¢˜é€‰æ‹©
                document.querySelectorAll('.theme-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.settings.theme = btn.dataset.theme;
                        this.applyTheme();
                        this.saveSettings();
                    });
                });

                // é”®ç›˜å¿«æ·é”®
                document.addEventListener('keydown', (e) => {
                    if (e.code === 'Space') {
                        e.preventDefault();
                        if (this.isRunning) {
                            this.pauseTimer();
                        } else {
                            this.startTimer();
                        }
                    } else if (e.code === 'KeyR') {
                        this.resetTimer();
                    } else if (e.code === 'KeyS') {
                        this.skipSession();
                    }
                });
            }

            updateSettings() {
                // ç¡®ä¿åœ¨æ›´æ–°å‰è¯»å–è¾“å…¥æ¡†çš„å½“å‰å€¼
                if (this.workTimeInput) this.settings.workTime = parseInt(this.workTimeInput.value);
                if (this.shortBreakInput) this.settings.shortBreak = parseInt(this.shortBreakInput.value);
                if (this.longBreakInput) this.settings.longBreak = parseInt(this.longBreakInput.value);
                if (this.longBreakIntervalInput) this.settings.longBreakInterval = parseInt(this.longBreakIntervalInput.value);
                if (this.autoStartCheckbox) this.settings.autoStart = this.autoStartCheckbox.checked;
                if (this.soundEnabledCheckbox) this.settings.soundEnabled = this.soundEnabledCheckbox.checked;
                if (this.notificationEnabledCheckbox) this.settings.notificationEnabled = this.notificationEnabledCheckbox.checked;
                
                this.saveSettings();
                if (!this.isRunning) {
                    this.resetTimer();
                }
            }

            startTimer() {
                if (!this.isRunning) {
                    this.isRunning = true;
                    this.startBtn.textContent = 'è¿è¡Œä¸­';
                    this.startBtn.disabled = true;
                    
                    this.timer = setInterval(() => {
                        this.currentTime--;
                        this.updateDisplay();
                        this.updateProgress();
                        
                        if (this.currentTime <= 0) {
                            this.completeSession();
                        }
                    }, 1000);
                }
            }

            pauseTimer() {
                if (this.isRunning) {
                    this.isRunning = false;
                    this.startBtn.textContent = 'ç»§ç»­';
                    this.startBtn.disabled = false;
                    clearInterval(this.timer);
                }
            }

            resetTimer() {
                this.pauseTimer();
                this.currentTime = this.getSessionDuration() * 60;
                this.updateDisplay();
                this.updateProgress();
                this.startBtn.textContent = 'å¼€å§‹';
            }

            skipSession() {
                if (confirm('ç¡®å®šè¦è·³è¿‡å½“å‰ä¼šè¯å—ï¼Ÿ')) {
                    this.completeSession();
                }
            }

            completeSession() {
                this.pauseTimer();
                this.playSound();
                this.showNotification();
                
                // æ›´æ–°ç»Ÿè®¡
                if (this.currentSession === 'work') {
                    this.completedPomodoros++;
                    this.stats.completedPomodoros++;
                    this.stats.totalWorkTime += this.settings.workTime;
                } else {
                    this.stats.totalBreakTime += (this.currentSession === 'shortBreak' ? this.settings.shortBreak : this.settings.longBreak);
                }
                
                this.updateStats();
                this.nextSession();
            }

            nextSession() {
                if (this.currentSession === 'work') {
                    if (this.completedPomodoros % this.settings.longBreakInterval === 0) {
                        this.currentSession = 'longBreak';
                    } else {
                        this.currentSession = 'shortBreak';
                    }
                } else {
                    this.currentSession = 'work';
                    if (this.currentSession === 'work') {
                        this.currentRound++;
                    }
                }
                
                this.resetTimer();
                this.updateStatus();
                
                if (this.settings.autoStart) {
                    // å»¶è¿Ÿå¯åŠ¨ï¼Œè®©ç”¨æˆ·çœ‹åˆ°çŠ¶æ€åˆ‡æ¢
                    setTimeout(() => this.startTimer(), 1000); 
                }
            }

            getSessionDuration() {
                switch (this.currentSession) {
                    case 'work': return this.settings.workTime;
                    case 'shortBreak': return this.settings.shortBreak;
                    case 'longBreak': return this.settings.longBreak;
                    default: return this.settings.workTime;
                }
            }

            updateDisplay() {
                const minutes = Math.floor(this.currentTime / 60);
                const seconds = this.currentTime % 60;
                this.timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // æ›´æ–°é¡µé¢æ ‡é¢˜
                document.title = `${this.timerDisplay.textContent} - åƒç´ ç•ªèŒ„é’Ÿ`;
            }

            updateProgress() {
                const totalTime = this.getSessionDuration() * 60;
                const progress = (totalTime - this.currentTime) / totalTime;
                const circumference = 2 * Math.PI * 90;
                const offset = circumference * (1 - progress);
                this.progressRing.style.strokeDashoffset = offset;
            }

            updateStatus() {
                const statusTexts = {
                    work: 'å·¥ä½œæ—¶é—´',
                    shortBreak: 'çŸ­ä¼‘æ¯',
                    longBreak: 'é•¿ä¼‘æ¯'
                };
                
                const statusClasses = {
                    work: 'status-work',
                    shortBreak: 'status-break',
                    longBreak: 'status-long-break'
                };
                
                this.statusText.textContent = `${statusTexts[this.currentSession]} - ç¬¬${this.currentRound}è½®`;
                this.statusText.className = `status-text ${statusClasses[this.currentSession]}`;
            }

            updateStats() {
                if (this.completedPomodorosEl) this.completedPomodorosEl.textContent = this.stats.completedPomodoros;
                if (this.totalWorkTimeEl) this.totalWorkTimeEl.textContent = this.stats.totalWorkTime;
                if (this.totalBreakTimeEl) this.totalBreakTimeEl.textContent = this.stats.totalBreakTime;
                if (this.currentStreakEl) this.currentStreakEl.textContent = this.stats.currentStreak;
                this.saveStats();
            }

            playSound() {
                if (this.settings.soundEnabled) {
                    try {
                        // å°è¯•ä½¿ç”¨ Web Audio API
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                        oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
                        oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.2);
                        
                        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                        
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.3);
                    } catch (e) {
                        console.warn("Web Audio API failed, trying fallback audio:", e);
                        // ç®€å•çš„å¤‡ç”¨ï¼ˆå¦‚æœæµè§ˆå™¨ç¯å¢ƒä¸æ”¯æŒ AudioContext æˆ–è¢«ç”¨æˆ·é˜»æ­¢ï¼‰
                        const audio = new Audio();
                        audio.src = 'data:audio/wav;base64,UklGRlYAAABXQVZFZm10IBAAAAABAAEAgD4AAAB9AAACABAAZGF0YQAAAAEAqF5dE04AAAAAA...' // å®é™…ä¸­éœ€è¦ä¸€ä¸ªæœ‰æ•ˆçš„çŸ­æç¤ºéŸ³
                        audio.play().catch(err => console.error("Fallback audio failed:", err));
                    }
                }
            }

            showNotification() {
                const messages = {
                    work: 'å·¥ä½œæ—¶é—´ç»“æŸï¼è¯¥ä¼‘æ¯ä¸€ä¸‹äº† ğŸ®',
                    shortBreak: 'ä¼‘æ¯ç»“æŸï¼ç»§ç»­åŠ æ²¹å·¥ä½œ ğŸ’ª',
                    longBreak: 'é•¿ä¼‘æ¯ç»“æŸï¼å‡†å¤‡å¥½æ–°çš„æŒ‘æˆ˜äº†å—ï¼Ÿ ğŸš€'
                };
                
                // é¡µé¢å†…é€šçŸ¥
                this.notification.textContent = messages[this.currentSession];
                this.notification.classList.add('show');
                setTimeout(() => {
                    this.notification.classList.remove('show');
                }, 3000);
                
                // æ¡Œé¢é€šçŸ¥
                if (this.settings.notificationEnabled && 'Notification' in window && Notification.permission === 'granted') {
                    new Notification('åƒç´ ç•ªèŒ„é’Ÿ', {
                        body: messages[this.currentSession],
                        icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjNjc1MEE0Ii8+CjxwYXRoIGQ9Ik0zMiA0OEM0MC44MzY2IDQ4IDQ4IDQwLjgzNjYgNDggMzJDNDggMjMuMTYzNCA0MC44MzY2IDE2IDMyIDE2QzIzLjE2MzQgMTYgMTYgMjMuMTYzNCAxNiAzMkMxNiA0MC44MzY2IDIzLjE2MzQgNDggMzIgNDhaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K'
                    });
                }
            }

            requestNotificationPermission() {
                if ('Notification' in window && Notification.permission === 'default') {
                    Notification.requestPermission();
                }
            }

            applyTheme() {
                const themes = {
                    default: { primary: '#6750A4', secondary: '#625B71' },
                    forest: { primary: '#2E7D32', secondary: '#1B5E20' },
                    sunset: { primary: '#F57C00', secondary: '#E65100' },
                    ocean: { primary: '#1976D2', secondary: '#0D47A1' }
                };
                
                const theme = themes[this.settings.theme] || themes.default; // ç¡®ä¿æœ‰é»˜è®¤å€¼
                document.documentElement.style.setProperty('--primary', theme.primary);
                document.documentElement.style.setProperty('--secondary', theme.secondary);
            }

            saveSettings() {
                localStorage.setItem('pixelPomodoroSettings', JSON.stringify(this.settings));
            }

            loadSettings() {
                const saved = localStorage.getItem('pixelPomodoroSettings');
                if (saved) {
                    // åˆå¹¶é»˜è®¤å€¼å’Œå·²ä¿å­˜çš„å€¼ï¼Œç¡®ä¿æ‰€æœ‰è®¾ç½®é”®éƒ½å­˜åœ¨
                    this.settings = { ...this.settings, ...JSON.parse(saved) };
                }
                
                // æ›´æ–°è¾“å…¥æ¡†å’Œå¤é€‰æ¡†ï¼ˆ**è¿™é‡ŒåŠ å…¥äº†å®‰å…¨æ£€æŸ¥**ï¼‰
                if (this.workTimeInput) this.workTimeInput.value = this.settings.workTime;
                if (this.shortBreakInput) this.shortBreakInput.value = this.settings.shortBreak;
                if (this.longBreakInput) this.longBreakInput.value = this.settings.longBreak;
                if (this.longBreakIntervalInput) this.longBreakIntervalInput.value = this.settings.longBreakInterval;
                if (this.autoStartCheckbox) this.autoStartCheckbox.checked = this.settings.autoStart;
                if (this.soundEnabledCheckbox) this.soundEnabledCheckbox.checked = this.settings.soundEnabled;
                if (this.notificationEnabledCheckbox) this.notificationEnabledCheckbox.checked = this.settings.notificationEnabled;
                
                this.applyTheme();
            }

            saveStats() {
                const today = new Date().toDateString();
                const savedStats = JSON.parse(localStorage.getItem('pixelPomodoroStats') || '{}');
                
                // ä»…ä¿å­˜æœ¬æ¬¡è¿è¡Œç»“æŸåçš„æœ€æ–°ç»Ÿè®¡æ•°æ®
                savedStats[today] = {
                    completedPomodoros: this.stats.completedPomodoros,
                    totalWorkTime: this.stats.totalWorkTime,
                    totalBreakTime: this.stats.totalBreakTime,
                    // è¿ç»­å¤©æ•°åœ¨åŠ è½½æ—¶é‡æ–°è®¡ç®—ï¼Œä¸ä¿å­˜åœ¨æ¯æ—¥è®°å½•ä¸­
                };
                localStorage.setItem('pixelPomodoroStats', JSON.stringify(savedStats));
            }

            loadStats() {
                const today = new Date().toDateString();
                const savedStatsAll = JSON.parse(localStorage.getItem('pixelPomodoroStats') || '{}');
                
                if (savedStatsAll[today]) {
                    // æ¢å¤å½“æ—¥çš„ç»Ÿè®¡å€¼
                    this.stats = { ...this.stats, ...savedStatsAll[today] };
                }
                
                // è®¡ç®—è¿ç»­å¤©æ•°ï¼ˆä»æ‰€æœ‰å†å²è®°å½•ä¸­è®¡ç®—ï¼‰
                const dates = Object.keys(savedStatsAll).sort().reverse();
                let streak = 0;
                const todayTime = new Date(today).getTime();
                
                for (let i = 0; i < dates.length; i++) {
                    const currentDateStr = dates[i];
                    const currentStat = savedStatsAll[currentDateStr];
                    
                    const currentDayTime = new Date(currentDateStr).getTime();
                    
                    // è®¡ç®—å¤©æ•°å·®
                    const daysDiff = Math.floor((todayTime - currentDayTime) / (1000 * 60 * 60 * 24));
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯æ˜¨å¤©çš„æˆ–æ›´æ—©ï¼Œå¹¶ä¸”å½“å¤©æœ‰ç•ªèŒ„å®Œæˆ
                    if (daysDiff === streak && currentStat.completedPomodoros > 0) {
                        streak++;
                    } else if (daysDiff === streak + 1 && currentStat.completedPomodoros > 0) {
                        // ç¡®ä¿æ˜¨å¤©å®Œæˆäº†æ‰ç®—è¿ç»­
                        streak++;
                    } else if (daysDiff > streak) {
                        // å‡ºç°æ–­å±‚
                        break;
                    }
                }
                
                // å¦‚æœä»Šå¤©æ˜¯ç¬¬ä¸€å¤©ï¼ˆi=0ï¼ŒdaysDiff=0ï¼‰ï¼Œå¹¶ä¸”å®Œæˆäº†ç•ªèŒ„ï¼Œstreakè‡³å°‘ä¸º1
                if (new Date(dates[0]).toDateString() === today && this.stats.completedPomodoros > 0) {
                     this.stats.currentStreak = streak;
                } else if (dates.length > 0 && new Date(dates[0]).toDateString() !== today && this.stats.completedPomodoros > 0) {
                     // å¦‚æœä»Šå¤©æ˜¯æ–°çš„ä¸€å¤©ï¼Œå¹¶ä¸”å®Œæˆäº†å·¥ä½œï¼Œåˆ™è‡³å°‘ä¸º1
                     this.stats.currentStreak = 1;
                } else {
                     // å¦‚æœæ²¡æœ‰å®Œæˆä»»ä½•å·¥ä½œï¼Œæˆ–è€…ä»Šå¤©ä¸æ˜¯å†å²è®°å½•çš„ç¬¬ä¸€å¤©ï¼Œåˆ™é‡æ–°è®¡ç®—
                    let calculatedStreak = 0;
                    let previousDate = new Date(todayTime);
                    previousDate.setDate(previousDate.getDate() - 1); // ä»æ˜¨å¤©å¼€å§‹æ£€æŸ¥
                    
                    for (let i = 0; i < dates.length; i++) {
                        const checkDateStr = previousDate.toDateString();
                        if (savedStatsAll[checkDateStr] && savedStatsAll[checkDateStr].completedPomodoros > 0) {
                            calculatedStreak++;
                            previousDate.setDate(previousDate.getDate() - 1);
                        } else {
                            break;
                        }
                    }
                    // å¦‚æœä»Šå¤©å·²ç»å®Œæˆäº†ï¼Œç®—ä¸Šä»Šå¤©
                    if (this.stats.completedPomodoros > 0) {
                         this.stats.currentStreak = calculatedStreak + 1;
                    } else {
                         this.stats.currentStreak = calculatedStreak;
                    }
                }
                
                // ç®€åŒ– streak è®¡ç®—é€»è¾‘ï¼Œç¡®ä¿ä»Šå¤©å®Œæˆçš„ç•ªèŒ„è®¡å…¥ï¼ˆå¦‚æœå†å²è®°å½•ä¸­æœ‰æ˜¨å¤©çš„ï¼‰
                let streakCount = 0;
                const sortedDates = Object.keys(savedStatsAll).sort((a, b) => new Date(b) - new Date(a));
                
                // æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²å®Œæˆ
                if (new Date(sortedDates[0] || new Date().toDateString()).toDateString() === today && this.stats.completedPomodoros > 0) {
                    streakCount = 1;
                }

                for (let i = 1; i < sortedDates.length; i++) {
                    const prevDay = new Date(sortedDates[i-1]);
                    const currentDay = new Date(sortedDates[i]);
                    
                    // æ£€æŸ¥æ—¥æœŸæ˜¯å¦è¿ç»­ (å·®ä¸€å¤©)
                    const diffTime = Math.abs(prevDay - currentDay);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    if (diffDays === 1 && savedStatsAll[sortedDates[i]].completedPomodoros > 0) {
                        streakCount++;
                    } else {
                        break;
                    }
                }
                
                // æœ€ç»ˆä¿®æ­£ï¼šå¦‚æœä»Šå¤©å®Œæˆäº†ï¼Œä½†å†å²è®°å½•ä¸­æ²¡æœ‰ä»Šå¤©ï¼ˆå› ä¸ºæ˜¯åˆšå®Œæˆçš„ï¼‰ï¼Œåˆ™è‡³å°‘ä¸º1
                if (this.stats.completedPomodoros > 0 && new Date(sortedDates[0] || new Date().toDateString()).toDateString() !== today) {
                    this.stats.currentStreak = 1;
                } else {
                    this.stats.currentStreak = streakCount;
                }

                this.updateStats();
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            new PixelPomodoro();
        });
    </script>
</body>
</html>