<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>像素番茄钟 - Pixel Pomodoro</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        :root {
            --primary: #6750A4;
            --primary-variant: #4F378B;
            --secondary: #625B71;
            --background: #FFFBFE;
            --surface: #F7F2FA;
            --surface-variant: #E7E0EC;
            --on-primary: #FFFFFF;
            --on-secondary: #FFFFFF;
            --on-background: #1C1B1F;
            --on-surface: #1C1B1F;
            --outline: #79747E;
            --error: #BA1A1A;
            --success: #006D3B;
            --warning: #8B5000;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Press Start 2P', monospace;
            background: var(--background);
            color: var(--on-background);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-image: 
                radial-gradient(circle at 1px 1px, var(--outline) 1px, transparent 0);
            background-size: 20px 20px;
        }

        .container {
            background: var(--surface);
            border: 4px solid var(--outline);
            border-radius: 16px;
            padding: 32px;
            max-width: 600px;
            width: 100%;
            box-shadow: 8px 8px 0px var(--outline);
            image-rendering: pixelated;
        }

        .header {
            text-align: center;
            margin-bottom: 32px;
        }

        .title {
            font-size: 16px;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 8px;
            color: var(--secondary);
        }

        .timer-section {
            text-align: center;
            margin-bottom: 32px;
        }

        .timer-display {
            position: relative;
            display: inline-block;
            margin-bottom: 24px;
        }

        .progress-ring {
            width: 200px;
            height: 200px;
            transform: rotate(-90deg);
        }

        .progress-ring-bg {
            fill: none;
            stroke: var(--surface-variant);
            stroke-width: 8;
        }

        .progress-ring-fill {
            fill: none;
            stroke: var(--primary);
            stroke-width: 8;
            stroke-linecap: square;
            transition: stroke-dasharray 0.5s ease;
        }

        .timer-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: var(--on-surface);
        }

        .status-text {
            font-size: 12px;
            margin-bottom: 16px;
            color: var(--secondary);
        }

        .status-work { color: var(--error); }
        .status-break { color: var(--success); }
        .status-long-break { color: var(--warning); }

        .controls {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 32px;
        }

        .btn {
            font-family: inherit;
            font-size: 10px;
            padding: 12px 20px;
            border: 3px solid var(--outline);
            background: var(--primary);
            color: var(--on-primary);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            min-width: 80px;
        }

        .btn:hover {
            background: var(--primary-variant);
            transform: translate(-2px, -2px);
            box-shadow: 4px 4px 0px var(--outline);
        }

        .btn:active {
            transform: translate(0, 0);
            box-shadow: 2px 2px 0px var(--outline);
        }

        .btn-secondary {
            background: var(--surface-variant);
            color: var(--on-surface);
        }

        .btn-secondary:hover {
            background: var(--secondary);
            color: var(--on-secondary);
        }

        .settings {
            border-top: 2px solid var(--outline);
            padding-top: 24px;
        }

        .settings-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            cursor: pointer;
        }

        .settings-title {
            font-size: 12px;
            color: var(--primary);
        }

        .settings-content {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .settings-content.show {
            display: grid;
        }

        .setting-group {
            border: 2px solid var(--outline);
            border-radius: 8px;
            padding: 16px;
            background: var(--surface-variant);
        }

        .setting-label {
            font-size: 8px;
            color: var(--on-surface);
            margin-bottom: 8px;
            display: block;
        }

        .setting-input {
            width: 100%;
            font-family: inherit;
            font-size: 10px;
            padding: 8px;
            border: 2px solid var(--outline);
            border-radius: 4px;
            background: var(--background);
            color: var(--on-background);
        }

        .setting-checkbox {
            transform: scale(1.5);
            margin-right: 8px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 8px;
        }

        .theme-selector {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .theme-btn {
            width: 24px;
            height: 24px;
            border: 2px solid var(--outline);
            border-radius: 4px;
            cursor: pointer;
        }

        .theme-default { background: #6750A4; }
        .theme-forest { background: #2E7D32; }
        .theme-sunset { background: #F57C00; }
        .theme-ocean { background: #1976D2; }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .timer-text {
                font-size: 18px;
            }
            
            .progress-ring {
                width: 150px;
                height: 150px;
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary);
            color: var(--on-primary);
            padding: 16px;
            border-radius: 8px;
            border: 2px solid var(--outline);
            font-size: 8px;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">像素番茄钟</h1>
            <p class="subtitle">PIXEL POMODORO TIMER</p>
        </div>

        <div class="timer-section">
            <div class="timer-display">
                <svg class="progress-ring">
                    <circle class="progress-ring-bg" cx="100" cy="100" r="90"></circle>
                    <circle class="progress-ring-fill" cx="100" cy="100" r="90" 
                            stroke-dasharray="565.48" stroke-dashoffset="565.48"></circle>
                </svg>
                <div class="timer-text" id="timerDisplay">25:00</div>
            </div>
            <div class="status-text status-work" id="statusText">工作时间 - 第1轮</div>
        </div>

        <div class="controls">
            <button class="btn" id="startBtn">开始</button>
            <button class="btn btn-secondary" id="pauseBtn">暂停</button>
            <button class="btn btn-secondary" id="resetBtn">重置</button>
            <button class="btn btn-secondary" id="skipBtn">跳过</button>
        </div>

        <div class="settings">
            <div class="settings-header" id="settingsToggle">
                <span class="settings-title">设置选项</span>
                <span id="settingsArrow">▼</span>
            </div>
            <div class="settings-content" id="settingsContent">
                <div class="setting-group">
                    <label class="setting-label">工作时间 (分钟)</label>
                    <input type="number" class="setting-input" id="workTime" value="25" min="1" max="120">
                </div>
                <div class="setting-group">
                    <label class="setting-label">短休息时间 (分钟)</label>
                    <input type="number" class="setting-input" id="shortBreak" value="5" min="1" max="60">
                </div>
                <div class="setting-group">
                    <label class="setting-label">长休息时间 (分钟)</label>
                    <input type="number" class="setting-input" id="longBreak" value="15" min="1" max="120">
                </div>
                <div class="setting-group">
                    <label class="setting-label">长休息间隔 (轮)</label>
                    <input type="number" class="setting-input" id="longBreakInterval" value="4" min="2" max="10">
                </div>
                <div class="setting-group">
                    <label class="checkbox-label">
                        <input type="checkbox" class="setting-checkbox" id="autoStart" checked>
                        自动开始下一轮
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" class="setting-checkbox" id="soundEnabled" checked>
                        声音提醒
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" class="setting-checkbox" id="notificationEnabled" checked>
                        桌面通知
                    </label>
                </div>
                <div class="setting-group">
                    <label class="setting-label">主题颜色</label>
                    <div class="theme-selector">
                        <div class="theme-btn theme-default" data-theme="default"></div>
                        <div class="theme-btn theme-forest" data-theme="forest"></div>
                        <div class="theme-btn theme-sunset" data-theme="sunset"></div>
                        <div class="theme-btn theme-ocean" data-theme="ocean"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats">
            <div class="stats-title">今日统计</div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="completedPomodoros">0</div>
                    <div class="stat-label">完成番茄</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalWorkTime">0</div>
                    <div class="stat-label">工作时间(分)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalBreakTime">0</div>
                    <div class="stat-label">休息时间(分)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="currentStreak">0</div>
                    <div class="stat-label">连续天数</div>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        class PixelPomodoro {
            constructor() {
                this.timer = null;
                this.isRunning = false;
                this.currentTime = 0;
                this.currentSession = 'work';
                this.completedPomodoros = 0;
                this.currentRound = 1;
                
                // 设置
                this.settings = {
                    workTime: 25,
                    shortBreak: 5,
                    longBreak: 15,
                    longBreakInterval: 4,
                    autoStart: true,
                    soundEnabled: true,
                    notificationEnabled: true,
                    theme: 'default'
                };

                // 统计数据
                this.stats = {
                    completedPomodoros: 0,
                    totalWorkTime: 0,
                    totalBreakTime: 0,
                    currentStreak: 0
                };

                this.initializeElements();
                this.loadSettings();
                this.loadStats();
                this.bindEvents();
                this.requestNotificationPermission();
                this.resetTimer();
            }

            initializeElements() {
                // 计时器和控制元素
                this.timerDisplay = document.getElementById('timerDisplay');
                this.statusText = document.getElementById('statusText');
                this.startBtn = document.getElementById('startBtn');
                this.pauseBtn = document.getElementById('pauseBtn');
                this.resetBtn = document.getElementById('resetBtn');
                this.skipBtn = document.getElementById('skipBtn');
                this.progressRing = document.querySelector('.progress-ring-fill');
                this.notification = document.getElementById('notification');
                
                // 设置输入框
                this.workTimeInput = document.getElementById('workTime');
                this.shortBreakInput = document.getElementById('shortBreak');
                this.longBreakInput = document.getElementById('longBreak');
                this.longBreakIntervalInput = document.getElementById('longBreakInterval');
                this.autoStartCheckbox = document.getElementById('autoStart');
                this.soundEnabledCheckbox = document.getElementById('soundEnabled');
                this.notificationEnabledCheckbox = document.getElementById('notificationEnabled');

                // 统计显示
                this.completedPomodorosEl = document.getElementById('completedPomodoros');
                this.totalWorkTimeEl = document.getElementById('totalWorkTime');
                this.totalBreakTimeEl = document.getElementById('totalBreakTime');
                this.currentStreakEl = document.getElementById('currentStreak');
            }

            bindEvents() {
                this.startBtn.addEventListener('click', () => this.startTimer());
                this.pauseBtn.addEventListener('click', () => this.pauseTimer());
                this.resetBtn.addEventListener('click', () => this.resetTimer());
                this.skipBtn.addEventListener('click', () => this.skipSession());

                // 设置切换
                document.getElementById('settingsToggle').addEventListener('click', () => {
                    const content = document.getElementById('settingsContent');
                    const arrow = document.getElementById('settingsArrow');
                    content.classList.toggle('show');
                    arrow.textContent = content.classList.contains('show') ? '▲' : '▼';
                });

                // 设置输入监听
                this.workTimeInput && this.workTimeInput.addEventListener('change', () => this.updateSettings());
                this.shortBreakInput && this.shortBreakInput.addEventListener('change', () => this.updateSettings());
                this.longBreakInput && this.longBreakInput.addEventListener('change', () => this.updateSettings());
                this.longBreakIntervalInput && this.longBreakIntervalInput.addEventListener('change', () => this.updateSettings());
                this.autoStartCheckbox && this.autoStartCheckbox.addEventListener('change', () => this.updateSettings());
                this.soundEnabledCheckbox && this.soundEnabledCheckbox.addEventListener('change', () => this.updateSettings());
                this.notificationEnabledCheckbox && this.notificationEnabledCheckbox.addEventListener('change', () => this.updateSettings());

                // 主题选择
                document.querySelectorAll('.theme-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.settings.theme = btn.dataset.theme;
                        this.applyTheme();
                        this.saveSettings();
                    });
                });

                // 键盘快捷键
                document.addEventListener('keydown', (e) => {
                    if (e.code === 'Space') {
                        e.preventDefault();
                        if (this.isRunning) {
                            this.pauseTimer();
                        } else {
                            this.startTimer();
                        }
                    } else if (e.code === 'KeyR') {
                        this.resetTimer();
                    } else if (e.code === 'KeyS') {
                        this.skipSession();
                    }
                });
            }

            updateSettings() {
                // 确保在更新前读取输入框的当前值
                if (this.workTimeInput) this.settings.workTime = parseInt(this.workTimeInput.value);
                if (this.shortBreakInput) this.settings.shortBreak = parseInt(this.shortBreakInput.value);
                if (this.longBreakInput) this.settings.longBreak = parseInt(this.longBreakInput.value);
                if (this.longBreakIntervalInput) this.settings.longBreakInterval = parseInt(this.longBreakIntervalInput.value);
                if (this.autoStartCheckbox) this.settings.autoStart = this.autoStartCheckbox.checked;
                if (this.soundEnabledCheckbox) this.settings.soundEnabled = this.soundEnabledCheckbox.checked;
                if (this.notificationEnabledCheckbox) this.settings.notificationEnabled = this.notificationEnabledCheckbox.checked;
                
                this.saveSettings();
                if (!this.isRunning) {
                    this.resetTimer();
                }
            }

            startTimer() {
                if (!this.isRunning) {
                    this.isRunning = true;
                    this.startBtn.textContent = '运行中';
                    this.startBtn.disabled = true;
                    
                    this.timer = setInterval(() => {
                        this.currentTime--;
                        this.updateDisplay();
                        this.updateProgress();
                        
                        if (this.currentTime <= 0) {
                            this.completeSession();
                        }
                    }, 1000);
                }
            }

            pauseTimer() {
                if (this.isRunning) {
                    this.isRunning = false;
                    this.startBtn.textContent = '继续';
                    this.startBtn.disabled = false;
                    clearInterval(this.timer);
                }
            }

            resetTimer() {
                this.pauseTimer();
                this.currentTime = this.getSessionDuration() * 60;
                this.updateDisplay();
                this.updateProgress();
                this.startBtn.textContent = '开始';
            }

            skipSession() {
                if (confirm('确定要跳过当前会话吗？')) {
                    this.completeSession();
                }
            }

            completeSession() {
                this.pauseTimer();
                this.playSound();
                this.showNotification();
                
                // 更新统计
                if (this.currentSession === 'work') {
                    this.completedPomodoros++;
                    this.stats.completedPomodoros++;
                    this.stats.totalWorkTime += this.settings.workTime;
                } else {
                    this.stats.totalBreakTime += (this.currentSession === 'shortBreak' ? this.settings.shortBreak : this.settings.longBreak);
                }
                
                this.updateStats();
                this.nextSession();
            }

            nextSession() {
                if (this.currentSession === 'work') {
                    if (this.completedPomodoros % this.settings.longBreakInterval === 0) {
                        this.currentSession = 'longBreak';
                    } else {
                        this.currentSession = 'shortBreak';
                    }
                } else {
                    this.currentSession = 'work';
                    if (this.currentSession === 'work') {
                        this.currentRound++;
                    }
                }
                
                this.resetTimer();
                this.updateStatus();
                
                if (this.settings.autoStart) {
                    // 延迟启动，让用户看到状态切换
                    setTimeout(() => this.startTimer(), 1000); 
                }
            }

            getSessionDuration() {
                switch (this.currentSession) {
                    case 'work': return this.settings.workTime;
                    case 'shortBreak': return this.settings.shortBreak;
                    case 'longBreak': return this.settings.longBreak;
                    default: return this.settings.workTime;
                }
            }

            updateDisplay() {
                const minutes = Math.floor(this.currentTime / 60);
                const seconds = this.currentTime % 60;
                this.timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // 更新页面标题
                document.title = `${this.timerDisplay.textContent} - 像素番茄钟`;
            }

            updateProgress() {
                const totalTime = this.getSessionDuration() * 60;
                const progress = (totalTime - this.currentTime) / totalTime;
                const circumference = 2 * Math.PI * 90;
                const offset = circumference * (1 - progress);
                this.progressRing.style.strokeDashoffset = offset;
            }

            updateStatus() {
                const statusTexts = {
                    work: '工作时间',
                    shortBreak: '短休息',
                    longBreak: '长休息'
                };
                
                const statusClasses = {
                    work: 'status-work',
                    shortBreak: 'status-break',
                    longBreak: 'status-long-break'
                };
                
                this.statusText.textContent = `${statusTexts[this.currentSession]} - 第${this.currentRound}轮`;
                this.statusText.className = `status-text ${statusClasses[this.currentSession]}`;
            }

            updateStats() {
                if (this.completedPomodorosEl) this.completedPomodorosEl.textContent = this.stats.completedPomodoros;
                if (this.totalWorkTimeEl) this.totalWorkTimeEl.textContent = this.stats.totalWorkTime;
                if (this.totalBreakTimeEl) this.totalBreakTimeEl.textContent = this.stats.totalBreakTime;
                if (this.currentStreakEl) this.currentStreakEl.textContent = this.stats.currentStreak;
                this.saveStats();
            }

            playSound() {
                if (this.settings.soundEnabled) {
                    try {
                        // 尝试使用 Web Audio API
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                        oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
                        oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.2);
                        
                        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                        
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.3);
                    } catch (e) {
                        console.warn("Web Audio API failed, trying fallback audio:", e);
                        // 简单的备用（如果浏览器环境不支持 AudioContext 或被用户阻止）
                        const audio = new Audio();
                        audio.src = 'data:audio/wav;base64,UklGRlYAAABXQVZFZm10IBAAAAABAAEAgD4AAAB9AAACABAAZGF0YQAAAAEAqF5dE04AAAAAA...' // 实际中需要一个有效的短提示音
                        audio.play().catch(err => console.error("Fallback audio failed:", err));
                    }
                }
            }

            showNotification() {
                const messages = {
                    work: '工作时间结束！该休息一下了 🎮',
                    shortBreak: '休息结束！继续加油工作 💪',
                    longBreak: '长休息结束！准备好新的挑战了吗？ 🚀'
                };
                
                // 页面内通知
                this.notification.textContent = messages[this.currentSession];
                this.notification.classList.add('show');
                setTimeout(() => {
                    this.notification.classList.remove('show');
                }, 3000);
                
                // 桌面通知
                if (this.settings.notificationEnabled && 'Notification' in window && Notification.permission === 'granted') {
                    new Notification('像素番茄钟', {
                        body: messages[this.currentSession],
                        icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjNjc1MEE0Ii8+CjxwYXRoIGQ9Ik0zMiA0OEM0MC44MzY2IDQ4IDQ4IDQwLjgzNjYgNDggMzJDNDggMjMuMTYzNCA0MC44MzY2IDE2IDMyIDE2QzIzLjE2MzQgMTYgMTYgMjMuMTYzNCAxNiAzMkMxNiA0MC44MzY2IDIzLjE2MzQgNDggMzIgNDhaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K'
                    });
                }
            }

            requestNotificationPermission() {
                if ('Notification' in window && Notification.permission === 'default') {
                    Notification.requestPermission();
                }
            }

            applyTheme() {
                const themes = {
                    default: { primary: '#6750A4', secondary: '#625B71' },
                    forest: { primary: '#2E7D32', secondary: '#1B5E20' },
                    sunset: { primary: '#F57C00', secondary: '#E65100' },
                    ocean: { primary: '#1976D2', secondary: '#0D47A1' }
                };
                
                const theme = themes[this.settings.theme] || themes.default; // 确保有默认值
                document.documentElement.style.setProperty('--primary', theme.primary);
                document.documentElement.style.setProperty('--secondary', theme.secondary);
            }

            saveSettings() {
                localStorage.setItem('pixelPomodoroSettings', JSON.stringify(this.settings));
            }

            loadSettings() {
                const saved = localStorage.getItem('pixelPomodoroSettings');
                if (saved) {
                    // 合并默认值和已保存的值，确保所有设置键都存在
                    this.settings = { ...this.settings, ...JSON.parse(saved) };
                }
                
                // 更新输入框和复选框（**这里加入了安全检查**）
                if (this.workTimeInput) this.workTimeInput.value = this.settings.workTime;
                if (this.shortBreakInput) this.shortBreakInput.value = this.settings.shortBreak;
                if (this.longBreakInput) this.longBreakInput.value = this.settings.longBreak;
                if (this.longBreakIntervalInput) this.longBreakIntervalInput.value = this.settings.longBreakInterval;
                if (this.autoStartCheckbox) this.autoStartCheckbox.checked = this.settings.autoStart;
                if (this.soundEnabledCheckbox) this.soundEnabledCheckbox.checked = this.settings.soundEnabled;
                if (this.notificationEnabledCheckbox) this.notificationEnabledCheckbox.checked = this.settings.notificationEnabled;
                
                this.applyTheme();
            }

            saveStats() {
                const today = new Date().toDateString();
                const savedStats = JSON.parse(localStorage.getItem('pixelPomodoroStats') || '{}');
                
                // 仅保存本次运行结束后的最新统计数据
                savedStats[today] = {
                    completedPomodoros: this.stats.completedPomodoros,
                    totalWorkTime: this.stats.totalWorkTime,
                    totalBreakTime: this.stats.totalBreakTime,
                    // 连续天数在加载时重新计算，不保存在每日记录中
                };
                localStorage.setItem('pixelPomodoroStats', JSON.stringify(savedStats));
            }

            loadStats() {
                const today = new Date().toDateString();
                const savedStatsAll = JSON.parse(localStorage.getItem('pixelPomodoroStats') || '{}');
                
                if (savedStatsAll[today]) {
                    // 恢复当日的统计值
                    this.stats = { ...this.stats, ...savedStatsAll[today] };
                }
                
                // 计算连续天数（从所有历史记录中计算）
                const dates = Object.keys(savedStatsAll).sort().reverse();
                let streak = 0;
                const todayTime = new Date(today).getTime();
                
                for (let i = 0; i < dates.length; i++) {
                    const currentDateStr = dates[i];
                    const currentStat = savedStatsAll[currentDateStr];
                    
                    const currentDayTime = new Date(currentDateStr).getTime();
                    
                    // 计算天数差
                    const daysDiff = Math.floor((todayTime - currentDayTime) / (1000 * 60 * 60 * 24));
                    
                    // 检查是否是昨天的或更早，并且当天有番茄完成
                    if (daysDiff === streak && currentStat.completedPomodoros > 0) {
                        streak++;
                    } else if (daysDiff === streak + 1 && currentStat.completedPomodoros > 0) {
                        // 确保昨天完成了才算连续
                        streak++;
                    } else if (daysDiff > streak) {
                        // 出现断层
                        break;
                    }
                }
                
                // 如果今天是第一天（i=0，daysDiff=0），并且完成了番茄，streak至少为1
                if (new Date(dates[0]).toDateString() === today && this.stats.completedPomodoros > 0) {
                     this.stats.currentStreak = streak;
                } else if (dates.length > 0 && new Date(dates[0]).toDateString() !== today && this.stats.completedPomodoros > 0) {
                     // 如果今天是新的一天，并且完成了工作，则至少为1
                     this.stats.currentStreak = 1;
                } else {
                     // 如果没有完成任何工作，或者今天不是历史记录的第一天，则重新计算
                    let calculatedStreak = 0;
                    let previousDate = new Date(todayTime);
                    previousDate.setDate(previousDate.getDate() - 1); // 从昨天开始检查
                    
                    for (let i = 0; i < dates.length; i++) {
                        const checkDateStr = previousDate.toDateString();
                        if (savedStatsAll[checkDateStr] && savedStatsAll[checkDateStr].completedPomodoros > 0) {
                            calculatedStreak++;
                            previousDate.setDate(previousDate.getDate() - 1);
                        } else {
                            break;
                        }
                    }
                    // 如果今天已经完成了，算上今天
                    if (this.stats.completedPomodoros > 0) {
                         this.stats.currentStreak = calculatedStreak + 1;
                    } else {
                         this.stats.currentStreak = calculatedStreak;
                    }
                }
                
                // 简化 streak 计算逻辑，确保今天完成的番茄计入（如果历史记录中有昨天的）
                let streakCount = 0;
                const sortedDates = Object.keys(savedStatsAll).sort((a, b) => new Date(b) - new Date(a));
                
                // 检查今天是否已完成
                if (new Date(sortedDates[0] || new Date().toDateString()).toDateString() === today && this.stats.completedPomodoros > 0) {
                    streakCount = 1;
                }

                for (let i = 1; i < sortedDates.length; i++) {
                    const prevDay = new Date(sortedDates[i-1]);
                    const currentDay = new Date(sortedDates[i]);
                    
                    // 检查日期是否连续 (差一天)
                    const diffTime = Math.abs(prevDay - currentDay);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    if (diffDays === 1 && savedStatsAll[sortedDates[i]].completedPomodoros > 0) {
                        streakCount++;
                    } else {
                        break;
                    }
                }
                
                // 最终修正：如果今天完成了，但历史记录中没有今天（因为是刚完成的），则至少为1
                if (this.stats.completedPomodoros > 0 && new Date(sortedDates[0] || new Date().toDateString()).toDateString() !== today) {
                    this.stats.currentStreak = 1;
                } else {
                    this.stats.currentStreak = streakCount;
                }

                this.updateStats();
            }
        }

        // 初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            new PixelPomodoro();
        });
    </script>
</body>
</html>