<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç•ªèŒ„é’Ÿ</title>
  <style>
    /* === åƒç´ é£æ ¼åŸºç¡€æ ·å¼ === */
    @font-face {
      font-family: 'Pixel';
      src: url('https://fonts.cdnfonts.com/css/pixel-arial') format('woff');
      font-weight: normal;
      font-style: normal;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Pixel', 'Courier New', monospace;
      background-color: #f0f9ff;
      color: #4a5568;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
      transition: background-color 0.4s ease, color 0.4s ease;
    }

    body.dark {
      background-color: #1a1a2e;
      color: #e6e6e6;
    }

    body.pink { background-color: #fff0f5; }
    body.green { background-color: #f0fff0; }
    body.purple { background-color: #f8f0ff; }

    /* === åƒç´ æŒ‰é’® === */
    .btn {
      background-color: #6b486b;
      color: white;
      border: none;
      padding: 12px 20px;
      margin: 10px;
      font-family: 'Pixel', monospace;
      font-size: 16px;
      cursor: pointer;
      border-radius: 4px;
      transition: transform 0.1s;
      box-shadow: 4px 4px 0 #4a304a;
    }

    .btn:active {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 #4a304a;
    }

    .btn:hover {
      background-color: #8b5a8b;
    }

    .btn.primary { background-color: #e76f51; }
    .btn.success { background-color: #2a9d8f; }
    .btn.warning { background-color: #e9c46a; }
    .btn.danger { background-color: #e63946; }

    body.dark .btn {
      box-shadow: 4px 4px 0 #b06b94;
    }

    body.dark .btn:hover {
      background-color: #d15a7c;
    }

    /* === ä¸»å®¹å™¨ === */
    .container {
      max-width: 800px;
      width: 100%;
      padding: 20px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      text-align: center;
      position: relative;
      margin-bottom: 20px;
    }

    body.dark .container {
      background: rgba(26, 26, 46, 0.8);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    /* === ç•ªèŒ„æ—¶é’Ÿä¸»ä½“ === */
    .timer-display {
      font-size: 6rem;
      font-weight: bold;
      margin: 20px 0;
      color: #e63946;
      text-shadow: 6px 6px 0 #ffe6e6;
    }

    body.dark .timer-display {
      color: #ff6b8b;
      text-shadow: 6px 6px 0 #4a1c2a;
    }

    .mode {
      font-size: 1.5rem;
      margin-bottom: 10px;
      color: #2a9d8f;
    }

    body.dark .mode {
      color: #6ee7b7;
    }

    /* === åƒç´ è¿›åº¦æ¡ === */
    .progress-container {
      width: 80%;
      margin: 20px auto;
      height: 20px;
      background: #ddd;
      border: 2px solid #999;
      border-radius: 0;
    }

    body.dark .progress-container {
      background: #333;
      border-color: #555;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background: #e76f51;
      transition: width 0.2s linear;
    }

    /* === æŒ‰é’®ç»„ === */
    .controls {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    /* === ç•ªèŒ„è®¡æ•°å™¨ === */
    .pomodoro-count {
      font-size: 1.2rem;
      margin: 10px 0;
      color: #c06c84;
    }

    body.dark .pomodoro-count {
      color: #f7a8b8;
    }

    /* === è®¾ç½®é¢æ¿ === */
    .settings {
      margin-top: 30px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 8px;
      display: none;
    }

    body.dark .settings {
      background: rgba(26, 26, 46, 0.6);
    }

    .settings h3 {
      margin-bottom: 15px;
      color: #555;
    }

    body.dark .settings h3 {
      color: #aaa;
    }

    .setting-row {
      display: flex;
      justify-content: space-between;
      margin: 10px 0;
      flex-wrap: wrap;
    }

    .setting-row label {
      margin-right: 10px;
      min-width: 120px;
    }

    .setting-row input, .setting-row select {
      padding: 5px;
      font-family: 'Pixel', monospace;
    }

    /* === ä¸»é¢˜åˆ‡æ¢å™¨ === */
    .theme-toggle {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 0.8rem;
      background: #eee;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }

    body.dark .theme-toggle {
      background: #444;
      color: white;
    }

    .color-themes {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      justify-content: center;
    }

    .color-dot {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid #999;
    }

    .color-dot.selected {
      border: 2px solid white;
      box-shadow: 0 0 0 2px black;
    }

    body.dark .color-dot {
      border-color: #aaa;
    }

    .dot-light { background: #f0f9ff; }
    .dot-dark { background: #1a1a2e; }
    .dot-pink { background: #fff0f5; }
    .dot-green { background: #f0fff0; }
    .dot-purple { background: #f8f0ff; }

    /* === åƒç´ ç•ªèŒ„è£…é¥° === */
    .tomato-art {
      position: absolute;
      font-size: 80px;
      animation: float 3s ease-in-out infinite;
      opacity: 0.2;
      z-index: -1;
    }

    .tomato-art.left { left: 5%; top: 30%; transform: rotate(-15deg); }
    .tomato-art.right { right: 5%; top: 40%; transform: rotate(15deg); }

    @keyframes float {
      0%, 100% { transform: translateY(0) rotate(15deg); }
      50% { transform: translateY(-15px) rotate(-15deg); }
    }

    /* === èŒç³»åƒç´ è§’è‰² === */
    .pixel-character {
      position: absolute;
      width: 60px;
      height: 60px;
      background: url('https://imgur.com/5yJzZJr.png') no-repeat; /* é€æ˜åƒç´ è§’è‰²å›¾ï¼ˆå°çŒ«ï¼‰ */
      background-size: contain;
      bottom: 20px;
      animation: walk 4s infinite alternate;
    }

    .pixel-character.left { left: 20px; transform: scaleX(-1); }
    .pixel-character.right { right: 20px; }

    @keyframes walk {
      0% { transform: translateX(0); }
      100% { transform: translateX(20px); }
    }

    /* === å“åº”å¼é€‚é… === */
    @media (max-width: 600px) {
      .timer-display {
        font-size: 4rem;
      }

      .btn {
        padding: 10px 16px;
        font-size: 14px;
      }

      .container {
        padding: 15px;
      }
    }

    /* === æç¤ºæ¡† === */
    .help-tip {
      font-size: 0.8rem;
      color: #666;
      margin-top: 10px;
    }

    body.dark .help-tip {
      color: #aaa;
    }
  </style>
</head>
<body>
  <div class="tomato-art left">ğŸ…</div>
  <div class="tomato-art right">ğŸ…</div>

  <div class="pixel-character left"></div>
  <div class="pixel-character right"></div>

  <div class="container">
    <div class="theme-toggle" onclick="toggleTheme()">ğŸŒ“ åˆ‡æ¢æš—è‰²</div>
    <div class="color-themes">
      <div class="color-dot dot-light selected" onclick="changeColorTheme('light')"></div>
      <div class="color-dot dot-pink" onclick="changeColorTheme('pink')"></div>
      <div class="color-dot dot-green" onclick="changeColorTheme('green')"></div>
      <div class="color-dot dot-purple" onclick="changeColorTheme('purple')"></div>
    </div>

    <h1>ç•ªèŒ„é’Ÿ</h1>
    <p class="mode">å·¥ä½œæ—¶é—´</p>
    <div class="timer-display">25:00</div>
    <div class="progress-container">
      <div class="progress-bar"></div>
    </div>
    <p class="pomodoro-count">ä»Šæ—¥å·²å®Œæˆ <strong id="count">0</strong> ä¸ªç•ªèŒ„</p>

    <div class="controls">
      <button id="startBtn" class="btn primary">â–¶ å¼€å§‹</button>
      <button id="skipBtn" class="btn warning">â­ è·³è¿‡</button>
      <button id="resetBtn" class="btn">âŸ² é‡ç½®</button>
      <button id="settingsBtn" class="btn">âš™ è®¾ç½®</button>
    </div>

    <div class="help-tip">å¿«æ·é”®ï¼šç©ºæ ¼=å¼€å§‹/æš‚åœï¼ŒR=é‡ç½®ï¼ŒS=è·³è¿‡</div>

    <div id="settingsPanel" class="settings">
      <h3>âš™ è®¾ç½®</h3>
      <div class="setting-row">
        <label>å·¥ä½œæ—¶é•¿ï¼ˆåˆ†ï¼‰</label>
        <input type="number" id="workTime" min="1" max="60" value="25"/>
      </div>
      <div class="setting-row">
        <label>çŸ­ä¼‘æ¯æ—¶é•¿ï¼ˆåˆ†ï¼‰</label>
        <input type="number" id="shortBreak" min="1" max="30" value="5"/>
      </div>
      <div class="setting-row">
        <label>é•¿ä¼‘æ¯æ—¶é•¿ï¼ˆåˆ†ï¼‰</label>
        <input type="number" id="longBreak" min="5" max="60" value="15"/>
      </div>
      <div class="setting-row">
        <label>è‡ªåŠ¨è·³è½¬ä¸‹ä¸€é˜¶æ®µ</label>
        <select id="autoNext">
          <option value="1">å¼€å¯</option>
          <option value="0">å…³é—­</option>
        </select>
      </div>
      <div class="setting-row">
        <label>æç¤ºéŸ³é‡</label>
        <input type="range" id="volume" min="0" max="1" step="0.1" value="0.5"/>
      </div>
      <button id="saveSettings" class="btn success">ä¿å­˜è®¾ç½®</button>
      <button id="closeSettings" class="btn">å…³é—­</button>
    </div>
  </div>

  <script>
    // ========= æ•°æ®ä¸çŠ¶æ€ =========
    const audioStart = new Audio("https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3");
    const audioEnd = new Audio("https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3");

    let workTime = 25;
    let shortBreakTime = 5;
    let longBreakTime = 15;
    let autoNext = true;
    let volume = 0.5;

    let currentMode = 'work'; // work, shortBreak, longBreak
    let timeLeft = workTime * 60;
    let timerRunning = false;
    let timerInterval = null;
    let pomodoroCount = 0;
    let cycles = 0; // æ¯4ä¸ªç•ªèŒ„åä¸€ä¸ªé•¿ä¼‘æ¯

    // ========= DOM å…ƒç´  =========
    const timerDisplay = document.querySelector('.timer-display');
    const modeText = document.querySelector('.mode');
    const progressBar = document.querySelector('.progress-bar');
    const startBtn = document.getElementById('startBtn');
    const skipBtn = document.getElementById('skipBtn');
    const resetBtn = document.getElementById('resetBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsPanel = document.getElementById('settingsPanel');
    const saveSettingsBtn = document.getElementById('saveSettings');
    const closeSettingsBtn = document.getElementById('closeSettings');
    const countDisplay = document.getElementById('count');

    // ========= æœ¬åœ°å­˜å‚¨è¯»å– =========
    function loadFromStorage() {
      const saved = JSON.parse(localStorage.getItem('pomodoroSettings'));
      if (saved) {
        workTime = saved.workTime || 25;
        shortBreakTime = saved.shortBreakTime || 5;
        longBreakTime = saved.longBreakTime || 15;
        autoNext = saved.autoNext !== undefined ? saved.autoNext : true;
        volume = saved.volume !== undefined ? saved.volume : 0.5;

        document.getElementById('workTime').value = workTime;
        document.getElementById('shortBreak').value = shortBreakTime;
        document.getElementById('longBreak').value = longBreakTime;
        document.getElementById('autoNext').value = autoNext ? "1" : "0";
        document.getElementById('volume').value = volume;
      }

      const stats = JSON.parse(localStorage.getItem('pomodoroStats')) || { count: 0, date: new Date().toISOString().split('T')[0] };
      const today = new Date().toISOString().split('T')[0];
      pomodoroCount = stats.date === today ? stats.count : 0;
      countDisplay.textContent = pomodoroCount;
    }

    function saveToStorage() {
      localStorage.setItem('pomodoroSettings', JSON.stringify({
        workTime,
        shortBreakTime,
        longBreakTime,
        autoNext,
        volume
      }));

      localStorage.setItem('pomodoroStats', JSON.stringify({
        count: pomodoroCount,
        date: new Date().toISOString().split('T')[0]
      }));
    }

    // ========= æ—¶é—´æ ¼å¼åŒ– =========
    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // ========= æ›´æ–°UI =========
    function updateDisplay() {
      timerDisplay.textContent = formatTime(timeLeft);
      document.title = `ç•ªèŒ„é’Ÿ - ${formatTime(timeLeft)}`;

      const total = currentMode === 'work' ? workTime * 60 :
                    currentMode === 'shortBreak' ? shortBreakTime * 60 : longBreakTime * 60;
      const percent = ((total - timeLeft) / total) * 100;
      progressBar.style.width = `${percent}%`;

      modeText.textContent = currentMode === 'work' ? 'å·¥ä½œæ—¶é—´' :
                             currentMode === 'shortBreak' ? 'çŸ­ä¼‘æ¯æ—¶é—´' : 'é•¿ä¼‘æ¯æ—¶é—´';
    }

    // ========= æ¨¡å¼åˆ‡æ¢ =========
    function changeMode(newMode) {
      currentMode = newMode;
      const duration = newMode === 'work' ? workTime * 60 :
                       newMode === 'shortBreak' ? shortBreakTime * 60 : longBreakTime * 60;
      timeLeft = duration;
      updateDisplay();
    }

    // ========= è®¡æ—¶å™¨é€»è¾‘ =========
    function startTimer() {
      if (timerRunning) return;
      timerRunning = true;
      startBtn.textContent = "â¸ æš‚åœ";
      audioStart.volume = volume;
      audioStart.play().catch(() => {});

      timerInterval = setInterval(() => {
        timeLeft--;
        updateDisplay();

        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          timerRunning = false;
          timerInterval = null;
          audioEnd.volume = volume;
          audioEnd.play().catch(() => {});

          if (currentMode === 'work') {
            pomodoroCount++;
            cycles++;
            countDisplay.textContent = pomodoroCount;
            saveToStorage(); // ä¿å­˜ç»Ÿè®¡æ•°æ®
          }

          if (currentMode === 'work' && cycles % 4 === 0) {
            changeMode('longBreak');
          } else if (currentMode === 'work') {
            changeMode('shortBreak');
          } else {
            changeMode('work');
          }

          startBtn.textContent = "â–¶ å¼€å§‹";

          if (autoNext) {
            startTimer();
          }
        }
      }, 1000);
    }

    function pauseTimer() {
      clearInterval(timerInterval);
      timerRunning = false;
      timerInterval = null;
      startBtn.textContent = "â–¶ å¼€å§‹";
    }

    function resetTimer() {
      pauseTimer();
      changeMode('work');
      document.title = "ç•ªèŒ„é’Ÿ";
    }

    function skipPhase() {
      pauseTimer();
      if (currentMode === 'work') {
        if (cycles % 4 === 0) {
          changeMode('longBreak');
        } else {
          changeMode('shortBreak');
        }
      } else {
        changeMode('work');
      }
      updateDisplay();
    }

    // ========= è®¾ç½®é¢æ¿ =========
    settingsBtn.addEventListener('click', () => {
      settingsPanel.style.display = 'block';
    });

    closeSettingsBtn.addEventListener('click', () => {
      settingsPanel.style.display = 'none';
    });

    saveSettingsBtn.addEventListener('click', () => {
      workTime = parseInt(document.getElementById('workTime').value) || 25;
      shortBreakTime = parseInt(document.getElementById('shortBreak').value) || 5;
      longBreakTime = parseInt(document.getElementById('longBreak').value) || 15;
      autoNext = document.getElementById('autoNext').value === "1";
      volume = parseFloat(document.getElementById('volume').value);

      // é‡ç½®å½“å‰è®¡æ—¶
      if (currentMode === 'work') timeLeft = workTime * 60;
      if (currentMode === 'shortBreak') timeLeft = shortBreakTime * 60;
      if (currentMode === 'longBreak') timeLeft = longBreakTime * 60;

      updateDisplay();
      saveToStorage();
      settingsPanel.style.display = 'none';
    });

    // ========= é”®ç›˜æ§åˆ¶ =========
    document.addEventListener('keydown', (e) => {
      if (e.key === ' ') {
        e.preventDefault();
        if (timerRunning) {
          pauseTimer();
        } else {
          startTimer();
        }
      } else if (e.key.toLowerCase() === 'r') {
        resetTimer();
      } else if (e.key.toLowerCase() === 's') {
        skipPhase();
      }
    });

    // ========= ä¸»é¢˜åˆ‡æ¢ =========
    function toggleTheme() {
      document.body.classList.toggle('dark');
      const themeBtn = document.querySelector('.theme-toggle');
      themeBtn.textContent = document.body.classList.contains('dark') 
        ? 'ğŸŒ åˆ‡æ¢æµ…è‰²' : 'ğŸŒ“ åˆ‡æ¢æš—è‰²';
    }

    function changeColorTheme(theme) {
      document.body.className = document.body.classList.contains('dark') ? 'dark' : '';
      document.body.classList.add(theme);
      document.querySelectorAll('.color-dot').forEach(dot => {
        dot.classList.remove('selected');
      });
      document.querySelector(`.dot-${theme}`).classList.add('selected');
    }

    // ========= åˆå§‹åŒ– =========
    loadFromStorage();
    updateDisplay();
    document.title = "ç•ªèŒ„é’Ÿ";

    // ========= äº‹ä»¶ç»‘å®š =========
    startBtn.addEventListener('click', () => {
      if (timerRunning) {
        pauseTimer();
      } else {
        startTimer();
      }
    });

    skipBtn.addEventListener('click', skipPhase);
    resetBtn.addEventListener('click', resetTimer);

    // å®šæœŸä¿å­˜ç»Ÿè®¡
    setInterval(saveToStorage, 30000);
  </script>
</body>
</html>