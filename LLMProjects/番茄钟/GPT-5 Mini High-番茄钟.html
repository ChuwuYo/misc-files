<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ç•ªèŒ„é’Ÿ</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#fff7fb;
    --card:#ffffff;
    --text:#232323;
    --muted:#d9d9e3;
    --accent:#ff6fa3; /* ä¸»è‰² */
    --accent2:#ffd0e6; /* æ¸å˜2 */
    --glass: rgba(255,255,255,0.6);
    --shadow: rgba(0,0,0,0.12);
    --success: #6ef1b0;
  }
  /* æš—è‰²ä¸»é¢˜è¦†ç›–ï¼ˆdata-theme="dark"ï¼‰ */
  body[data-theme="dark"]{
    --bg:#0b1220;
    --card:#0f1722;
    --text:#e6eef8;
    --muted:#213043;
    --accent:#ff7ab6;
    --accent2:#ffb6d7;
    --glass: rgba(255,255,255,0.02);
    --shadow: rgba(0,0,0,0.6);
    --success: #4bd99a;
  }
  /* å…¶å®ƒé…è‰²ï¼ˆæŒ‰ data-palette é€‰æ‹©ï¼‰ */
  body[data-palette="mint"]{
    --accent:#6ee9b2;
    --accent2:#b9ffe4;
    --bg:#f6fffb;
    --card:#ffffff;
  }
  body[data-palette="sky"]{
    --accent:#7ecbff;
    --accent2:#cfeaff;
    --bg:#f6fbff;
    --card:#ffffff;
  }

  html,body{
    height:100%;
    margin:0;
    font-family: "Press Start 2P", monospace;
    background: linear-gradient(180deg,var(--bg),#fff);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  .wrap{
    min-height:100vh;
    display:flex;
    flex-direction:column;
    align-items:center;
    padding:18px;
    gap:18px;
  }

  header{
    width:100%;
    max-width:1100px;
    display:flex;
    align-items:center;
    justify-content:space-between;
  }
  header h1{
    margin:0;
    font-size:20px;
    letter-spacing:1px;
    color:var(--text);
  }
  .top-right{
    display:flex;
    gap:10px;
    align-items:center;
    font-size:12px;
  }
  .badge{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:6px 10px;
    border:6px solid var(--accent);
    background:var(--card);
    color:var(--text);
    box-shadow: 6px 6px 0 var(--shadow);
    border-radius:6px;
  }
  .badge .dot{
    width:16px;height:16px;border-radius:4px;background:var(--accent);box-shadow:inset -2px -2px 0 rgba(255,255,255,0.2);
  }
  .layout{
    display:flex;
    gap:18px;
    width:100%;
    max-width:1100px;
    align-items:flex-start;
  }

  /* Timer Card */
  .card{
    background:linear-gradient(180deg,var(--card), rgba(255,255,255,0.6));
    border:8px solid var(--accent);
    box-shadow: 12px 12px 0 var(--shadow);
    padding:18px;
    border-radius:10px;
    flex:1;
    min-width:260px;
  }
  .timer-top{
    display:flex;
    gap:12px;
    align-items:center;
  }
  .hero{
    width:108px;
    height:108px;
    display:flex;
    align-items:center;
    justify-content:center;
    background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
    border-radius:8px;
    border:4px solid rgba(255,255,255,0.06);
    box-shadow: inset -6px -6px 0 rgba(0,0,0,0.02);
  }
  /* SVG pixel-art: Crisp */
  .hero svg{ width:80px;height:80px; image-rendering: pixelated; shape-rendering: crispEdges; }

  .timer-main{
    flex:1;
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .time{
    display:flex;
    align-items:center;
    justify-content:space-between;
  }
  .clock{
    font-size:46px;
    letter-spacing:2px;
    background: linear-gradient(90deg,var(--accent),var(--accent2));
    -webkit-background-clip:text;
    background-clip:text;
    color: transparent;
  }
  .stage{
    font-size:12px;
    padding:6px 10px;
    border-radius:6px;
    background:rgba(0,0,0,0.04);
    color:var(--text);
    border:4px solid rgba(0,0,0,0.04);
  }

  /* pixel progress (blocks) */
  .progress-grid{
    display:flex;
    gap:6px;
    align-items:center;
  }
  .progress-grid .block{
    flex:1 1 0;
    height:12px;
    background:var(--muted);
    box-shadow: inset 0 -2px 0 rgba(0,0,0,0.06);
  }
  .block.filled{
    background: linear-gradient(90deg,var(--accent),var(--accent2));
    box-shadow: 0 0 0 2px rgba(0,0,0,0.03) inset;
  }

  .controls{
    display:flex;
    gap:10px;
    margin-top:6px;
    flex-wrap:wrap;
  }
  .btn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    padding:10px 18px;
    background:var(--card);
    border:6px solid var(--accent);
    box-shadow:6px 6px 0 var(--shadow);
    cursor:pointer;
    user-select:none;
    font-size:12px;
    color:var(--text);
    border-radius:6px;
  }
  .btn:active{ transform:translate(3px,3px); box-shadow:3px 3px 0 var(--shadow); }
  .btn.secondary{
    border-color:var(--muted);
  }
  .toggles{
    display:flex;
    gap:8px;
    margin-top:8px;
    align-items:center;
  }
  .mini{
    font-size:11px;
    padding:6px 8px;
  }

  /* Settings */
  .settings{
    width:340px;
    min-width:240px;
    max-width:36%;
  }
  .settings .card{
    padding:12px;
  }
  .settings h3{ margin:0 0 8px 0; font-size:12px; }
  .field{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin:10px 0;
    font-size:11px;
  }
  .field input[type="number"]{
    width:80px;
    padding:8px;
    border-radius:6px;
    border:2px solid var(--muted);
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.01));
    font-family:inherit;
  }
  .field input[type="range"]{ width:140px; }
  .row{
    display:flex;
    gap:8px;
    align-items:center;
  }
  .palette-list{
    display:flex;
    gap:8px;
    margin-top:6px;
  }
  .palette{
    width:36px;height:36px;border-radius:6px;border:4px solid var(--muted);cursor:pointer;
  }

  footer{
    width:100%;
    max-width:1100px;
    display:flex;
    justify-content:space-between;
    font-size:12px;
  }

  /* responsive */
  @media (max-width:900px){
    .layout{ flex-direction:column; align-items:stretch; }
    .settings{ width:100%; max-width:900px; }
  }
  @media (max-width:480px){
    .clock{ font-size:32px; }
    .hero{ width:88px;height:88px; }
  }

  /* small helper */
  .muted{ opacity:0.7; font-size:11px; }
  .ghost{ opacity:0.6; font-size:11px; }
</style>
</head>
<body data-theme="light" data-palette="candy">
  <div class="wrap">
    <header>
      <h1>ç•ªèŒ„é’Ÿ</h1>
      <div class="top-right">
        <div class="badge" title="ä»Šå¤©å®Œæˆçš„ç•ªèŒ„æ•°">
          <div class="dot">ğŸ…</div>
          <div id="dailyCount">0</div>
        </div>
        <div class="ghost">å¿«æ·ï¼šç©ºæ ¼ å¼€å§‹/æš‚åœ â€¢ R é‡ç½® â€¢ S è·³è¿‡</div>
      </div>
    </header>

    <div class="layout">
      <!-- Timer Card -->
      <section class="card">
        <div class="timer-top">
          <div class="hero" id="hero">
            <!-- åµŒå…¥ç®€å•åƒç´ é£ SVG è§’è‰²ï¼ˆä¸¤ç§é¢œè‰²å¯åˆ‡æ¢ï¼‰ -->
            <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" id="svgHero">
              <!-- èƒŒæ™¯æ–¹å—ï¼ˆåƒç´ é£ï¼‰ -->
              <rect width="16" height="16" fill="transparent"></rect>
              <!-- å¤´å‘ -->
              <g id="heroWork" opacity="1">
                <rect x="3" y="1" width="10" height="2" fill="#3d2b49"></rect>
                <rect x="2" y="3" width="12" height="2" fill="#3d2b49"></rect>
                <rect x="2" y="5" width="12" height="2" fill="#f7c6d9"></rect>
                <rect x="5" y="7" width="6" height="6" fill="#c87aa3"></rect>
                <rect x="4" y="8" width="1" height="1" fill="#000"></rect>
                <rect x="11" y="8" width="1" height="1" fill="#000"></rect>
                <rect x="2" y="12" width="12" height="2" fill="#2c2c2c"></rect>
              </g>
              <g id="heroBreak" opacity="0">
                <rect x="3" y="1" width="10" height="2" fill="#274b3f"></rect>
                <rect x="2" y="3" width="12" height="2" fill="#274b3f"></rect>
                <rect x="2" y="5" width="12" height="2" fill="#fff3b0"></rect>
                <rect x="5" y="7" width="6" height="6" fill="#7cd3a5"></rect>
                <rect x="4" y="8" width="1" height="1" fill="#000"></rect>
                <rect x="11" y="8" width="1" height="1" fill="#000"></rect>
                <rect x="2" y="12" width="12" height="2" fill="#2c2c2c"></rect>
              </g>
            </svg>
          </div>
          <div class="timer-main">
            <div class="time">
              <div class="clock" id="timeDisplay">25:00</div>
              <div class="stage" id="stageLabel">å·¥ä½œ</div>
            </div>
            <div class="progress-grid" id="progressGrid" aria-hidden="true"></div>

            <div class="controls">
              <button class="btn" id="btnStart" aria-label="å¼€å§‹/æš‚åœ">â–¶ å¼€å§‹</button>
              <button class="btn secondary" id="btnReset" aria-label="é‡ç½®">âŸ³ é‡ç½®</button>
              <button class="btn secondary" id="btnSkip" aria-label="è·³è¿‡">â­ è·³è¿‡</button>

              <div style="flex:1"></div>

              <button class="btn mini" id="btnSound" aria-pressed="true">ğŸ”” éŸ³æ•ˆ</button>
              <button class="btn mini" id="btnAutoPlay" aria-pressed="true">â–¶ è‡ªåŠ¨</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Settings -->
      <aside class="settings">
        <div class="card">
          <h3>è®¾ç½®</h3>

          <div class="field">
            <div>å·¥ä½œï¼ˆåˆ†é’Ÿï¼‰</div>
            <input type="number" id="inputWork" min="1" value="25">
          </div>

          <div class="field">
            <div>çŸ­ä¼‘ï¼ˆåˆ†é’Ÿï¼‰</div>
            <input type="number" id="inputShort" min="1" value="5">
          </div>

          <div class="field">
            <div>é•¿ä¼‘ï¼ˆåˆ†é’Ÿï¼‰</div>
            <input type="number" id="inputLong" min="1" value="15">
          </div>

          <div class="field">
            <div>æ¯éš”å‡ æ¬¡å·¥ä½œåé•¿ä¼‘</div>
            <input type="number" id="inputLongEvery" min="1" value="4">
          </div>

          <div class="field">
            <div>éŸ³é‡</div>
            <input type="range" id="inputVolume" min="0" max="100" value="60">
          </div>

          <div class="field">
            <div>æé†’ï¼ˆæå‰ç§’ï¼‰</div>
            <input type="number" id="inputRemindBefore" min="5" value="60">
          </div>

          <div class="field">
            <div>å¼€å¯æé†’</div>
            <input type="checkbox" id="inputRemindOn" checked>
          </div>

          <div class="field">
            <div>å¼€å¯éŸ³æ•ˆ</div>
            <input type="checkbox" id="inputSoundOn" checked>
          </div>

          <div class="field">
            <div>è‡ªåŠ¨æ’­æ”¾ä¸‹ä¸ªæ—¶æ®µ</div>
            <input type="checkbox" id="inputAutoPlay" checked>
          </div>

          <div style="margin-top:10px;" class="muted">ä¸»é¢˜è‰²</div>
          <div class="palette-list">
            <div class="palette" data-palette="candy" title="ç³–æœç²‰" style="background:linear-gradient(180deg,#ffb6d2,#ffdceb);"></div>
            <div class="palette" data-palette="mint" title="è–„è·ç»¿" style="background:linear-gradient(180deg,#a8f6cf,#b8ffea);"></div>
            <div class="palette" data-palette="sky" title="å¤©è“" style="background:linear-gradient(180deg,#bfe9ff,#dff6ff);"></div>
          </div>

          <div style="margin-top:14px;display:flex;gap:8px;">
            <button class="btn" id="btnResetStats">â— é‡ç½®ç»Ÿè®¡</button>
            <button class="btn secondary" id="btnDefaults">âš™ æ¢å¤é»˜è®¤</button>
          </div>
          <div style="margin-top:8px;" class="muted">ï¼ˆè®¾ç½®ä¼šè‡ªåŠ¨ä¿å­˜ï¼‰</div>
        </div>
      </aside>
    </div>

    <footer>
      <div class="muted">ç©ºæ ¼ï¼šå¼€å§‹/æš‚åœ â€¢ Rï¼šé‡ç½® â€¢ Sï¼šè·³è¿‡</div>
      <div class="muted">é¡µé¢æ ‡é¢˜è¿è¡Œä¸­ä¼šæ˜¾ç¤ºå‰©ä½™æ—¶é—´</div>
    </footer>
  </div>

<script>
(function(){
  // é»˜è®¤è®¾ç½®
  const DEFAULTS = {
    workMin:25,
    shortMin:5,
    longMin:15,
    longEvery:4,
    autoPlay:true,
    soundOn:true,
    volume:0.6, // 0..1
    remindOn:true,
    remindBefore:60,
    palette:'candy',
    theme:'light'
  };
  const STORAGE_KEYS = {
    settings: 'pomo_settings_v1',
    stats: 'pomo_stats_v1'
  };

  // DOM
  const el = {
    timeDisplay: document.getElementById('timeDisplay'),
    stageLabel: document.getElementById('stageLabel'),
    progressGrid: document.getElementById('progressGrid'),
    btnStart: document.getElementById('btnStart'),
    btnReset: document.getElementById('btnReset'),
    btnSkip: document.getElementById('btnSkip'),
    btnSound: document.getElementById('btnSound'),
    btnAuto: document.getElementById('btnAutoPlay'),
    dailyCount: document.getElementById('dailyCount'),
    hero: document.getElementById('hero'),
    svgHero: document.getElementById('svgHero'),
    // settings
    inputWork: document.getElementById('inputWork'),
    inputShort: document.getElementById('inputShort'),
    inputLong: document.getElementById('inputLong'),
    inputLongEvery: document.getElementById('inputLongEvery'),
    inputVolume: document.getElementById('inputVolume'),
    inputRemindBefore: document.getElementById('inputRemindBefore'),
    inputRemindOn: document.getElementById('inputRemindOn'),
    inputSoundOn: document.getElementById('inputSoundOn'),
    inputAutoPlay: document.getElementById('inputAutoPlay'),
    palettes: document.querySelectorAll('.palette'),
    btnResetStats: document.getElementById('btnResetStats'),
    btnDefaults: document.getElementById('btnDefaults')
  };

  // state
  let settings = loadSettings();
  let stats = loadStats();
  let audioCtx = null;
  let isRunning = false;
  let currentStage = 'work'; // work / short / long
  let endTime = 0;
  let remainingMs = msForStage('work');
  let rafId = null;
  let cycleWork = 0; // completed work sessions since last long break
  let reminded = false;
  let blocksCount = calcBlocksCount();

  // stage labels
  const STAGE_LABEL = { work:'å·¥ä½œ', short:'çŸ­ä¼‘', long:'é•¿ä¼‘' };

  // åˆå§‹åŒ– UI ä¸äº‹ä»¶
  function init(){
    applySettingsToUI();
    applyPalette(settings.palette);
    applyTheme(settings.theme);
    createBlocks(blocksCount);
    updateDailyUI();
    updateUI();

    // events
    el.btnStart.addEventListener('click', toggleStartPause);
    el.btnReset.addEventListener('click', resetStage);
    el.btnSkip.addEventListener('click', skipStage);
    el.btnSound.addEventListener('click', ()=>{
      settings.soundOn = !settings.soundOn;
      el.inputSoundOn.checked = settings.soundOn;
      saveSettings();
      updateSoundButton();
    });
    el.btnAuto.addEventListener('click', ()=>{
      settings.autoPlay = !settings.autoPlay;
      el.inputAutoPlay.checked = settings.autoPlay;
      saveSettings();
      updateAutoButton();
    });

    // settings inputs -> auto save
    el.inputWork.addEventListener('change', onSettingChange);
    el.inputShort.addEventListener('change', onSettingChange);
    el.inputLong.addEventListener('change', onSettingChange);
    el.inputLongEvery.addEventListener('change', onSettingChange);
    el.inputVolume.addEventListener('input', onSettingChange);
    el.inputRemindBefore.addEventListener('change', onSettingChange);
    el.inputRemindOn.addEventListener('change', onSettingChange);
    el.inputSoundOn.addEventListener('change', onSettingChange);
    el.inputAutoPlay.addEventListener('change', onSettingChange);

    el.btnResetStats.addEventListener('click', ()=>{
      if(confirm('é‡ç½®ä»Šå¤©çš„å®Œæˆè®¡æ•°ï¼Ÿ')){
        stats = { date: todayStr(), count:0 };
        saveStats();
        updateDailyUI();
      }
    });
    el.btnDefaults.addEventListener('click', ()=>{
      if(confirm('æ¢å¤é»˜è®¤è®¾ç½®ï¼Ÿ')){
        settings = {...DEFAULTS};
        saveSettings();
        applySettingsToUI();
        applyPalette(settings.palette);
        applyTheme(settings.theme);
        remainingMs = msForStage(currentStage);
        updateUI();
      }
    });

    el.palettes.forEach(p=>{
      p.addEventListener('click', ()=>{
        const palette = p.getAttribute('data-palette');
        settings.palette = palette;
        saveSettings();
        applyPalette(palette);
      });
    });

    // keyboard shortcuts
    window.addEventListener('keydown', (e)=>{
      if(e.code === 'Space'){
        e.preventDefault();
        toggleStartPause();
      } else if(e.key === 'r' || e.key === 'R'){
        resetStage();
      } else if(e.key === 's' || e.key === 'S'){
        skipStage();
      }
    });

    // responsive blocks adjust
    window.addEventListener('resize', ()=>{
      const newCount = calcBlocksCount();
      if(newCount !== blocksCount){
        blocksCount = newCount;
        createBlocks(blocksCount);
        updateProgress();
      }
    });

    // åˆæ¬¡æ¸²æŸ“
    updateSoundButton();
    updateAutoButton();
  }

  // SETTINGS / STATS storage
  function loadSettings(){
    try{
      const raw = localStorage.getItem(STORAGE_KEYS.settings);
      if(raw) {
        const parsed = JSON.parse(raw);
        return Object.assign({}, DEFAULTS, parsed);
      }
    }catch(e){}
    return Object.assign({}, DEFAULTS);
  }
  function saveSettings(){
    try{ localStorage.setItem(STORAGE_KEYS.settings, JSON.stringify(settings)); }catch(e){}
  }
  function loadStats(){
    try{
      const raw = localStorage.getItem(STORAGE_KEYS.stats);
      const today = todayStr();
      if(raw){
        const s = JSON.parse(raw);
        if(s.date === today) return s;
      }
    }catch(e){}
    return { date: todayStr(), count: 0 };
  }
  function saveStats(){
    try{ localStorage.setItem(STORAGE_KEYS.stats, JSON.stringify(stats)); }catch(e){}
  }
  function todayStr(){
    return (new Date()).toISOString().slice(0,10);
  }

  // UI helpers
  function applySettingsToUI(){
    el.inputWork.value = settings.workMin;
    el.inputShort.value = settings.shortMin;
    el.inputLong.value = settings.longMin;
    el.inputLongEvery.value = settings.longEvery;
    el.inputVolume.value = Math.round(settings.volume * 100);
    el.inputRemindBefore.value = settings.remindBefore;
    el.inputRemindOn.checked = !!settings.remindOn;
    el.inputSoundOn.checked = !!settings.soundOn;
    el.inputAutoPlay.checked = !!settings.autoPlay;
    // palette
    document.body.setAttribute('data-palette', settings.palette || 'candy');
    document.body.setAttribute('data-theme', settings.theme || 'light');
  }
  function applyPalette(p){
    document.body.setAttribute('data-palette', p || 'candy');
  }
  function applyTheme(t){
    document.body.setAttribute('data-theme', t || 'light');
  }
  function updateDailyUI(){
    el.dailyCount.textContent = stats.count || 0;
  }
  function updateSoundButton(){
    el.btnSound.style.opacity = settings.soundOn ? '1' : '0.5';
    el.btnSound.setAttribute('aria-pressed', settings.soundOn ? 'true' : 'false');
  }
  function updateAutoButton(){
    el.btnAuto.style.opacity = settings.autoPlay ? '1' : '0.5';
    el.btnAuto.setAttribute('aria-pressed', settings.autoPlay ? 'true' : 'false');
  }

  function onSettingChange(){
    settings.workMin = parseInt(el.inputWork.value) || DEFAULTS.workMin;
    settings.shortMin = parseInt(el.inputShort.value) || DEFAULTS.shortMin;
    settings.longMin = parseInt(el.inputLong.value) || DEFAULTS.longMin;
    settings.longEvery = parseInt(el.inputLongEvery.value) || DEFAULTS.longEvery;
    settings.volume = Math.max(0, Math.min(1, (parseInt(el.inputVolume.value)||60) / 100));
    settings.remindBefore = Math.max(5, parseInt(el.inputRemindBefore.value) || 60);
    settings.remindOn = !!el.inputRemindOn.checked;
    settings.soundOn = !!el.inputSoundOn.checked;
    settings.autoPlay = !!el.inputAutoPlay.checked;
    saveSettings();
    // å¦‚æœå½“å‰ä¸åœ¨è¿è¡Œï¼Œè°ƒæ•´ remaining åˆ°æ–°çš„é˜¶æ®µæ—¶é•¿
    if(!isRunning){
      remainingMs = msForStage(currentStage);
    }
    updateUI();
    updateSoundButton();
    updateAutoButton();
  }

  // æ—¶é—´/è®¡æ—¶å‡½æ•°
  function msForStage(stage){
    if(stage === 'work') return (settings.workMin || DEFAULTS.workMin) * 60 * 1000;
    if(stage === 'short') return (settings.shortMin || DEFAULTS.shortMin) * 60 * 1000;
    return (settings.longMin || DEFAULTS.longMin) * 60 * 1000;
  }
  function formatTime(ms){
    if(ms < 0) ms = 0;
    const total = Math.ceil(ms / 1000);
    const mm = Math.floor(total / 60);
    const ss = total % 60;
    return String(mm).padStart(2,'0') + ':' + String(ss).padStart(2,'0');
  }

  function updateUI(){
    el.timeDisplay.textContent = formatTime(remainingMs);
    el.stageLabel.textContent = STAGE_LABEL[currentStage] || currentStage;
    updateTitle();
    updateProgress();
    updateHero();
    updateButtons();
  }
  function updateTitle(){
    if(isRunning){
      document.title = formatTime(remainingMs) + ' ç•ªèŒ„é’Ÿ';
    }else{
      document.title = 'ç•ªèŒ„é’Ÿ';
    }
  }
  function updateButtons(){
    if(isRunning){
      el.btnStart.textContent = 'â–®â–® æš‚åœ';
    }else{
      el.btnStart.textContent = 'â–¶ å¼€å§‹';
    }
  }

  // progress blocks
  function calcBlocksCount(){
    const w = window.innerWidth;
    if(w < 480) return 20;
    if(w < 800) return 30;
    return 40;
  }
  function createBlocks(count){
    el.progressGrid.innerHTML = '';
    for(let i=0;i<count;i++){
      const b = document.createElement('div');
      b.className = 'block';
      el.progressGrid.appendChild(b);
    }
  }
  function updateProgress(){
    const grid = el.progressGrid;
    const blocks = grid.querySelectorAll('.block');
    const total = blocks.length || 1;
    const full = msForStage(currentStage);
    const filled = Math.round( ((full - remainingMs) / full) * total );
    blocks.forEach((b, idx)=>{
      if(idx < filled) b.classList.add('filled'); else b.classList.remove('filled');
      // stage color hint
      if(currentStage === 'work'){
        b.style.background = b.classList.contains('filled') ? 'linear-gradient(90deg,var(--accent),var(--accent2))' : 'var(--muted)';
      }else{
        b.style.background = b.classList.contains('filled') ? 'linear-gradient(90deg,var(--success),#b9ffc9)' : 'var(--muted)';
      }
    });
  }

  // Hero update (åˆ‡æ¢é¢œè‰²/è¡¨æƒ…)
  function updateHero(){
    const workGroup = el.svgHero.querySelector('#heroWork');
    const breakGroup = el.svgHero.querySelector('#heroBreak');
    if(currentStage === 'work'){
      if(workGroup) workGroup.setAttribute('opacity','1');
      if(breakGroup) breakGroup.setAttribute('opacity','0');
      // running åŠ¨ç”»ï¼ˆæŠ–åŠ¨ï¼‰
      if(isRunning) el.hero.style.transform = 'translateY(-2px)';
      else el.hero.style.transform = 'translateY(0)';
    } else {
      if(workGroup) workGroup.setAttribute('opacity','0');
      if(breakGroup) breakGroup.setAttribute('opacity','1');
      if(isRunning) el.hero.style.transform = 'translateY(-2px) rotate(-2deg)';
      else el.hero.style.transform = 'translateY(0)';
    }
  }

  // Start / Pause / Reset / Skip
  function toggleStartPause(){
    if(isRunning) pauseTimer();
    else startTimer();
  }
  function startTimer(){
    // åˆ›å»º AudioContextï¼ˆå»¶è¿Ÿåˆ›å»ºï¼Œé¿å…æµè§ˆå™¨æƒé™é—®é¢˜ï¼‰
    if(!audioCtx && settings.soundOn){
      try{ audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }catch(e){ audioCtx = null; }
    }
    if(remainingMs <= 0) remainingMs = msForStage(currentStage);
    endTime = Date.now() + remainingMs;
    isRunning = true;
    reminded = false;
    rafId = requestAnimationFrame(tick);
    if(settings.soundOn) playStartSound();
    updateUI();
  }
  function pauseTimer(){
    isRunning = false;
    remainingMs = Math.max(0, endTime - Date.now());
    if(rafId) cancelAnimationFrame(rafId);
    rafId = null;
    updateUI();
  }
  function resetStage(){
    if(confirm('é‡ç½®å½“å‰æ—¶æ®µè®¡æ—¶ï¼Ÿ')){
      isRunning = false;
      remainingMs = msForStage(currentStage);
      if(rafId) cancelAnimationFrame(rafId);
      rafId = null;
      updateUI();
    }
  }
  function skipStage(){
    // è·³è¿‡å½“å‰é˜¶æ®µï¼Œä¸è®¡ä¸ºå®Œæˆ
    finishStage(false);
  }

  // è®¡æ—¶å¾ªç¯ tick
  function tick(){
    const now = Date.now();
    remainingMs = Math.max(0, endTime - now);
    // æé†’é€»è¾‘ï¼ˆå·¥ä½œé˜¶æ®µï¼‰
    if(currentStage === 'work' && settings.remindOn && !reminded && remainingMs <= (settings.remindBefore * 1000)){
      reminded = true;
      if(settings.soundOn) playReminderSound();
    }
    updateUI();
    if(remainingMs <= 0){
      finishStage(true);
      return;
    }
    rafId = requestAnimationFrame(tick);
  }

  function finishStage(triggeredNaturally){
    // triggeredNaturally true => åˆ°æœŸå®Œæˆï¼›false => è·³è¿‡
    // å¦‚æœæ˜¯ work ä¸”è‡ªç„¶å®Œæˆ -> è®¡å…¥ç»Ÿè®¡
    if(currentStage === 'work' && triggeredNaturally){
      stats.count = (stats.count||0) + 1;
      stats.date = todayStr();
      saveStats();
      updateDailyUI();
      cycleWork++;
    } else if(currentStage === 'work' && !triggeredNaturally){
      // è·³è¿‡ work ä¸è®¡å…¥å®Œæˆï¼Œä½†ä¹Ÿç»Ÿè®¡ä¸ºéå®Œæˆï¼ˆcycle ä¸å¢åŠ ï¼‰
    } else {
      // å¦‚æœå½“å‰ä¸º short æˆ– long -> ä¸æ”¹å˜ stats
    }

    // è®¡ç®—ä¸‹ä¸€ä¸ªé˜¶æ®µ
    let nextStage = 'work';
    if(currentStage === 'work'){
      if(cycleWork >= (settings.longEvery || DEFAULTS.longEvery)){
        nextStage = 'long';
        cycleWork = 0;
      } else {
        nextStage = 'short';
      }
    } else {
      nextStage = 'work';
    }

    // åˆ‡æ¢
    currentStage = nextStage;
    remainingMs = msForStage(currentStage);
    isRunning = false;
    if(rafId) cancelAnimationFrame(rafId);
    rafId = null;
    updateUI();

    // æ’­æ”¾ç»“æŸå£°éŸ³
    if(triggeredNaturally && settings.soundOn) playEndSound();

    // è‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€ä¸ªæ—¶æ®µï¼Ÿ
    if(settings.autoPlay && triggeredNaturally){
      // å»¶è¿Ÿä¸€ç‚¹ç‚¹å† startï¼ˆäº§ç”Ÿå‘¼å¸æ„Ÿï¼‰
      setTimeout(()=>{ startTimer(); }, 600);
    }
  }

  // Audio: WebAudio ç”ŸæˆéŸ³
  function ensureAudio(){
    if(!audioCtx){
      try{ audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }catch(e){ audioCtx = null; }
    }
    if(audioCtx && audioCtx.state === 'suspended'){
      audioCtx.resume && audioCtx.resume();
    }
  }
  function playTone(freq, duration = 120, type='sine'){
    if(!settings.soundOn) return;
    ensureAudio();
    if(!audioCtx) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type;
    o.frequency.value = freq;
    g.gain.value = settings.volume;
    o.connect(g);
    g.connect(audioCtx.destination);
    const now = audioCtx.currentTime;
    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(settings.volume, now + 0.01);
    o.start(now);
    o.stop(now + duration/1000);
    g.gain.exponentialRampToValueAtTime(0.0001, now + duration/1000);
  }

  function playStartSound(){
    if(!settings.soundOn) return;
    playTone(880,80,'sine');
    setTimeout(()=>playTone(660,90,'sine'), 110);
  }
  function playEndSound(){
    if(!settings.soundOn) return;
    playTone(1100,100,'sine');
    setTimeout(()=>playTone(900,120,'sine'), 120);
    setTimeout(()=>playTone(700,160,'sine'), 260);
  }
  function playReminderSound(){
    if(!settings.soundOn) return;
    playTone(1000,120,'square');
    setTimeout(()=>playTone(1200,80,'square'), 140);
  }

  // helpers
  function updateTitle(){
    if(isRunning){
      document.title = formatTime(remainingMs) + ' ç•ªèŒ„é’Ÿ';
    }else{
      document.title = 'ç•ªèŒ„é’Ÿ';
    }
  }

  // åˆå§‹åŒ– run
  // è¯»å– settings -> ms -> set UI
  remainingMs = msForStage(currentStage);
  init();

})();
</script>
</body>
</html>