<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>番茄钟</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // 像素粉主题
                        pixelPink: {
                            light: '#FFEEF2',
                            DEFAULT: '#FFB6C1',
                            dark: '#FF69B4',
                            darker: '#DB7093',
                            border: '#FF1493',
                            shadow: '#D4889A'
                        },
                        // 像素蓝主题
                        pixelBlue: {
                            light: '#E6F2FF',
                            DEFAULT: '#80BFFF',
                            dark: '#4DA6FF',
                            darker: '#0066CC',
                            border: '#1A8CFF',
                            shadow: '#66A3E0'
                        },
                        // 像素绿主题
                        pixelGreen: {
                            light: '#E6FFEE',
                            DEFAULT: '#80FFAA',
                            dark: '#4DFF88',
                            darker: '#00CC52',
                            border: '#1AFF66',
                            shadow: '#66D999'
                        },
                        // 暗色模式
                        pixelDark: {
                            light: '#1A1A2E',
                            DEFAULT: '#16213E',
                            dark: '#0F3460',
                            darker: '#533483',
                            border: '#E94560',
                            shadow: '#4A2532'
                        }
                    },
                    fontFamily: {
                        pixel: ['"Press Start 2P"', 'monospace'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .pixel-border {
                box-shadow: 4px 0 0 0 theme('colors.border'), 
                           -4px 0 0 0 theme('colors.border'), 
                           0 4px 0 0 theme('colors.border'), 
                           0 -4px 0 0 theme('colors.border');
            }
            .pixel-button {
                position: relative;
                transition: transform 0.1s ease;
            }
            .pixel-button:active {
                transform: translateY(2px);
            }
            .pixel-button::after {
                content: '';
                position: absolute;
                bottom: -4px;
                right: -4px;
                width: 100%;
                height: 100%;
                background-color: theme('colors.shadow');
                z-index: -1;
                transition: transform 0.1s ease;
            }
            .pixel-button:active::after {
                transform: translateY(-2px) translateX(2px);
            }
            .pixel-progress {
                image-rendering: pixelated;
                transition: width 1s linear;
            }
            .character-bounce {
                animation: bounce 2s infinite;
            }
            @keyframes bounce {
                0%, 100% { transform: translateY(0); }
                50% { transform: translateY(-10px); }
            }
            .pulse-pixel {
                animation: pulse 1s infinite;
            }
            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.7; }
            }
            .confetti {
                position: absolute;
                width: 10px;
                height: 10px;
                background-color: currentColor;
                animation: confetti-fall 3s linear forwards;
            }
            @keyframes confetti-fall {
                0% { transform: translateY(-10px) rotate(0deg); opacity: 1; }
                100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
            }
            .pixel-corners {
                clip-path: polygon(
                    0% 4px, 4px 4px, 4px 0%, calc(100% - 4px) 0%, calc(100% - 4px) 4px, 
                    100% 4px, 100% calc(100% - 4px), calc(100% - 4px) calc(100% - 4px), 
                    calc(100% - 4px) 100%, 4px 100%, 4px calc(100% - 4px), 0% calc(100% - 4px)
                );
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 transition-colors duration-300 bg-pixelPink-light text-gray-800" id="app-body">
    <!-- 音效元素 -->
    <audio id="sound-start" preload="auto">
        <source src="data:audio/wav;base64,UklGRigBAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQBAADpAFgA7wD/AP8A+wD/AAAAAAD/AAAAAP/9//3/AAAAAP/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//" type="audio/wav">
    </audio>
    <audio id="sound-complete" preload="auto">
        <source src="data:audio/wav;base64,UklGRigBAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQBAAD/AP8A+wD/AAAAAAD/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//" type="audio/wav">
    </audio>
    <audio id="sound-alert" preload="auto">
        <source src="data:audio/wav;base64,UklGRigBAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQBAADpAFgA7wD/AP8A+wD/AAAAAAD/AAAAAP/9//3/AAAAAP/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//P/9//3/8wD//" type="audio/wav">
    </audio>

    <div class="w-full max-w-md mx-auto flex flex-col items-center">
        <!-- 标题和设置按钮 -->
        <div class="w-full flex justify-between items-center mb-6">
            <h1 class="font-pixel text-2xl md:text-3xl text-pixelPink-dark">番茄钟</h1>
            <button id="settings-btn" class="pixel-button bg-pixelPink text-pixelPink-border px-3 py-2 font-pixel text-sm pixel-border pixel-corners">
                <i class="fa fa-cog"></i>
            </button>
        </div>

        <!-- 二次元像素角色 -->
        <div class="mb-4 character-bounce">
            <pre class="text-4xl md:text-5xl">
 /\_/\
( o.o )
 &gt; ^ &lt;
  
            </pre>
        </div>

        <!-- 计时模式显示 -->
        <div class="mb-2 font-pixel text-sm md:text-base" id="timer-mode">工作模式</div>

        <!-- 计时器显示 -->
        <div class="mb-4 font-pixel text-4xl md:text-5xl text-pixelPink-darker pulse-pixel" id="timer-display">25:00</div>

        <!-- 进度条 -->
        <div class="w-full h-4 bg-gray-200 pixel-border mb-6 overflow-hidden pixel-corners">
            <div id="progress-bar" class="h-full bg-pixelPink-dark pixel-progress" style="width: 100%"></div>
        </div>

        <!-- 控制按钮 -->
        <div class="flex justify-center gap-3 md:gap-6 mb-8">
            <button id="start-btn" class="pixel-button bg-pixelPink text-pixelPink-border px-4 py-2 font-pixel text-sm md:text-base pixel-border pixel-corners">
                <i class="fa fa-play mr-1"></i> 开始
            </button>
            <button id="reset-btn" class="pixel-button bg-pixelPink text-pixelPink-border px-4 py-2 font-pixel text-sm md:text-base pixel-border pixel-corners">
                <i class="fa fa-refresh mr-1"></i> 重置
            </button>
            <button id="skip-btn" class="pixel-button bg-pixelPink text-pixelPink-border px-4 py-2 font-pixel text-sm md:text-base pixel-border pixel-corners">
                <i class="fa fa-forward mr-1"></i> 跳过
            </button>
        </div>

        <!-- 完成计数 -->
        <div class="font-pixel text-sm md:text-base mb-2">
            今日完成: <span id="completed-count" class="text-pixelPink-darker">0</span> 个番茄钟
        </div>

        <!-- 键盘快捷键提示 -->
        <div class="text-xs text-gray-500">
            <span class="bg-gray-200 px-1">空格</span> 开始/暂停 | 
            <span class="bg-gray-200 px-1">R</span> 重置 | 
            <span class="bg-gray-200 px-1">S</span> 跳过
        </div>
    </div>

    <!-- 设置面板 (默认隐藏) -->
    <div id="settings-panel" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="w-full max-w-md bg-pixelPink-light p-6 pixel-border pixel-corners relative">
            <button id="close-settings" class="absolute top-3 right-3 text-pixelPink-border">
                <i class="fa fa-times"></i>
            </button>
            <h2 class="font-pixel text-xl mb-4 text-pixelPink-dark">设置</h2>

            <!-- 时长设置 -->
            <div class="mb-4">
                <h3 class="font-pixel text-sm mb-2">时长设置 (分钟)</h3>
                <div class="flex justify-between items-center mb-2">
                    <label class="text-sm">工作时间:</label>
                    <input type="number" id="work-duration" min="1" max="60" value="25" 
                        class="w-16 px-2 py-1 border-2 border-pixelPink-border bg-white text-center font-pixel text-sm">
                </div>
                <div class="flex justify-between items-center mb-2">
                    <label class="text-sm">短休息时间:</label>
                    <input type="number" id="short-break-duration" min="1" max="30" value="5" 
                        class="w-16 px-2 py-1 border-2 border-pixelPink-border bg-white text-center font-pixel text-sm">
                </div>
                <div class="flex justify-between items-center">
                    <label class="text-sm">长休息时间:</label>
                    <input type="number" id="long-break-duration" min="1" max="60" value="15" 
                        class="w-16 px-2 py-1 border-2 border-pixelPink-border bg-white text-center font-pixel text-sm">
                </div>
            </div>

            <!-- 音效设置 -->
            <div class="mb-4">
                <h3 class="font-pixel text-sm mb-2">音效设置</h3>
                <div class="flex items-center mb-2">
                    <input type="checkbox" id="sound-enabled" checked 
                        class="mr-2 border-2 border-pixelPink-border">
                    <label for="sound-enabled" class="text-sm">启用音效</label>
                </div>
                <div class="flex justify-between items-center">
                    <label for="volume-control" class="text-sm">音量:</label>
                    <input type="range" id="volume-control" min="0" max="100" value="70" 
                        class="w-24 accent-pixelPink-dark">
                </div>
            </div>

            <!-- 自动播放设置 -->
            <div class="mb-4">
                <div class="flex items-center">
                    <input type="checkbox" id="auto-next" checked 
                        class="mr-2 border-2 border-pixelPink-border">
                    <label for="auto-next" class="text-sm">自动开始下一个时段</label>
                </div>
            </div>

            <!-- 主题设置 -->
            <div class="mb-4">
                <h3 class="font-pixel text-sm mb-2">主题设置</h3>
                <div class="flex gap-2">
                    <button data-theme="pixelPink" class="theme-btn w-8 h-8 bg-pixelPink border-2 border-pixelPink-border pixel-border"></button>
                    <button data-theme="pixelBlue" class="theme-btn w-8 h-8 bg-pixelBlue border-2 border-pixelBlue-border pixel-border"></button>
                    <button data-theme="pixelGreen" class="theme-btn w-8 h-8 bg-pixelGreen border-2 border-pixelGreen-border pixel-border"></button>
                    <button data-theme="pixelDark" class="theme-btn w-8 h-8 bg-pixelDark border-2 border-pixelDark-border pixel-border"></button>
                </div>
            </div>

            <!-- 重置统计数据 -->
            <div class="mt-6">
                <button id="reset-stats" class="pixel-button bg-pixelPink text-pixelPink-border px-3 py-1 font-pixel text-xs pixel-border pixel-corners">
                    重置今日统计
                </button>
            </div>
        </div>
    </div>

    <script>
        // 状态管理
        const state = {
            mode: 'work', // work, shortBreak, longBreak
            isRunning: false,
            timeLeft: 25 * 60, // 秒
            timerId: null,
            completedPomodoros: 0,
            workSessions: 0, // 用于跟踪工作会话数，决定休息类型
            settings: {
                workDuration: 25,
                shortBreakDuration: 5,
                longBreakDuration: 15,
                soundEnabled: true,
                volume: 70,
                autoNext: true,
                theme: 'pixelPink',
                darkMode: false
            }
        };

        // DOM 元素
        const elements = {
            timerDisplay: document.getElementById('timer-display'),
            timerMode: document.getElementById('timer-mode'),
            startBtn: document.getElementById('start-btn'),
            resetBtn: document.getElementById('reset-btn'),
            skipBtn: document.getElementById('skip-btn'),
            progressBar: document.getElementById('progress-bar'),
            completedCount: document.getElementById('completed-count'),
            settingsBtn: document.getElementById('settings-btn'),
            settingsPanel: document.getElementById('settings-panel'),
            closeSettings: document.getElementById('close-settings'),
            workDuration: document.getElementById('work-duration'),
            shortBreakDuration: document.getElementById('short-break-duration'),
            longBreakDuration: document.getElementById('long-break-duration'),
            soundEnabled: document.getElementById('sound-enabled'),
            volumeControl: document.getElementById('volume-control'),
            autoNext: document.getElementById('auto-next'),
            resetStats: document.getElementById('reset-stats'),
            themeBtns: document.querySelectorAll('.theme-btn'),
            sounds: {
                start: document.getElementById('sound-start'),
                complete: document.getElementById('sound-complete'),
                alert: document.getElementById('sound-alert')
            }
        };

        // 初始化
        function init() {
            loadFromLocalStorage();
            updateTimerDisplay();
            updateModeDisplay();
            updateCompletedCount();
            applySettings();
            setupEventListeners();
        }

        // 从本地存储加载数据
        function loadFromLocalStorage() {
            // 加载设置
            const savedSettings = localStorage.getItem('pomodoroSettings');
            if (savedSettings) {
                state.settings = { ...state.settings, ...JSON.parse(savedSettings) };
            }

            // 加载统计数据
            const stats = localStorage.getItem('pomodoroStats');
            if (stats) {
                const { date, count } = JSON.parse(stats);
                // 检查是否是同一天
                const today = new Date().toDateString();
                if (date === today) {
                    state.completedPomodoros = count;
                }
            }

            // 设置初始时间
            resetTimeLeft();
        }

        // 保存到本地存储
        function saveToLocalStorage() {
            // 保存设置
            localStorage.setItem('pomodoroSettings', JSON.stringify(state.settings));

            // 保存统计数据
            const today = new Date().toDateString();
            localStorage.setItem('pomodoroStats', JSON.stringify({
                date: today,
                count: state.completedPomodoros
            }));
        }

        // 更新计时器显示
        function updateTimerDisplay() {
            const minutes = Math.floor(state.timeLeft / 60);
            const seconds = state.timeLeft % 60;
            elements.timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // 更新页面标题
            if (state.isRunning) {
                document.title = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')} - 番茄钟`;
            } else {
                document.title = '番茄钟';
            }

            // 更新进度条
            updateProgressBar();
        }

        // 更新模式显示
        function updateModeDisplay() {
            switch (state.mode) {
                case 'work':
                    elements.timerMode.textContent = '工作模式';
                    break;
                case 'shortBreak':
                    elements.timerMode.textContent = '短休息';
                    break;
                case 'longBreak':
                    elements.timerMode.textContent = '长休息';
                    break;
            }
        }

        // 更新完成计数显示
        function updateCompletedCount() {
            elements.completedCount.textContent = state.completedPomodoros;
        }

        // 更新进度条
        function updateProgressBar() {
            let totalSeconds;
            switch (state.mode) {
                case 'work':
                    totalSeconds = state.settings.workDuration * 60;
                    break;
                case 'shortBreak':
                    totalSeconds = state.settings.shortBreakDuration * 60;
                    break;
                case 'longBreak':
                    totalSeconds = state.settings.longBreakDuration * 60;
                    break;
            }
            const percentage = (state.timeLeft / totalSeconds) * 100;
            elements.progressBar.style.width = `${percentage}%`;
        }

        // 开始/暂停计时器
        function toggleTimer() {
            if (state.isRunning) {
                pauseTimer();
            } else {
                startTimer();
            }
        }

        // 开始计时器
        function startTimer() {
            if (state.isRunning) return;
            
            state.isRunning = true;
            elements.startBtn.innerHTML = '<i class="fa fa-pause mr-1"></i> 暂停';
            
            // 播放开始音效
            playSound('start');
            
            state.timerId = setInterval(() => {
                state.timeLeft--;
                updateTimerDisplay();
                
                if (state.timeLeft <= 0) {
                    completeTimer();
                }
            }, 1000);
        }

        // 暂停计时器
        function pauseTimer() {
            if (!state.isRunning) return;
            
            state.isRunning = false;
            clearInterval(state.timerId);
            elements.startBtn.innerHTML = '<i class="fa fa-play mr-1"></i> 开始';
        }

        // 重置计时器
        function resetTimer() {
            pauseTimer();
            resetTimeLeft();
            updateTimerDisplay();
        }

        // 重置剩余时间
        function resetTimeLeft() {
            switch (state.mode) {
                case 'work':
                    state.timeLeft = state.settings.workDuration * 60;
                    break;
                case 'shortBreak':
                    state.timeLeft = state.settings.shortBreakDuration * 60;
                    break;
                case 'longBreak':
                    state.timeLeft = state.settings.longBreakDuration * 60;
                    break;
            }
        }

        // 完成当前计时器
        function completeTimer() {
            pauseTimer();
            
            // 播放完成音效
            playSound('complete');
            
            // 如果是工作模式完成，增加计数
            if (state.mode === 'work') {
                state.completedPomodoros++;
                state.workSessions++;
                updateCompletedCount();
                saveToLocalStorage();
                createConfetti();
            }
            
            // 自动开始下一个时段
            if (state.settings.autoNext) {
                switchToNextMode();
                
                // 短暂延迟后自动开始
                setTimeout(() => {
                    startTimer();
                }, 1000);
            }
        }

        // 切换到下一个模式
        function switchToNextMode() {
            if (state.mode === 'work') {
                // 工作模式之后是休息模式
                // 每4个工作会话后是长休息
                if (state.workSessions % 4 === 0) {
                    state.mode = 'longBreak';
                } else {
                    state.mode = 'shortBreak';
                }
            } else {
                // 休息模式之后是工作模式
                state.mode = 'work';
            }
            
            resetTimeLeft();
            updateModeDisplay();
            updateTimerDisplay();
        }

        // 跳过当前时段
        function skipCurrentMode() {
            pauseTimer();
            switchToNextMode();
            playSound('alert');
        }

        // 播放音效
        function playSound(type) {
            if (!state.settings.soundEnabled) return;
            
            const sound = elements.sounds[type];
            if (sound) {
                sound.volume = state.settings.volume / 100;
                sound.currentTime = 0;
                sound.play().catch(e => console.log('播放音效失败:', e));
            }
        }

        // 应用设置
        function applySettings() {
            // 更新输入框
            elements.workDuration.value = state.settings.workDuration;
            elements.shortBreakDuration.value = state.settings.shortBreakDuration;
            elements.longBreakDuration.value = state.settings.longBreakDuration;
            elements.soundEnabled.checked = state.settings.soundEnabled;
            elements.volumeControl.value = state.settings.volume;
            elements.autoNext.checked = state.settings.autoNext;
            
            // 应用主题
            applyTheme(state.settings.theme);
            
            // 更新音量
            Object.values(elements.sounds).forEach(sound => {
                sound.volume = state.settings.volume / 100;
            });
            
            // 如果当前正在运行，不改变时间，否则重置时间
            if (!state.isRunning) {
                resetTimeLeft();
                updateTimerDisplay();
            }
        }

        // 应用主题
        function applyTheme(theme) {
            const body = document.getElementById('app-body');
            
            // 移除所有主题类
            ['pixelPink', 'pixelBlue', 'pixelGreen', 'pixelDark'].forEach(t => {
                body.classList.remove(`bg-${t}-light`, `text-${t}-darker`);
            });
            
            // 添加新主题类
            body.classList.add(`bg-${theme}-light`);
            
            // 对于暗色主题，调整文本颜色
            if (theme === 'pixelDark') {
                body.classList.add('text-white');
            } else {
                body.classList.remove('text-white');
                body.classList.add(`text-gray-800`);
            }
            
            // 更新按钮颜色
            const buttons = document.querySelectorAll('.pixel-button');
            buttons.forEach(btn => {
                ['pixelPink', 'pixelBlue', 'pixelGreen', 'pixelDark'].forEach(t => {
                    btn.classList.remove(`bg-${t}`, `text-${t}-border`);
                });
                btn.classList.add(`bg-${theme}`, `text-${theme}-border`);
            });
            
            // 更新进度条颜色
            elements.progressBar.classList.remove('bg-pixelPink-dark', 'bg-pixelBlue-dark', 'bg-pixelGreen-dark', 'bg-pixelDark-dark');
            elements.progressBar.classList.add(`bg-${theme}-dark`);
            
            // 更新标题颜色
            document.querySelector('h1').classList.remove('text-pixelPink-dark', 'text-pixelBlue-dark', 'text-pixelGreen-dark', 'text-pixelDark-dark');
            document.querySelector('h1').classList.add(`text-${theme}-dark`);
            
            // 更新设置面板标题
            document.querySelector('#settings-panel h2').classList.remove('text-pixelPink-dark', 'text-pixelBlue-dark', 'text-pixelGreen-dark', 'text-pixelDark-dark');
            document.querySelector('#settings-panel h2').classList.add(`text-${theme}-dark`);
            
            // 更新完成计数颜色
            elements.completedCount.classList.remove('text-pixelPink-dark', 'text-pixelBlue-dark', 'text-pixelGreen-dark', 'text-pixelDark-dark');
            elements.completedCount.classList.add(`text-${theme}-dark`);
            
            // 保存主题设置
            state.settings.theme = theme;
            saveToLocalStorage();
        }

        // 创建庆祝彩屑
        function createConfetti() {
            const colors = ['#FF69B4', '#4DA6FF', '#4DFF88', '#FFD700', '#FF6347', '#9370DB'];
            const container = document.body;
            
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.color = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = `${Math.random() * 3}s`;
                container.appendChild(confetti);
                
                // 3秒后移除彩屑元素
                setTimeout(() => {
                    confetti.remove();
                }, 3000);
            }
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 控制按钮
            elements.startBtn.addEventListener('click', toggleTimer);
            elements.resetBtn.addEventListener('click', resetTimer);
            elements.skipBtn.addEventListener('click', skipCurrentMode);
            
            // 设置面板
            elements.settingsBtn.addEventListener('click', () => {
                elements.settingsPanel.classList.remove('hidden');
            });
            
            elements.closeSettings.addEventListener('click', () => {
                elements.settingsPanel.classList.add('hidden');
            });
            
            // 保存设置
            elements.workDuration.addEventListener('change', (e) => {
                state.settings.workDuration = parseInt(e.target.value) || 25;
                saveToLocalStorage();
                applySettings();
            });
            
            elements.shortBreakDuration.addEventListener('change', (e) => {
                state.settings.shortBreakDuration = parseInt(e.target.value) || 5;
                saveToLocalStorage();
                applySettings();
            });
            
            elements.longBreakDuration.addEventListener('change', (e) => {
                state.settings.longBreakDuration = parseInt(e.target.value) || 15;
                saveToLocalStorage();
                applySettings();
            });
            
            elements.soundEnabled.addEventListener('change', (e) => {
                state.settings.soundEnabled = e.target.checked;
                saveToLocalStorage();
            });
            
            elements.volumeControl.addEventListener('input', (e) => {
                state.settings.volume = parseInt(e.target.value);
                Object.values(elements.sounds).forEach(sound => {
                    sound.volume = state.settings.volume / 100;
                });
                saveToLocalStorage();
            });
            
            elements.autoNext.addEventListener('change', (e) => {
                state.settings.autoNext = e.target.checked;
                saveToLocalStorage();
            });
            
            // 主题按钮
            elements.themeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    applyTheme(btn.dataset.theme);
                });
            });
            
            // 重置统计
            elements.resetStats.addEventListener('click', () => {
                if (confirm('确定要重置今日统计数据吗？')) {
                    state.completedPomodoros = 0;
                    updateCompletedCount();
                    saveToLocalStorage();
                }
            });
            
            // 键盘快捷键
            document.addEventListener('keydown', (e) => {
                switch (e.key) {
                    case ' ': // 空格键
                        e.preventDefault();
                        toggleTimer();
                        break;
                    case 'r':
                    case 'R':
                        resetTimer();
                        break;
                    case 's':
                    case 'S':
                        skipCurrentMode();
                        break;
                }
            });
            
            // 点击设置面板外部关闭
            elements.settingsPanel.addEventListener('click', (e) => {
                if (e.target === elements.settingsPanel) {
                    elements.settingsPanel.classList.add('hidden');
                }
            });
        }

        // 初始化应用
        init();
    </script>
</body>
</html>