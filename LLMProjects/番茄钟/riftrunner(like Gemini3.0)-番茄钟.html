<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç•ªèŒ„é’Ÿ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            /* é»˜è®¤ä¸»é¢˜ï¼šSakura (æ¨±èŠ±) */
            --bg-color: #fff0f5;
            --panel-bg: #fff;
            --primary: #ff6b81;
            --secondary: #ff9eb5;
            --accent: #2f3542;
            --text: #2f3542;
            --shadow-light: #ffe0e6;
            --shadow-dark: #d65a6e;
            --font-main: 'VT323', monospace;
        }

        [data-theme="mint"] {
            --bg-color: #e0f7fa;
            --panel-bg: #ffffff;
            --primary: #00b894;
            --secondary: #55efc4;
            --accent: #2d3436;
            --text: #2d3436;
            --shadow-light: #b2fab4;
            --shadow-dark: #008f72;
        }

        [data-theme="dark"] {
            --bg-color: #2d3436;
            --panel-bg: #636e72;
            --primary: #fdcb6e;
            --secondary: #ffeaa7;
            --accent: #dfe6e9;
            --text: #dfe6e9;
            --shadow-light: #757d81;
            --shadow-dark: #b78e36;
        }

        * {
            box-sizing: border-box;
            user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text);
            font-family: var(--font-main);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            transition: background-color 0.5s, color 0.3s;
            background-image: 
                radial-gradient(var(--secondary) 1px, transparent 1px);
            background-size: 20px 20px;
            overflow: hidden;
        }

        /* ä¸»å®¹å™¨ */
        .app-container {
            background: var(--panel-bg);
            border: 4px solid var(--text);
            box-shadow: 8px 8px 0px var(--shadow-dark);
            padding: 2rem;
            width: 90%;
            max-width: 450px;
            text-align: center;
            position: relative;
            border-radius: 4px;
        }

        /* é¡¶éƒ¨æ  */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        h1 {
            font-size: 2.5rem;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 2px 2px 0px var(--secondary);
        }

        .theme-btn, .settings-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--text);
            transition: transform 0.1s;
        }
        .theme-btn:active, .settings-btn:active { transform: scale(0.9); }

        /* åƒç´ å® ç‰©åŒºåŸŸ */
        .mascot-stage {
            height: 120px;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            margin-bottom: 1rem;
            position: relative;
        }

        /* SVG åƒç´ çŒ«åŠ¨ç”» */
        #pixel-cat {
            width: 100px;
            height: 100px;
        }
        
        .cat-body { fill: var(--text); }
        .cat-face { fill: var(--panel-bg); }
        .cat-eyes { fill: var(--text); }
        
        /* åŠ¨ç”»å®šä¹‰ */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        @keyframes sleep {
            0%, 50% { transform: scaleY(1); }
            60%, 90% { transform: scaleY(0.1); } /* çœ¨çœ¼/ç¡è§‰ */
        }

        .anim-focus #pixel-cat { animation: bounce 1s infinite steps(2); }
        .anim-rest #pixel-cat .cat-eyes { animation: sleep 3s infinite; }

        .status-badge {
            background: var(--primary);
            color: var(--panel-bg);
            padding: 4px 12px;
            font-size: 1.2rem;
            border: 2px solid var(--text);
            display: inline-block;
            margin-bottom: 0.5rem;
            box-shadow: 3px 3px 0px rgba(0,0,0,0.1);
        }

        /* è®¡æ—¶å™¨æ˜¾ç¤º */
        .timer-display {
            font-size: 6rem;
            line-height: 1;
            margin: 0.5rem 0;
            font-weight: bold;
            text-shadow: 4px 4px 0px var(--secondary);
        }

        /* è¿›åº¦æ¡ */
        .progress-container {
            width: 100%;
            height: 20px;
            border: 2px solid var(--text);
            background: var(--bg-color);
            margin-bottom: 2rem;
            position: relative;
        }
        .progress-bar {
            height: 100%;
            background: var(--primary);
            width: 100%;
            transition: width 1s linear;
            background-image: linear-gradient(
                45deg, 
                rgba(255,255,255,0.2) 25%, 
                transparent 25%, 
                transparent 50%, 
                rgba(255,255,255,0.2) 50%, 
                rgba(255,255,255,0.2) 75%, 
                transparent 75%, 
                transparent
            );
            background-size: 20px 20px;
        }

        /* æ§åˆ¶æŒ‰é’® */
        .controls {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 1.5rem;
        }

        .pixel-btn {
            font-family: var(--font-main);
            font-size: 1.5rem;
            padding: 10px 0;
            border: 2px solid var(--text);
            background: var(--panel-bg);
            color: var(--text);
            cursor: pointer;
            position: relative;
            box-shadow: inset 2px 2px 0px #fff, inset -2px -2px 0px rgba(0,0,0,0.1), 4px 4px 0px var(--text);
            transition: all 0.1s;
        }

        .pixel-btn.primary {
            background: var(--primary);
            color: var(--panel-bg);
            box-shadow: inset 2px 2px 0px rgba(255,255,255,0.4), inset -2px -2px 0px rgba(0,0,0,0.2), 4px 4px 0px var(--text);
        }

        .pixel-btn:active {
            transform: translate(2px, 2px);
            box-shadow: inset 2px 2px 0px rgba(0,0,0,0.1), 2px 2px 0px var(--text);
        }

        /* ç»Ÿè®¡ */
        .stats {
            border-top: 2px dashed var(--text);
            padding-top: 1rem;
            display: flex;
            justify-content: space-around;
            font-size: 1.2rem;
        }
        .stat-item span {
            color: var(--primary);
            font-weight: bold;
            font-size: 1.4rem;
        }

        /* è®¾ç½®æ¨¡æ€æ¡† */
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal.open { display: flex; }

        .modal-content {
            background: var(--panel-bg);
            border: 4px solid var(--text);
            padding: 2rem;
            width: 90%;
            max-width: 400px;
            box-shadow: 10px 10px 0px var(--shadow-dark);
        }

        .setting-group {
            margin-bottom: 1rem;
            text-align: left;
        }
        .setting-group label {
            display: block;
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }
        .setting-group input[type="range"] {
            width: 100%;
            accent-color: var(--primary);
        }
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .checkbox-wrapper input {
            width: 20px; height: 20px;
            accent-color: var(--primary);
        }

        .close-modal {
            margin-top: 1rem;
            width: 100%;
        }

        /* å“åº”å¼é€‚é… */
        @media (max-width: 400px) {
            h1 { font-size: 2rem; }
            .timer-display { font-size: 4.5rem; }
            .controls { grid-template-columns: 1fr; }
        }

    </style>
</head>
<body>

    <div class="app-container">
        <header class="header">
            <button class="theme-btn" id="btn-theme" title="åˆ‡æ¢ä¸»é¢˜">ğŸ¨</button>
            <h1>ç•ªèŒ„é’Ÿ</h1>
            <button class="settings-btn" id="btn-settings" title="è®¾ç½®">âš™ï¸</button>
        </header>

        <div class="mascot-stage anim-rest" id="mascot-stage">
            <!-- SVG Pixel Cat -->
            <svg id="pixel-cat" viewBox="0 0 32 32">
                <!-- èº«ä½“ -->
                <rect x="10" y="16" width="12" height="10" class="cat-body"/>
                <!-- å°¾å·´ -->
                <rect x="22" y="22" width="4" height="2" class="cat-body"/>
                <rect x="24" y="20" width="2" height="2" class="cat-body"/>
                <!-- è„¸ -->
                <rect x="8" y="10" width="16" height="10" class="cat-body"/>
                <rect x="10" y="12" width="12" height="6" class="cat-face"/>
                <!-- è€³æœµ -->
                <rect x="8" y="8" width="4" height="2" class="cat-body"/>
                <rect x="9" y="7" width="2" height="1" class="cat-body"/>
                <rect x="20" y="8" width="4" height="2" class="cat-body"/>
                <rect x="21" y="7" width="2" height="1" class="cat-body"/>
                <!-- çœ¼ç› -->
                <rect x="12" y="14" width="2" height="2" class="cat-eyes"/>
                <rect x="18" y="14" width="2" height="2" class="cat-eyes"/>
                <!-- é¼»å­ -->
                <rect x="15" y="16" width="2" height="1" class="cat-text"/>
            </svg>
            <div class="status-badge" id="status-text">ä¼‘æ¯ä¸­</div>
        </div>

        <div class="timer-display" id="timer">25:00</div>

        <div class="progress-container">
            <div class="progress-bar" id="progress"></div>
        </div>

        <div class="controls">
            <button class="pixel-btn primary" id="btn-start">å¼€å§‹</button>
            <button class="pixel-btn" id="btn-skip">è·³è¿‡</button>
            <button class="pixel-btn" id="btn-reset">é‡ç½®</button>
        </div>

        <div class="stats">
            <div class="stat-item">ä»Šæ—¥ç•ªèŒ„: <span id="tomato-count">0</span> ğŸ…</div>
            <div class="stat-item">çŠ¶æ€: <span id="loop-count">1</span>/4</div>
        </div>
    </div>

    <!-- è®¾ç½®æ¨¡æ€æ¡† -->
    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <h2>è®¾ç½®</h2>
            <div class="setting-group">
                <label>å·¥ä½œæ—¶é•¿ (åˆ†é’Ÿ): <span id="val-work">25</span></label>
                <input type="range" id="set-work" min="1" max="60" value="25">
            </div>
            <div class="setting-group">
                <label>çŸ­ä¼‘æ—¶é•¿ (åˆ†é’Ÿ): <span id="val-short">5</span></label>
                <input type="range" id="set-short" min="1" max="30" value="5">
            </div>
            <div class="setting-group">
                <label>é•¿ä¼‘æ—¶é•¿ (åˆ†é’Ÿ): <span id="val-long">15</span></label>
                <input type="range" id="set-long" min="5" max="60" value="15">
            </div>
            <div class="setting-group">
                <label>éŸ³é‡: <span id="val-vol">50</span>%</label>
                <input type="range" id="set-vol" min="0" max="100" value="50">
            </div>
            <div class="setting-group checkbox-wrapper">
                <input type="checkbox" id="set-auto">
                <label for="set-auto">è‡ªåŠ¨å¼€å§‹ä¸‹ä¸€æ—¶æ®µ</label>
            </div>
            <button class="pixel-btn close-modal" id="btn-close-settings">ä¿å­˜å¹¶å…³é—­</button>
        </div>
    </div>

    <script>
        /* --- çŠ¶æ€ä¸é…ç½® --- */
        const state = {
            timeRemaining: 1500,
            totalTime: 1500,
            isRunning: false,
            mode: 'work', // work, shortBreak, longBreak
            loopIndex: 0, // 0-3: work, 4: long break triggered
            tomatoesToday: 0,
            timerId: null
        };

        const config = {
            workTime: 25,
            shortBreakTime: 5,
            longBreakTime: 15,
            volume: 0.5,
            autoStart: false,
            theme: 'sakura'
        };

        /* --- DOM å…ƒç´  --- */
        const els = {
            timer: document.getElementById('timer'),
            progress: document.getElementById('progress'),
            status: document.getElementById('status-text'),
            mascot: document.getElementById('mascot-stage'),
            btnStart: document.getElementById('btn-start'),
            tomatoCount: document.getElementById('tomato-count'),
            loopCount: document.getElementById('loop-count'),
            body: document.body,
            settingsModal: document.getElementById('settings-modal')
        };

        /* --- éŸ³é¢‘ç³»ç»Ÿ (Web Audio API - 8bit Synth) --- */
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(type) {
            if (config.volume === 0) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            const now = audioCtx.currentTime;
            
            if (type === 'start') {
                // åªæœ‰ä¸¤ä¸ªéŸ³ç¬¦çš„ä¸Šè¡ŒéŸ³
                osc.type = 'square';
                osc.frequency.setValueAtTime(440, now);
                osc.frequency.setValueAtTime(880, now + 0.1);
                gainNode.gain.setValueAtTime(config.volume * 0.1, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            } else if (type === 'complete') {
                // èƒœåˆ©éŸ³æ•ˆ
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(523.25, now); // C
                osc.frequency.setValueAtTime(659.25, now + 0.1); // E
                osc.frequency.setValueAtTime(783.99, now + 0.2); // G
                osc.frequency.setValueAtTime(1046.50, now + 0.4); // C High
                gainNode.gain.setValueAtTime(config.volume * 0.1, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.8);
                osc.start(now);
                osc.stop(now + 0.8);
            } else if (type === 'click') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(220, now);
                gainNode.gain.setValueAtTime(config.volume * 0.05, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                osc.start(now);
                osc.stop(now + 0.05);
            }
        }

        /* --- æ ¸å¿ƒé€»è¾‘ --- */

        function init() {
            loadData();
            applyTheme(config.theme);
            resetTimer(false); // ä¸è‡ªåŠ¨å¼€å§‹
            updateUI();
            setupEventListeners();
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function updateUI() {
            // æ›´æ–°æ—¶é—´æ˜¾ç¤º
            els.timer.textContent = formatTime(state.timeRemaining);
            
            // æ›´æ–°æ ‡é¢˜
            document.title = state.isRunning 
                ? `(${formatTime(state.timeRemaining)}) ğŸ… ç•ªèŒ„é’Ÿ` 
                : "ç•ªèŒ„é’Ÿ";

            // æ›´æ–°è¿›åº¦æ¡
            const percent = ((state.totalTime - state.timeRemaining) / state.totalTime) * 100;
            els.progress.style.width = `${100 - percent}%`;

            // æ›´æ–°çŠ¶æ€æ–‡å­—å’ŒæŒ‰é’®
            els.btnStart.textContent = state.isRunning ? "æš‚åœ" : "å¼€å§‹";
            
            // æ›´æ–°ç»Ÿè®¡
            els.tomatoCount.textContent = state.tomatoesToday;
            els.loopCount.textContent = (state.loopIndex + 1);

            // æ›´æ–°å¤–è§‚çŠ¶æ€
            if (state.mode === 'work') {
                els.status.textContent = state.isRunning ? "ä¸“æ³¨ä¸­..." : "å‡†å¤‡ä¸“æ³¨";
                els.status.style.background = "var(--primary)";
                els.mascot.className = state.isRunning ? "mascot-stage anim-focus" : "mascot-stage";
            } else {
                els.status.textContent = state.mode === 'shortBreak' ? "çŸ­ä¼‘æ¯" : "é•¿ä¼‘æ¯";
                els.status.style.background = "var(--secondary)";
                els.mascot.className = "mascot-stage anim-rest";
            }
        }

        function switchMode() {
            playSound('complete');
            
            if (state.mode === 'work') {
                // å·¥ä½œç»“æŸ
                state.tomatoesToday++;
                state.loopIndex++;
                saveData();

                if (state.loopIndex >= 4) {
                    state.mode = 'longBreak';
                    state.loopIndex = 0;
                } else {
                    state.mode = 'shortBreak';
                }
            } else {
                // ä¼‘æ¯ç»“æŸ
                state.mode = 'work';
            }

            resetTimer(config.autoStart);
        }

        function resetTimer(autoStart = false) {
            clearInterval(state.timerId);
            state.isRunning = autoStart;
            
            let duration;
            if (state.mode === 'work') duration = config.workTime;
            else if (state.mode === 'shortBreak') duration = config.shortBreakTime;
            else duration = config.longBreakTime;

            state.totalTime = duration * 60;
            state.timeRemaining = state.totalTime;

            if (autoStart) {
                startTimer();
            } else {
                state.isRunning = false;
            }
            updateUI();
        }

        function startTimer() {
            if (state.isRunning) {
                // æš‚åœ
                clearInterval(state.timerId);
                state.isRunning = false;
            } else {
                // å¼€å§‹
                playSound('start');
                state.isRunning = true;
                state.timerId = setInterval(() => {
                    state.timeRemaining--;
                    if (state.timeRemaining < 0) {
                        clearInterval(state.timerId);
                        switchMode();
                    } else {
                        updateUI();
                    }
                }, 1000);
            }
            updateUI();
        }

        function skipTimer() {
            playSound('click');
            clearInterval(state.timerId);
            switchMode();
        }

        function manualReset() {
            playSound('click');
            // ä¿æŒå½“å‰æ¨¡å¼ï¼Œé‡ç½®æ—¶é—´
            resetTimer(false);
        }

        /* --- æ•°æ®æŒä¹…åŒ– --- */
        function saveData() {
            const data = {
                config: config,
                stats: {
                    tomatoesToday: state.tomatoesToday,
                    date: new Date().toDateString()
                }
            };
            localStorage.setItem('pixelFocusData', JSON.stringify(data));
        }

        function loadData() {
            const saved = localStorage.getItem('pixelFocusData');
            if (saved) {
                const data = JSON.parse(saved);
                // åˆå¹¶é…ç½®
                Object.assign(config, data.config);
                
                // æ£€æŸ¥æ—¥æœŸï¼Œå¦‚æœæ˜¯æ–°çš„ä¸€å¤©é‡ç½®è®¡æ•°
                if (data.stats.date === new Date().toDateString()) {
                    state.tomatoesToday = data.stats.tomatoesToday;
                } else {
                    state.tomatoesToday = 0;
                }
            }
            // å¡«å……è®¾ç½®é¢æ¿æ•°æ®
            document.getElementById('set-work').value = config.workTime;
            document.getElementById('set-short').value = config.shortBreakTime;
            document.getElementById('set-long').value = config.longBreakTime;
            document.getElementById('set-vol').value = config.volume * 100;
            document.getElementById('set-auto').checked = config.autoStart;
            updateSettingsLabels();
        }

        /* --- è®¾ç½®ä¸äº‹ä»¶ç›‘å¬ --- */
        
        function updateSettingsLabels() {
            document.getElementById('val-work').textContent = document.getElementById('set-work').value;
            document.getElementById('val-short').textContent = document.getElementById('set-short').value;
            document.getElementById('val-long').textContent = document.getElementById('set-long').value;
            document.getElementById('val-vol').textContent = document.getElementById('set-vol').value;
        }

        function applyTheme(themeName) {
            document.body.setAttribute('data-theme', themeName);
            config.theme = themeName;
            saveData();
        }

        function setupEventListeners() {
            // æŒ‰é’®
            els.btnStart.addEventListener('click', () => { playSound('click'); startTimer(); });
            document.getElementById('btn-skip').addEventListener('click', skipTimer);
            document.getElementById('btn-reset').addEventListener('click', manualReset);

            // è®¾ç½®é¢æ¿
            const settingsBtn = document.getElementById('btn-settings');
            const closeSettingsBtn = document.getElementById('btn-close-settings');
            
            settingsBtn.addEventListener('click', () => {
                els.settingsModal.classList.add('open');
            });

            closeSettingsBtn.addEventListener('click', () => {
                // ä¿å­˜é…ç½®
                config.workTime = parseInt(document.getElementById('set-work').value);
                config.shortBreakTime = parseInt(document.getElementById('set-short').value);
                config.longBreakTime = parseInt(document.getElementById('set-long').value);
                config.volume = parseInt(document.getElementById('set-vol').value) / 100;
                config.autoStart = document.getElementById('set-auto').checked;
                
                saveData();
                els.settingsModal.classList.remove('open');
                
                // å¦‚æœè®¡æ—¶å™¨æœªè¿è¡Œï¼Œç«‹å³åº”ç”¨æ–°çš„æ—¶é—´è®¾ç½®
                if (!state.isRunning) {
                    resetTimer(false);
                }
            });

            // è®¾ç½®é¡¹å®æ—¶æ˜¾ç¤ºæ•°å€¼
            ['set-work', 'set-short', 'set-long', 'set-vol'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateSettingsLabels);
            });

            // ä¸»é¢˜åˆ‡æ¢
            document.getElementById('btn-theme').addEventListener('click', () => {
                const themes = ['sakura', 'mint', 'dark'];
                let idx = themes.indexOf(config.theme);
                idx = (idx + 1) % themes.length;
                applyTheme(themes[idx]);
            });

            // é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown', (e) => {
                if (e.code === 'Space') {
                    e.preventDefault(); // é˜²æ­¢æ»šåŠ¨
                    startTimer();
                } else if (e.code === 'KeyR') {
                    manualReset();
                } else if (e.code === 'KeyS') {
                    skipTimer();
                }
            });
        }

        // å¯åŠ¨
        init();

    </script>
</body>
</html>