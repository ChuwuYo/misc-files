<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ç•ªèŒ„é’Ÿ</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
  /* åŸºç¡€å˜é‡ */
  :root {
    --bg-light: linear-gradient(135deg, #fff8f0 0%, #f0f8ff 100%);
    --bg-dark: linear-gradient(135deg, #2a2a3a 0%, #1a1a2a 100%);
    --text-light: #4a4a6a;
    --text-dark: #f0f0ff;
    --pink: #ff9a9e;
    --blue: #a2d2ff;
    --mint: #a0e7a0;
    --purple: #d0b0ff;
    --pixel-border-color: #4a4a6a;
  }

  body {
    margin: 0;
    font-family: 'Press Start 2P', cursive;
    background: var(--bg-light);
    color: var(--text-light);
    transition: background 0.3s, color 0.3s;
    overflow-x: hidden;
    user-select: none;
    padding: 20px;
    box-sizing: border-box;
    min-height: 100vh;
  }

  body.dark-mode {
    background: var(--bg-dark);
    color: var(--text-dark);
    --pixel-border-color: #f0f0ff;
  }

  /* åƒç´ è¾¹æ¡† */
  .pixel-border {
    position: relative;
    background: white;
    border: 4px solid var(--pixel-border-color);
    box-shadow:
      0 4px 0 0 rgba(0,0,0,0.1),
      inset 0 -4px 0 0 rgba(0,0,0,0.05),
      inset 0 4px 0 0 rgba(255,255,255,0.5);
  }

  body.dark-mode .pixel-border {
    background: #2a2a3a;
  }

  /* æ ‡é¢˜åŒº */
  .header {
    text-align: center;
    margin: 20px 0 40px;
  }

  .header h1 {
    font-size: 24px;
    margin: 0 0 20px;
    letter-spacing: 2px;
  }

  .stats-row {
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
  }

  .stats {
    display: inline-block;
    padding: 12px 20px;
    font-size: 10px;
    margin: 5px;
  }

  /* è®¡æ—¶å™¨ä¸»åŒºåŸŸ */
  .timer-container {
    max-width: 400px;
    margin: 0 auto 40px;
    position: relative;
  }

  .progress-ring {
    width: 300px;
    height: 300px;
    margin: 0 auto;
    position: relative;
    border-radius: 50%;
    background: conic-gradient(var(--pink) 0deg, var(--pink) 360deg);
    transition: background 0.3s;
    filter: drop-shadow(0 0 20px rgba(255, 100, 150, 0.3));
  }

  .timer-display {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 36px;
    letter-spacing: 4px;
    text-shadow: 2px 2px 0 rgba(0,0,0,0.1);
  }

  .phase-label {
    text-align: center;
    font-size: 12px;
    margin-top: 20px;
    letter-spacing: 1px;
  }

  /* æ§åˆ¶æŒ‰é’® */
  .controls {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 30px;
    flex-wrap: wrap;
  }

  .btn {
    padding: 12px 24px;
    font-size: 10px;
    cursor: pointer;
    background: linear-gradient(135deg, var(--pink) 0%, var(--blue) 100%);
    color: white;
    border: none;
    position: relative;
    top: 0;
    transition: top 0.1s, box-shadow 0.1s;
    letter-spacing: 1px;
  }

  .btn:hover { top: -2px; }
  .btn:active { top: 4px; box-shadow: none; }

  /* å¿«æ·æŒ‰é’® */
  .quick-actions {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 30px;
  }

  .quick-btn {
    padding: 8px 16px;
    font-size: 9px;
    cursor: pointer;
    background: transparent;
    color: inherit;
  }

  /* è®¾ç½®å¼¹çª— */
  .modal {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    z-index: 100;
  }

  .modal-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
    padding: 30px;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .close-btn {
    cursor: pointer;
    font-size: 16px;
    padding: 5px 10px;
  }

  .setting-group {
    margin-bottom: 20px;
  }

  .setting-group label {
    display: block;
    font-size: 10px;
    margin-bottom: 8px;
  }

  .setting-group input[type="number"],
  .setting-group input[type="range"] {
    width: 100%;
    padding: 8px;
    font-size: 10px;
  }

  .setting-group input[type="checkbox"] {
    margin-right: 8px;
  }

  /* åƒç´ è§’è‰² */
  .character {
    position: absolute;
    bottom: -60px;
    left: 50%;
    transform: translateX(-50%);
    width: 48px;
    height: 48px;
    background: #ff9a9e;
    border: 3px solid var(--pixel-border-color);
    image-rendering: pixelated;
    animation: bounce 2s infinite, blink 4s infinite;
  }

  @keyframes bounce {
    0%, 100% { transform: translateX(-50%) translateY(0); }
    50% { transform: translateX(-50%) translateY(-8px); }
  }

  @keyframes blink {
    0%, 90%, 100% { opacity: 1; }
    95% { opacity: 0.3; }
  }

  /* é€šçŸ¥ */
  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 25px;
    font-size: 10px;
    z-index: 200;
    animation: slideIn 0.3s;
  }

  @keyframes slideIn {
    from { transform: translateX(100%); }
    to { transform: translateX(0); }
  }

  /* å“åº”å¼ */
  @media (max-width: 768px) {
    .header h1 { font-size: 18px; }
    .timer-display { font-size: 28px; }
    .progress-ring { width: 250px; height: 250px; }
    .btn { padding: 10px 20px; font-size: 9px; }
    .stats-row { flex-direction: column; gap: 10px; }
  }

  /* æˆå°±åŠ¨ç”» */
  @keyframes achievement {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); filter: brightness(1.5); }
    100% { transform: scale(1); }
  }

  .achievement {
    animation: achievement 0.5s;
  }
</style>
</head>
<body>
  <!-- ä¸»å®¹å™¨ -->
  <div class="container">
    <!-- æ ‡é¢˜åŒº -->
    <div class="header">
      <h1>ğŸ… ç•ªèŒ„é’Ÿ</h1>
      <div class="stats-row">
        <div class="stats pixel-border">
          è¿ç»­ <span id="currentStreak">0</span> å¤©
        </div>
        <div class="stats pixel-border">
          æœ€é•¿ <span id="bestStreak">0</span> å¤©
        </div>
        <div class="stats pixel-border">
          ä»Šæ—¥ <span id="todayCount">0</span> ä¸ª
        </div>
      </div>
    </div>

    <!-- è®¡æ—¶å™¨ -->
    <div class="timer-container">
      <div class="progress-ring pixel-border" id="progressRing">
        <div class="timer-display" id="timerDisplay">25:00</div>
      </div>
      <div class="phase-label" id="phaseLabel">å‡†å¤‡å¼€å§‹å·¥ä½œ</div>
      <!-- åƒç´ è§’è‰² -->
      <div class="character" id="character"></div>
    </div>

    <!-- æ§åˆ¶æŒ‰é’® -->
    <div class="controls">
      <button class="btn pixel-border" id="startBtn">å¼€å§‹</button>
      <button class="btn pixel-border" id="pauseBtn" style="display:none;">æš‚åœ</button>
      <button class="btn pixel-border" id="resetBtn">é‡ç½®</button>
      <button class="btn pixel-border" id="skipBtn">è·³è¿‡</button>
    </div>

    <!-- å¿«æ·æŒ‰é’® -->
    <div class="quick-actions">
      <button class="quick-btn pixel-border" id="settingsBtn">âš™ï¸ è®¾ç½®</button>
      <button class="quick-btn pixel-border" id="statsBtn">ğŸ“Š ç»Ÿè®¡</button>
      <button class="quick-btn pixel-border" id="themeBtn">ğŸ¨ ä¸»é¢˜</button>
      <button class="quick-btn pixel-border" id="aboutBtn">â“ å…³äº</button>
    </div>
  </div>

  <!-- è®¾ç½®å¼¹çª— -->
  <div class="modal" id="settingsModal">
    <div class="modal-content pixel-border">
      <div class="modal-header">
        <h2>è®¾ç½®</h2>
        <span class="close-btn" id="closeSettings">âœ–ï¸</span>
      </div>
      
      <div class="setting-group">
        <label>å·¥ä½œæ—¶é•¿ (åˆ†é’Ÿ)</label>
        <input type="number" id="workTime" min="1" max="60" value="25">
      </div>
      <div class="setting-group">
        <label>çŸ­ä¼‘æ¯æ—¶é•¿ (åˆ†é’Ÿ)</label>
        <input type="number" id="shortBreakTime" min="1" max="30" value="5">
      </div>
      <div class="setting-group">
        <label>é•¿ä¼‘æ¯æ—¶é•¿ (åˆ†é’Ÿ)</label>
        <input type="number" id="longBreakTime" min="1" max="60" value="15">
      </div>
      <div class="setting-group">
        <label>è‡ªåŠ¨å¼€å§‹ä¸‹ä¸€é˜¶æ®µ</label>
        <input type="checkbox" id="autoStart">
      </div>
      <div class="setting-group">
        <label>å¯ç”¨éŸ³æ•ˆ</label>
        <input type="checkbox" id="soundEnabled" checked>
      </div>
      <div class="setting-group">
        <label>éŸ³é‡</label>
        <input type="range" id="volume" min="0" max="100" value="70">
      </div>
    </div>
  </div>

  <!-- ç»Ÿè®¡å¼¹çª— -->
  <div class="modal" id="statsModal">
    <div class="modal-content pixel-border">
      <div class="modal-header">
        <h2>ç»Ÿè®¡</h2>
        <span class="close-btn" id="closeStats">âœ–ï¸</span>
      </div>
      <div id="statsContent" style="font-size: 10px; line-height: 1.8;">
        <p>ğŸ“ˆ è¿ç»­ä¸“æ³¨å¤©æ•°ç»Ÿè®¡</p>
        <div style="margin: 20px 0;">
          <div style="margin-bottom: 10px;">å½“å‰è¿ç»­: <span id="modalCurrentStreak">0</span> å¤©</div>
          <div>æœ€é•¿è®°å½•: <span id="modalBestStreak">0</span> å¤©</div>
        </div>
        <p style="font-size: 9px; opacity: 0.7;">
          æç¤º: æ¯å¤©å®Œæˆè‡³å°‘1ä¸ªç•ªèŒ„å³å¯ä¿æŒè¿ç»­è®°å½•
        </p>
      </div>
    </div>
  </div>

  <!-- ä¸»é¢˜å¼¹çª— -->
  <div class="modal" id="themeModal">
    <div class="modal-content pixel-border">
      <div class="modal-header">
        <h2>ä¸»é¢˜</h2>
        <span class="close-btn" id="closeTheme">âœ–ï¸</span>
      </div>
      <div class="setting-group">
        <label>æš—é»‘æ¨¡å¼</label>
        <input type="checkbox" id="darkMode">
      </div>
      <div class="setting-group">
        <label>ä¸»è‰²è°ƒ</label>
        <select id="colorScheme">
          <option value="pink">ç²‰çº¢</option>
          <option value="blue">è“è‰²</option>
          <option value="mint">è–„è·</option>
          <option value="purple">ç´«è‰²</option>
        </select>
      </div>
      <div class="setting-group">
        <label>æ˜¾ç¤ºåƒç´ è§’è‰²</label>
        <input type="checkbox" id="showCharacter" checked>
      </div>
    </div>
  </div>

  <!-- å…³äºå¼¹çª— -->
  <div class="modal" id="aboutModal">
    <div class="modal-content pixel-border">
      <div class="modal-header">
        <h2>å…³äº</h2>
        <span class="close-btn" id="closeAbout">âœ–ï¸</span>
      </div>
      <p style="font-size:10px;line-height:1.6;">
        ğŸ… åƒç´ ç•ªèŒ„é’Ÿ v1.0<br>
        ä½¿ç”¨ Vanilla JS åˆ¶ä½œ<br>
        å¿«æ·é”®ï¼š<br>
        Space: å¼€å§‹/æš‚åœ<br>
        R: é‡ç½®<br>
        S: è·³è¿‡<br>
        Ctrl+S: æ‰“å¼€è®¾ç½®<br>
        Alt+T: ç•ªèŒ„é›¨å½©è›‹<br>
      </p>
    </div>
  </div>

  <!-- éŸ³é¢‘å…ƒç´  -->
  <audio id="soundStart" preload="auto">
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmFgU7k9n1unEiBC13yO/eizEIHWq+8+OWT" type="audio/wav">
  </audio>
  <audio id="soundEnd" preload="auto">
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmFgU7k9n1unEiBC13yO/eizEIHWq+8+OWT" type="audio/wav">
  </audio>
  <audio id="soundRemind" preload="auto">
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmFgU7k9n1unEiBC13yO/eizEIHWq+8+OWT" type="audio/wav">
  </audio>

<script>
// ==================== çŠ¶æ€ç®¡ç† ====================
const state = {
  currentPhase: 'work',
  timeLeft: 25 * 60,
  totalTime: 25 * 60,
  isRunning: false,
  completedCycles: 0,
  streak: {
    current: 0,
    best: 0,
    lastDate: null,
  },
  timer: null,
  settings: {
    workTime: 25,
    shortBreakTime: 5,
    longBreakTime: 15,
    soundEnabled: true,
    soundVolume: 70,
    autoStart: false,
    darkMode: false,
    characterEnabled: true,
    color: 'pink',
  },
};

// ==================== å·¥å…·å‡½æ•° ====================
const $ = id => document.getElementById(id);
const formatTime = sec => `${String(Math.floor(sec/60)).padStart(2,'0')}:${String(sec%60).padStart(2,'0')}`;
const todayString = () => new Date().toISOString().split('T')[0];

// è®¡ç®—æ—¥æœŸå·®ï¼ˆå¤©æ•°ï¼‰
function daysBetween(date1, date2) {
  const oneDay = 24 * 60 * 60 * 1000;
  return Math.floor((new Date(date1) - new Date(date2)) / oneDay);
}

// ==================== å­˜å‚¨ç®¡ç† ====================
const STORAGE = {
  settings: 'pomodoroSettings',
  streak: 'pomodoroStreak',
  todayCount: 'pomodoroToday',
};

function loadSettings() {
  const saved = localStorage.getItem(STORAGE.settings);
  if (saved) {
    Object.assign(state.settings, JSON.parse(saved));
  }
  
  const streakSaved = localStorage.getItem(STORAGE.streak);
  if (streakSaved) {
    Object.assign(state.streak, JSON.parse(streakSaved));
    // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡ç½®è¿ç»­å¤©æ•°
    const today = todayString();
    if (state.streak.lastDate && state.streak.lastDate !== today) {
      const diff = daysBetween(today, state.streak.lastDate);
      if (diff > 1) {
        state.streak.current = 0; // ä¸­æ–­
        saveStreak();
      }
    }
  }
  
  const todayCount = localStorage.getItem(STORAGE.todayCount);
  if (todayCount) {
    const data = JSON.parse(todayCount);
    if (data.date === todayString()) {
      state.completedPomodoros = data.count;
    } else {
      state.completedPomodoros = 0;
    }
  }
  
  applySettings();
  updateStreakDisplay();
}

function saveSettings() {
  localStorage.setItem(STORAGE.settings, JSON.stringify(state.settings));
}

function saveStreak() {
  localStorage.setItem(STORAGE.streak, JSON.stringify(state.streak));
}

function saveTodayCount() {
  localStorage.setItem(STORAGE.todayCount, JSON.stringify({
    date: todayString(),
    count: state.completedPomodoros,
  }));
}

function applySettings() {
  document.querySelectorAll('audio').forEach(audio => {
    audio.volume = state.settings.soundVolume / 100;
    audio.muted = !state.settings.soundEnabled;
  });

  if (state.settings.darkMode) {
    document.body.classList.add('dark-mode');
  } else {
    document.body.classList.remove('dark-mode');
  }

  const colors = { pink: '#ff9a9e', blue: '#a2d2ff', mint: '#a0e7a0', purple: '#d0b0ff' };
  document.documentElement.style.setProperty('--pink', colors[state.settings.color] || colors.pink);

  $('character').style.display = state.settings.characterEnabled ? 'block' : 'none';
}

// ==================== è®¡æ—¶å™¨æ ¸å¿ƒ ====================
function tick() {
  if (!state.isRunning) return;
  state.timeLeft--;
  updateDisplay();
  updateTitle();
  updateProgressRing();

  if (state.timeLeft <= 0) {
    completePhase();
  }
}

function completePhase() {
  pause();
  playSound('end');
  showNotification(`é˜¶æ®µå®Œæˆï¼${state.currentPhase === 'work' ? 'ä¼‘æ¯ä¸€ä¸‹å§~' : 'ç»§ç»­åŠ æ²¹ï¼'}`);

  if (state.currentPhase === 'work') {
    // æ›´æ–°ç•ªèŒ„è®¡æ•°
    state.completedPomodoros++;
    saveTodayCount();
    $('todayCount').textContent = state.completedPomodoros;

    // æ›´æ–°è¿ç»­å¤©æ•°
    const today = todayString();
    if (state.streak.lastDate === today) {
      // ä»Šå¤©å·²ç»å®Œæˆè¿‡ï¼Œä¸å¢åŠ è¿ç»­å¤©æ•°
    } else {
      const diff = state.streak.lastDate ? daysBetween(today, state.streak.lastDate) : 1;
      if (diff === 1) {
        state.streak.current++;
        showNotification(`è¿ç»­ ${state.streak.current} å¤©ï¼`);
      } else if (diff > 1 || !state.streak.lastDate) {
        state.streak.current = 1;
        showNotification('è¿ç»­å¤©æ•°é‡ç½®');
      }
      state.streak.lastDate = today;
      
      if (state.streak.current > state.streak.best) {
        state.streak.best = state.streak.current;
        showNotification(`ğŸ‰ æ–°çºªå½•ï¼æœ€é•¿è¿ç»­ ${state.streak.best} å¤©ï¼`);
      }
      
      saveStreak();
      updateStreakDisplay();
    }

    // å¾ªç¯é€»è¾‘
    state.completedCycles++;
    if (state.completedCycles % 4 === 0) {
      state.currentPhase = 'longBreak';
      state.timeLeft = state.settings.longBreakTime * 60;
      state.totalTime = state.settings.longBreakTime * 60;
      celebrate('ğŸ‰ å®Œæˆ4ä¸ªç•ªèŒ„ï¼é•¿ä¼‘æ¯ï¼');
    } else {
      state.currentPhase = 'shortBreak';
      state.timeLeft = state.settings.shortBreakTime * 60;
      state.totalTime = state.settings.shortBreakTime * 60;
    }
  } else {
    state.currentPhase = 'work';
    state.timeLeft = state.settings.workTime * 60;
    state.totalTime = state.settings.workTime * 60;
  }

  updateDisplay();
  updateProgressRing();

  if (state.settings.autoStart) {
    setTimeout(() => start(), 2000);
  }
}

function start() {
  if (state.isRunning) return;
  state.isRunning = true;
  $('startBtn').style.display = 'none';
  $('pauseBtn').style.display = 'inline-block';
  playSound('start');
  state.timer = setInterval(tick, 1000);
}

function pause() {
  state.isRunning = false;
  $('startBtn').style.display = 'inline-block';
  $('pauseBtn').style.display = 'none';
  clearInterval(state.timer);
}

function reset() {
  pause();
  state.currentPhase = 'work';
  state.timeLeft = state.settings.workTime * 60;
  state.totalTime = state.settings.workTime * 60;
  updateDisplay();
  updateProgressRing();
  updateTitle();
}

function skip() {
  completePhase();
}

// ==================== è§†å›¾æ›´æ–° ====================
function updateDisplay() {
  $('timerDisplay').textContent = formatTime(state.timeLeft);
  const phaseNames = {
    work: 'å·¥ä½œé˜¶æ®µ',
    shortBreak: 'çŸ­ä¼‘æ¯',
    longBreak: 'é•¿ä¼‘æ¯'
  };
  $('phaseLabel').textContent = phaseNames[state.currentPhase];
  updateCharacter();
}

function updateTitle() {
  document.title = state.isRunning ? `${formatTime(state.timeLeft)} - ç•ªèŒ„é’Ÿ` : 'ç•ªèŒ„é’Ÿ';
}

function updateProgressRing() {
  const progress = state.timeLeft / state.totalTime;
  const angle = 360 * progress;
  const color = getComputedStyle(document.documentElement).getPropertyValue('--pink');
  // å½©è‰²éƒ¨åˆ†ä»0åˆ°angleåº¦ï¼Œå…¶ä½™é€æ˜
  $('progressRing').style.background = `conic-gradient(${color} 0deg, ${color} ${angle}deg, transparent ${angle}deg)`;
}

function updateCharacter() {
  const char = $('character');
  if (!state.settings.characterEnabled) return;
  const moods = {
    work: '#ff9a9e',
    shortBreak: '#a2d2ff',
    longBreak: '#a0e7a0'
  };
  char.style.background = moods[state.currentPhase];
}

function updateStreakDisplay() {
  $('currentStreak').textContent = state.streak.current;
  $('bestStreak').textContent = state.streak.best;
  $('modalCurrentStreak').textContent = state.streak.current;
  $('modalBestStreak').textContent = state.streak.best;
}

function showNotification(msg) {
  const notification = document.createElement('div');
  notification.className = 'notification pixel-border';
  notification.textContent = msg;
  document.body.appendChild(notification);
  setTimeout(() => notification.remove(), 3000);
}

function celebrate(msg) {
  if (!state.settings.achievements) return;
  showNotification(msg);
  document.body.classList.add('achievement');
  setTimeout(() => document.body.classList.remove('achievement'), 500);
}

function playSound(type) {
  if (!state.settings.soundEnabled) return;
  const sounds = { start: 'soundStart', end: 'soundEnd', remind: 'soundRemind' };
  const audio = $(sounds[type]);
  if (audio) {
    audio.currentTime = 0;
    audio.play().catch(() => {});
  }
}

// ==================== äº‹ä»¶ç»‘å®š ====================
$('startBtn').addEventListener('click', start);
$('pauseBtn').addEventListener('click', pause);
$('resetBtn').addEventListener('click', reset);
$('skipBtn').addEventListener('click', skip);

document.addEventListener('keydown', e => {
  if (e.target.tagName === 'INPUT') return;
  switch(e.key) {
    case ' ': e.preventDefault(); state.isRunning ? pause() : start(); break;
    case 'r': case 'R': reset(); break;
    case 's': case 'S': skip(); break;
  }
  if (e.ctrlKey && e.key === 's') { e.preventDefault(); openModal('settingsModal'); }
  if (e.ctrlKey && e.key === 'r') { e.preventDefault(); reset(); }
});

// æ¨¡æ€æ¡†
function openModal(id) { $(id).style.display = 'block'; }
function closeModal(id) { $(id).style.display = 'none'; }

$('settingsBtn').addEventListener('click', () => openModal('settingsModal'));
$('statsBtn').addEventListener('click', () => { openModal('statsModal'); updateStreakDisplay(); });
$('themeBtn').addEventListener('click', () => openModal('themeModal'));
$('aboutBtn').addEventListener('click', () => openModal('aboutModal'));

document.querySelectorAll('.close-btn').forEach(btn => {
  btn.addEventListener('click', e => {
    const modal = e.target.closest('.modal');
    if (modal) modal.style.display = 'none';
  });
});

document.querySelectorAll('.modal').forEach(modal => {
  modal.addEventListener('click', e => {
    if (e.target === modal) modal.style.display = 'none';
  });
});

// è®¾ç½®å˜æ›´
['workTime','shortBreakTime','longBreakTime'].forEach(id => {
  $(id).addEventListener('change', e => {
    state.settings[id] = parseInt(e.target.value);
    saveSettings();
    if (!state.isRunning && state.currentPhase === 'work' && id === 'workTime') {
      reset();
    }
  });
});

['autoStart', 'soundEnabled'].forEach(id => {
  $(id).addEventListener('change', e => {
    state.settings[id] = e.target.checked;
    saveSettings();
  });
});

$('volume').addEventListener('input', e => {
  state.settings.soundVolume = parseInt(e.target.value);
  saveSettings();
  document.querySelectorAll('audio').forEach(audio => audio.volume = state.settings.soundVolume / 100);
});

$('darkMode').addEventListener('change', e => {
  state.settings.darkMode = e.target.checked;
  saveSettings();
  applySettings();
});

$('colorScheme').addEventListener('change', e => {
  state.settings.color = e.target.value;
  saveSettings();
  applySettings();
});

$('showCharacter').addEventListener('change', e => {
  state.settings.characterEnabled = e.target.checked;
  saveSettings();
  $('character').style.display = e.target.checked ? 'block' : 'none';
});

// ==================== åˆå§‹åŒ– ====================
window.addEventListener('load', () => {
  loadSettings();
  updateDisplay();
  updateProgressRing();
  if (!localStorage.getItem('visited')) {
    localStorage.setItem('visited', 'true');
    setTimeout(() => showNotification('ğŸ‰ æ¬¢è¿ä½¿ç”¨åƒç´ ç•ªèŒ„é’Ÿï¼æŒ‰ç©ºæ ¼é”®å¼€å§‹'), 1000);
  }
  console.log('%cè¾“å…¥ VIP(true) æ¿€æ´»VIPæ¨¡å¼', 'color:var(--pink);font-family:Press Start 2P;font-size:12px;');
});
</script>
</body>
</html>