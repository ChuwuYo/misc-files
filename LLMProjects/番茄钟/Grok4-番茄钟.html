<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>番茄钟</title>
    <style>
        /* 像素字体 - 使用CSS模拟简单像素字体 */
        @font-face {
            font-family: 'PixelFont';
            src: url('data:font/woff;base64,...') format('woff'); /* 实际可替换为base64字体，如Press Start 2P */
            /* 为简化，这里用system font fallback */
        }
        :root {
            --main-color: #FFB6C1; /* 粉 */
            --accent-color: #ADD8E6; /* 蓝 */
            --bg-color: #F0F8FF;
            --text-color: #333;
            --pixel-size: 4px; /* 像素艺术缩放 */
        }
        body.dark {
            --main-color: #C71585;
            --accent-color: #4169E1;
            --bg-color: #2F4F4F;
            --text-color: #EEE;
        }
        /* 色系主题 */
        body.green-theme {
            --main-color: #90EE90;
            --accent-color: #228B22;
        }
        body.purple-theme {
            --main-color: #DDA0DD;
            --accent-color: #4B0082;
        }
        body {
            font-family: 'PixelFont', monospace;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            font-size: 16px;
            image-rendering: pixelated;
        }
        header {
            font-size: 2em;
            margin-bottom: 1em;
        }
        #timer-display {
            font-size: 3em;
            margin-bottom: 0.5em;
        }
        #phase {
            font-size: 1.5em;
            margin-bottom: 1em;
        }
        #progress {
            width: 80%;
            height: 20px;
            border: 2px solid var(--text-color);
            background: var(--bg-color);
            margin-bottom: 1em;
            position: relative;
            overflow: hidden;
        }
        #progress-bar {
            height: 100%;
            background: linear-gradient(to right, var(--main-color), var(--accent-color));
            width: 0;
            transition: width 0.5s;
        }
        /* 像素进度条效果 */
        #progress-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(45deg, transparent, transparent 2px, rgba(255,255,255,0.2) 2px, rgba(255,255,255,0.2) 4px);
        }
        #controls button {
            background: var(--main-color);
            border: 2px solid var(--text-color);
            color: var(--text-color);
            padding: 0.5em 1em;
            margin: 0.5em;
            cursor: pointer;
            font-family: inherit;
            image-rendering: pixelated;
            transition: transform 0.1s;
        }
        #controls button:hover {
            transform: scale(1.1);
        }
        #pomodoro-count {
            font-size: 1.2em;
            margin-top: 1em;
        }
        /* 像素女孩 - 简单CSS艺术 */
        #pomo-chan {
            width: 64px;
            height: 64px;
            position: relative;
            margin-bottom: 1em;
            transform: scale(var(--pixel-size));
        }
        #pomo-chan::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: /* 简单像素女孩SVG base64 */ url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCI+PHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSJ0cmFuc3BhcmVudCIvPjxyZWN0IHg9IjI0IiB5PSIxNiIgd2lkdGg9IjE2IiBoZWlnaHQ9IjMyIiBmaWxsPSIjRkZCNkMxIi8+PGNpcmNsZSBjeD0iMzIiIGN5PSIxMiIgcj0iOCIgZmlsbD0iI0ZERkQiLz48cmVjdCB4PSIyMCIgeT0iNDgiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiIGZpbGw9IiM5OTk5OTkiLz48cmVjdCB4PSI0MCIgeT0iNDgiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiIGZpbGw9IiM5OTk5OTkiLz48L3N2Zz4='); /* 简单女孩形状 */
            background-size: contain;
        }
        /* 动画 */
        @keyframes breathe {
            0% { transform: translateY(0); }
            50% { transform: translateY(-2px); }
            100% { transform: translateY(0); }
        }
        #pomo-chan.running {
            animation: breathe 2s infinite;
        }
        @keyframes work {
            0% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
            100% { transform: rotate(-5deg); }
        }
        #pomo-chan.work { animation: work 1s infinite; }
        @keyframes rest {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        #pomo-chan.rest { animation: rest 2s infinite; }
        /* 设置模态 */
        #settings-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-color);
            border: 4px solid var(--text-color);
            padding: 2em;
            z-index: 10;
            max-width: 80%;
        }
        #settings-modal label {
            display: block;
            margin: 0.5em 0;
        }
        /* 响应式 */
        @media (max-width: 600px) {
            body { font-size: 14px; }
            #timer-display { font-size: 2em; }
            #controls button { padding: 0.8em 1.5em; }
        }
    </style>
</head>
<body>
    <header>番茄钟</header>
    <div id="pomo-chan"></div>
    <div id="phase">工作时间</div>
    <div id="timer-display">25:00</div>
    <div id="progress"><div id="progress-bar"></div></div>
    <div id="controls">
        <button id="start-pause">开始</button>
        <button id="reset">重置</button>
        <button id="skip">跳过</button>
        <button id="settings-btn">设置</button>
    </div>
    <div id="pomodoro-count">今日番茄: 0</div>

    <div id="settings-modal">
        <h2>设置</h2>
        <label>工作时长 (min): <input type="number" id="work-time" min="1" max="60" value="25"></label>
        <label>短休息 (min): <input type="number" id="short-break" min="1" max="60" value="5"></label>
        <label>长休息 (min): <input type="number" id="long-break" min="1" max="60" value="15"></label>
        <label>音量: <input type="range" id="volume" min="0" max="100" value="50"></label>
        <label>自动开始下一个: <input type="checkbox" id="auto-start" checked></label>
        <label>每分钟提醒: <input type="checkbox" id="minute-remind"></label>
        <label>浅/暗模式: <input type="checkbox" id="dark-mode"></label>
        <label>色系主题: 
            <select id="color-theme">
                <option value="">粉蓝</option>
                <option value="green-theme">绿意</option>
                <option value="purple-theme">紫梦</option>
            </select>
        </label>
        <label>背景音乐: <input type="checkbox" id="bg-music"></label>
        <button id="close-settings">关闭</button>
    </div>

    <script>
        // 音频 - 使用data URL简化，实际可替换为base64编码音频
        const startSound = new Audio('data:audio/wav;base64,'); // 空占位，实际铃声
        const endSound = new Audio('data:audio/wav;base64,');
        const remindSound = new Audio('data:audio/wav;base64,');
        const bgMusic = new Audio('data:audio/mp3;base64,'); // 空占位
        bgMusic.loop = true;

        // 变量
        let timerInterval = null;
        let currentPhase = 'work'; // 'work', 'short', 'long'
        let remainingTime = 25 * 60;
        let initialTime = 25 * 60;
        let pomodoroCount = 0;
        let totalPomodoro = 0; // 历史总计
        let phaseCount = 0; // 追踪工作次数
        let isRunning = false;
        let autoStart = true;
        let volume = 0.5;
        let minuteRemind = false;
        let lastMinute = -1;
        let today = new Date().toDateString();
        let settings = {
            work: 25,
            short: 5,
            long: 15
        };

        // 加载LocalStorage
        function loadData() {
            const savedSettings = localStorage.getItem('pomo_settings');
            if (savedSettings) {
                settings = JSON.parse(savedSettings);
                document.getElementById('work-time').value = settings.work;
                document.getElementById('short-break').value = settings.short;
                document.getElementById('long-break').value = settings.long;
            }
            const savedVolume = localStorage.getItem('pomo_volume');
            if (savedVolume) {
                volume = parseFloat(savedVolume);
                document.getElementById('volume').value = volume * 100;
            }
            const savedAuto = localStorage.getItem('pomo_auto');
            autoStart = savedAuto !== 'false';
            document.getElementById('auto-start').checked = autoStart;
            const savedRemind = localStorage.getItem('pomo_remind');
            minuteRemind = savedRemind === 'true';
            document.getElementById('minute-remind').checked = minuteRemind;
            const savedDark = localStorage.getItem('pomo_dark');
            document.body.classList.toggle('dark', savedDark === 'true');
            document.getElementById('dark-mode').checked = savedDark === 'true';
            const savedTheme = localStorage.getItem('pomo_theme');
            if (savedTheme) document.body.className = savedTheme;
            document.getElementById('color-theme').value = savedTheme || '';
            const savedBgMusic = localStorage.getItem('pomo_bgmusic');
            document.getElementById('bg-music').checked = savedBgMusic === 'true';
            if (savedBgMusic === 'true') bgMusic.play();
            const savedDate = localStorage.getItem('pomo_last_date');
            const savedCount = localStorage.getItem('pomo_today_count');
            if (savedDate === today) {
                pomodoroCount = parseInt(savedCount) || 0;
            } else {
                pomodoroCount = 0;
            }
            const savedTotal = localStorage.getItem('pomo_total');
            totalPomodoro = parseInt(savedTotal) || 0;
            updateDisplay();
        }

        // 保存数据
        function saveData() {
            localStorage.setItem('pomo_settings', JSON.stringify(settings));
            localStorage.setItem('pomo_volume', volume);
            localStorage.setItem('pomo_auto', autoStart);
            localStorage.setItem('pomo_remind', minuteRemind);
            localStorage.setItem('pomo_dark', document.body.classList.contains('dark'));
            localStorage.setItem('pomo_theme', document.getElementById('color-theme').value);
            localStorage.setItem('pomo_bgmusic', document.getElementById('bg-music').checked);
            localStorage.setItem('pomo_last_date', today);
            localStorage.setItem('pomo_today_count', pomodoroCount);
            localStorage.setItem('pomo_total', totalPomodoro);
        }

        // 更新显示
        function updateDisplay() {
            const minutes = Math.floor(remainingTime / 60);
            const seconds = remainingTime % 60;
            document.getElementById('timer-display').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            const progress = ((initialTime - remainingTime) / initialTime) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            let phaseText = currentPhase === 'work' ? '工作时间' : (currentPhase === 'short' ? '短休息' : '长休息');
            document.getElementById('phase').textContent = phaseText;
            document.getElementById('pomodoro-count').textContent = `今日番茄: ${pomodoroCount}`;
            const chan = document.getElementById('pomo-chan');
            chan.classList.toggle('running', isRunning);
            chan.classList.remove('work', 'rest');
            if (isRunning) {
                if (currentPhase === 'work') chan.classList.add('work');
                else chan.classList.add('rest');
            }
            if (isRunning) {
                document.title = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')} - 番茄钟`;
            } else {
                document.title = '番茄钟';
            }
        }

        // 开始/暂停
        function toggleStartPause() {
            if (isRunning) {
                clearInterval(timerInterval);
                document.getElementById('start-pause').textContent = '开始';
            } else {
                startTimer();
                document.getElementById('start-pause').textContent = '暂停';
                playSound(startSound);
            }
            isRunning = !isRunning;
            updateDisplay();
        }

        // 开始计时
        function startTimer() {
            timerInterval = setInterval(() => {
                if (remainingTime > 0) {
                    remainingTime--;
                    const currentMinute = Math.floor(remainingTime / 60);
                    if (minuteRemind && currentMinute !== lastMinute && remainingTime % 60 === 59) {
                        playSound(remindSound);
                        lastMinute = currentMinute;
                    }
                    updateDisplay();
                } else {
                    clearInterval(timerInterval);
                    playSound(endSound);
                    if (currentPhase === 'work') {
                        pomodoroCount++;
                        totalPomodoro++;
                        phaseCount++;
                        saveData();
                    }
                    nextPhase();
                }
            }, 1000);
        }

        // 下一个阶段
        function nextPhase() {
            if (currentPhase === 'work') {
                if (phaseCount % 4 === 0) {
                    currentPhase = 'long';
                    initialTime = settings.long * 60;
                } else {
                    currentPhase = 'short';
                    initialTime = settings.short * 60;
                }
            } else {
                currentPhase = 'work';
                initialTime = settings.work * 60;
            }
            remainingTime = initialTime;
            updateDisplay();
            if (autoStart) {
                isRunning = true;
                startTimer();
                document.getElementById('start-pause').textContent = '暂停';
                playSound(startSound);
            } else {
                isRunning = false;
                document.getElementById('start-pause').textContent = '开始';
            }
        }

        // 重置
        function resetTimer() {
            remainingTime = initialTime;
            updateDisplay();
        }

        // 跳过
        function skipPhase() {
            clearInterval(timerInterval);
            if (currentPhase === 'work') {
                pomodoroCount++; // 跳过也算完成？
                totalPomodoro++;
                phaseCount++;
                saveData();
            }
            nextPhase();
        }

        // 播放声音
        function playSound(sound) {
            sound.volume = volume;
            sound.play();
        }

        // 事件监听
        document.getElementById('start-pause').addEventListener('click', toggleStartPause);
        document.getElementById('reset').addEventListener('click', resetTimer);
        document.getElementById('skip').addEventListener('click', skipPhase);
        document.getElementById('settings-btn').addEventListener('click', () => {
            document.getElementById('settings-modal').style.display = 'block';
        });
        document.getElementById('close-settings').addEventListener('click', () => {
            document.getElementById('settings-modal').style.display = 'none';
            // 应用设置
            settings.work = parseInt(document.getElementById('work-time').value) || 25;
            settings.short = parseInt(document.getElementById('short-break').value) || 5;
            settings.long = parseInt(document.getElementById('long-break').value) || 15;
            if (currentPhase === 'work') initialTime = settings.work * 60;
            else if (currentPhase === 'short') initialTime = settings.short * 60;
            else initialTime = settings.long * 60;
            remainingTime = initialTime;
            volume = document.getElementById('volume').value / 100;
            autoStart = document.getElementById('auto-start').checked;
            minuteRemind = document.getElementById('minute-remind').checked;
            document.body.classList.toggle('dark', document.getElementById('dark-mode').checked);
            const theme = document.getElementById('color-theme').value;
            document.body.className = document.body.classList.contains('dark') ? 'dark ' + theme : theme;
            const bgChecked = document.getElementById('bg-music').checked;
            if (bgChecked) bgMusic.play();
            else bgMusic.pause();
            saveData();
            updateDisplay();
        });

        // 键盘快捷键
        document.addEventListener('keydown', (e) => {
            if (e.key === ' ') toggleStartPause();
            if (e.key === 'r' || e.key === 'R') resetTimer();
            if (e.key === 's' || e.key === 'S') skipPhase();
        });

        // 初始化
        loadData();
        initialTime = settings.work * 60;
        remainingTime = initialTime;
        updateDisplay();
    </script>
</body>
</html>