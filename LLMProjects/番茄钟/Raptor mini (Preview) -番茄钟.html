<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ç•ªèŒ„é’Ÿ</title>
<style>
:root{
  --bg:#f7f3ff;
  --card:#ffffff;
  --accent:#ff9ab6;
  --accent-2:#a0d1ff;
  --muted:#bdb6c9;
  --pixel-size:8px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family: 'Press Start 2P', monospace, 'Courier New', monospace; background:linear-gradient(180deg,var(--bg),#fff);color:#2d2d2d}
.container{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px}
.card{width:100%;max-width:960px;background:var(--card);border-radius:14px;padding:18px;border:6px solid var(--accent);box-shadow: 0 12px 30px rgba(24,24,24,0.08)}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.logo{display:flex;gap:12px;align-items:center}
.pixel-logo{width:56px;height:56px;display:grid;grid-template-columns:repeat(8,1fr);grid-template-rows:repeat(8,1fr);gap:1px;image-rendering:pixelated}
.pixel{background:var(--accent-2);}
.pixel.off{background: #fff2f6}
.title{font-size:18px}
.title h1{margin:0;font-size:20px}
.controls{display:flex;gap:8px;align-items:center}
.icon{width:36px;height:36px;border-radius:4px;background:linear-gradient(180deg,var(--accent-2),#86bff6);display:flex;align-items:center;justify-content:center;box-shadow:inset -2px -2px 0 rgba(255,255,255,0.4),inset 2px 2px 0 rgba(0,0,0,0.05);cursor:pointer}
.grid-layout{display:grid;grid-template-columns:1fr 320px;gap:16px}
.timer-area{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:18px}
.timer{font-size:48px;margin:8px 0;letter-spacing:4px}
.timer.small{font-size:36px}
.phase{font-size:12px;color:var(--muted)}
.buttons{display:flex;gap:10px;margin-top:12px}
.btn{background:linear-gradient(180deg,#fff,#e6f5ff);border:4px solid #2c3d55;padding:10px 12px;border-radius:6px;cursor:pointer;font-size:12px}
.btn.pixel{font-family:monospace;padding:8px;border-radius:4px;border:3px solid #000;box-shadow:3px 3px 0 rgba(0,0,0,0.2)}
.progress{width:100%;height:18px;margin-top:16px;background:#f1f1f1;border-radius:4px;overflow:hidden}
.progress-inner{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:0}
.side{padding:12px;border-left:6px solid #fde0ef}
.stat{font-size:12px;color:#2b2b2b;background:linear-gradient(180deg,#fff,#fff0f7);border-radius:8px;padding:12px;margin-bottom:12px;border:4px solid #fff}
.settings{background:#fff; padding:12px;border-radius:8px;border:4px solid #fff}
.setting-row{display:flex;align-items:center;justify-content:space-between;padding:8px 0}
.small{font-size:12px;color:var(--muted)}
.theme-swaps{display:flex;gap:8px}
.theme-btn{width:32px;height:28px;border-radius:6px;border:3px solid #000;cursor:pointer}
.pixel-char{width:160px;height:160px;background:#f7f7f7;display:grid;place-items:center;margin:10px auto;border-radius:8px}
.pixel-sprite{width:112px;height:112px;image-rendering:pixelated}
.pixel-behavior.live{ transform:translateY(-6px); transition:transform 300ms cubic-bezier(.2,.9,.3,1) }
.small-note{font-size:11px;color:var(--muted);margin-top:8px}
.footer{padding-top:12px;text-align:center;font-size:11px;color:var(--muted)}
@media (max-width:900px){
  .grid-layout{grid-template-columns:1fr}
  .side{border-left:none;border-top:6px solid #fde0ef}
  .timer{font-size:36px}
}
/* Pixel-styled controls */
.pixel-btn{background:#fff;border:4px solid #111;padding:8px 10px;font-weight:700}
.pixel-picker input{width:60px}
</style>
</head>
<body>
<div class="container">
  <div class="card" role="application">
    <div class="header">
      <div class="logo">
        <div class="pixel-logo" id="logo"></div>
        <div class="title"><h1>ç•ªèŒ„é’Ÿ</h1><div class="small">åƒç´ å°æ¸…æ–° + äºŒæ¬¡å…ƒåƒç´ è‰ºæœ¯</div></div>
      </div>
      <div class="controls">
        <div class="icon" id="toggle-theme" title="ä¸»é¢˜åˆ‡æ¢">ğŸŒ—</div>
        <div class="icon" id="open-settings" title="è®¾ç½®">âš™ï¸</div>
      </div>
    </div>

    <div class="grid-layout">
      <div class="timer-area">
        <div class="phase" id="phase-label">å·¥ä½œ</div>
        <div class="timer" id="timer">25:00</div>
        <div class="pixel-char" title="å¯çˆ±åƒç´ è§’è‰²">
          <canvas id="sprite" class="pixel-sprite" width="28" height="28" style="width:112px;height:112px"></canvas>
        </div>
        <div class="buttons">
          <button class="btn pixel" id="start-pause">å¼€å§‹</button>
          <button class="btn" id="reset">é‡ç½®</button>
          <button class="btn" id="skip">è·³è¿‡</button>
        </div>
        <div class="progress" aria-hidden>
          <div class="progress-inner" id="progress"></div>
        </div>
        <div class="small-note">å¿«æ·é”®ï¼šç©ºæ ¼ å¼€å§‹/æš‚åœ | R é‡ç½® | S è·³è¿‡</div>
      </div>

      <div class="side">
        <div class="stat" id="stats">ä»Šå¤©å·²å®Œæˆï¼š0 ç•ªèŒ„</div>
        <div class="settings" id="settings">
          <div class="setting-row"><div>å·¥ä½œæ—¶é•¿</div><div><input type="number" id="work-duration" min="1" value="25"> åˆ†</div></div>
          <div class="setting-row"><div>çŸ­ä¼‘æ¯</div><div><input type="number" id="short-duration" min="1" value="5"> åˆ†</div></div>
          <div class="setting-row"><div>é•¿ä¼‘æ¯</div><div><input type="number" id="long-duration" min="1" value="15"> åˆ†</div></div>
          <div class="setting-row"><div>éŸ³é‡</div><div><input id="volume" type="range" min="0" max="1" step="0.01" value="0.4"></div></div>
          <div class="setting-row"><div>è‡ªåŠ¨æ’­æ”¾ä¸‹æ®µ</div><div><label><input id="auto-play" type="checkbox"> å¼€å¯</label></div></div>
          <div class="setting-row"><div>é•¿ä¼‘è§¦å‘é¢‘ç‡</div><div><input id="long-every" type="number" min="1" value="4"> æ¬¡</div></div>
          <div style="padding-top:8px;display:flex;gap:8px;justify-content:space-between">
            <button class="btn" id="save-settings">ä¿å­˜</button>
            <button class="btn" id="reset-stats">æ¸…ç©ºè®¡æ•°</button>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">å¯è‡ªç”±æ‰©å±•ï¼šåƒç´ è§’è‰²ã€æ›´å¤šéŸ³æ•ˆä¸ä¸»é¢˜å·²é¢„ç•™é…ç½®ã€‚</div>
  </div>
</div>

<script>
/*
SPEC (æ ¹æ®æç¤º):
1. æ ¸å¿ƒåŠŸèƒ½ï¼š25/5/15 çš„è®¡æ—¶å™¨ï¼ˆé»˜è®¤ï¼‰ï¼Œå¯è°ƒèŠ‚ï¼Œè‡ªå¸¦å¼€å§‹/æš‚åœ/é‡ç½®/è·³è¿‡
2. è‡ªåŠ¨å¾ªç¯ï¼Œé•¿ä¼‘æ¯æ¯ N æ¬¡ï¼ˆé»˜è®¤ 4ï¼‰ä¹‹åè§¦å‘
3. ç»Ÿè®¡ä»Šå¤©å®Œæˆçš„ç•ªèŒ„é’Ÿå¹¶ä¿å­˜åœ¨ localStorage
4. è®¾ç½®é¢æ¿ï¼šæ—¶é•¿ã€éŸ³é‡ã€è‡ªåŠ¨æ’­æ”¾ã€é•¿ä¼‘è§¦å‘é¢‘ç‡
5. éŸ³æ•ˆé€šè¿‡ WebAudio åŠ¨æ€ç”Ÿæˆï¼ˆä¸ä¾èµ–å¤–éƒ¨éŸ³é¢‘æ–‡ä»¶ï¼‰
6. é”®ç›˜å¿«æ·é”®ï¼šç©ºæ ¼ å¼€å§‹/æš‚åœï¼ŒR é‡ç½®ï¼ŒS è·³è¿‡
7. é¡µé¢æ ‡é¢˜åŠ¨æ€æ˜¾ç¤ºï¼ˆè¿è¡Œä¸­å€’è®¡æ—¶ï¼‰
8. åƒç´ é£æ ¼ï¼š8-bit ç±»ä¼¼å­—ä½“ã€åƒç´ è§’è‰² canvasã€åƒç´ åŒ–æŒ‰é’®æ ·å¼
9. å•ä¸€HTMLï¼šæ ·å¼å’Œè„šæœ¬å…¨å†…è”
*/

// --- storage keys
const STORAGE_KEYS = { SETTINGS: 'pomodoro_settings_v1', STATS: 'pomodoro_stats_v1' };

// default settings
const defaultSettings = {
  work: 25,
  short: 5,
  long: 15,
  volume: 0.4,
  autoPlay: false,
  longEvery: 4
};

// load settings
function loadSettings(){
  try{const s=JSON.parse(localStorage.getItem(STORAGE_KEYS.SETTINGS) || 'null');return s?Object.assign({},defaultSettings,s):Object.assign({},defaultSettings);}catch(e){return Object.assign({},defaultSettings);} }

function saveSettings(s){localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(s));}

// stats
function loadStats(){
  try{return JSON.parse(localStorage.getItem(STORAGE_KEYS.STATS) || 'null') || {date: todayIso(), count:0}}catch(e){return {date:todayIso(),count:0}}}
function saveStats(st){localStorage.setItem(STORAGE_KEYS.STATS, JSON.stringify(st));}
function todayIso(){const d=new Date();return d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate();}

// UI refs
const elTimer = document.getElementById('timer');
const elPhase = document.getElementById('phase-label');
const elStart = document.getElementById('start-pause');
const elReset = document.getElementById('reset');
const elSkip = document.getElementById('skip');
const elProgress = document.getElementById('progress');
const elStats = document.getElementById('stats');
const elWork = document.getElementById('work-duration');
const elShort = document.getElementById('short-duration');
const elLong = document.getElementById('long-duration');
const elVolume = document.getElementById('volume');
const elAutoPlay = document.getElementById('auto-play');
const elSaveSettings = document.getElementById('save-settings');
const elResetStats = document.getElementById('reset-stats');
const elLongEvery = document.getElementById('long-every');
const elSettingsToggle = document.getElementById('open-settings');
const elThemeToggle = document.getElementById('toggle-theme');
const canvas = document.getElementById('sprite');

// state
let settings = loadSettings();
let stats = loadStats();
if (stats.date !== todayIso()) { stats.count = 0; stats.date = todayIso(); saveStats(stats); }

// Timer logic
let state = {
  phase: 'work', // work | short_break | long_break
  running: false,
  remaining: settings.work * 60,
  duration: {work: settings.work*60, short: settings.short*60, long: settings.long*60},
  cycles: 0 // completed work cycles
};

// audio via WebAudio
const audioCtx = new (window.AudioContext||window.webkitAudioContext)();
let masterGain = audioCtx.createGain(); masterGain.gain.value = settings.volume; masterGain.connect(audioCtx.destination);
function beep(type='tick'){ // simple beep patterns
  const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type = 'square';
  if(type==='start'){ o.frequency.value=880; }
  else if(type==='end'){ o.frequency.value=440; }
  else { o.frequency.value=660; }
  g.gain.value = masterGain.gain.value;
  o.connect(g); g.connect(audioCtx.destination);
  o.start(); g.gain.setValueAtTime(g.gain.value, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.15);
  o.stop(audioCtx.currentTime + 0.18);
}

// utils
function formatTime(t){ const m=Math.floor(t/60); const s=t%60; return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }
function updateTitle(){ if(state.running) document.title = `ç•ªèŒ„é’Ÿ - ${formatTime(state.remaining)}`; else document.title = 'ç•ªèŒ„é’Ÿ'; }

// UI update
function render(){
  elTimer.textContent = formatTime(state.remaining);
  elPhase.textContent = (state.phase==='work')? 'å·¥ä½œ' : (state.phase==='short_break')? 'çŸ­ä¼‘æ¯' : 'é•¿ä¼‘æ¯';
  updateTitle();
  // progress
  let total = state.duration[state.phase==='work'?'work': state.phase==='short_break'?'short':'long'];
  const percent = (total-state.remaining)/total*100;
  elProgress.style.width = Math.max(0,Math.min(100,percent)) + '%';
  // stats
  elStats.textContent = `ä»Šå¤©å·²å®Œæˆï¼š${stats.count} ç•ªèŒ„`;
  // start button
  elStart.textContent = state.running ? 'æš‚åœ' : 'å¼€å§‹';
  // settings inputs
  elWork.value = Math.round(state.duration.work/60);
  elShort.value = Math.round(state.duration.short/60);
  elLong.value = Math.round(state.duration.long/60);
}

// switching phases
function enterPhase(phase){
  state.phase = phase;
  state.duration.work = (settings.work*60);
  state.duration.short = (settings.short*60);
  state.duration.long = (settings.long*60);
  // remaining is new phase's duration
  state.remaining = state.duration[phase==='work'?'work': phase==='short_break'?'short':'long'];
  render();
}

function onTimerEnd(){
  // beep and logic
  beep('end');
  if(state.phase === 'work'){
    stats.count++; saveStats(stats);
    state.cycles++;
  }
  // choose next phase
  if(state.phase === 'work'){
    if(state.cycles % settings.longEvery === 0) enterPhase('long_break');
    else enterPhase('short_break');
  } else {
    enterPhase('work');
  }
  // autoplay
  if(settings.autoPlay){ start(); }
  else { state.running = false; render(); }
}

// timer tick
let tickInterval;
function start(){ if(state.running) return; state.running = true; beep('start'); render();
  if(audioCtx.state === 'suspended') audioCtx.resume();
  tickInterval = setInterval(()=>{ state.remaining--; if(state.remaining <=0){ clearInterval(tickInterval); onTimerEnd(); } render(); }, 1000); }
function pause(){ if(!state.running) return; state.running=false; beep('tick'); clearInterval(tickInterval); render(); }
function reset(){ pause(); // reset to current phase duration
  state.duration.work = settings.work*60; state.duration.short = settings.short*60; state.duration.long = settings.long*60;
  state.remaining = state.duration[state.phase==='work'?'work':state.phase==='short_break'?'short':'long']; render(); }

function skip(){ pause(); // move to next phase
  if(state.phase === 'work'){ state.cycles++; stats.count++; saveStats(stats); if(state.cycles % settings.longEvery === 0) enterPhase('long_break'); else enterPhase('short_break'); }
  else { enterPhase('work'); }
  if(settings.autoPlay){ start(); }
}

// events
elStart.addEventListener('click', ()=> state.running ? pause() : start());
elReset.addEventListener('click', ()=> reset());
elSkip.addEventListener('click', ()=> skip());

elSaveSettings.addEventListener('click', ()=>{
  settings.work = Math.max(1, parseInt(elWork.value));
  settings.short = Math.max(1, parseInt(elShort.value));
  settings.long = Math.max(1, parseInt(elLong.value));
  settings.volume = parseFloat(elVolume.value);
  settings.autoPlay = elAutoPlay.checked;
  settings.longEvery = Math.max(1, parseInt(elLongEvery.value));
  saveSettings(settings);
  // apply settings
  state.duration.work = settings.work*60; state.duration.short = settings.short*60; state.duration.long = settings.long*60;
  masterGain.gain.value = settings.volume;
  render();
});

elResetStats.addEventListener('click', ()=>{ if(confirm('æ¸…ç©ºä»Šå¤©çš„ç•ªèŒ„è®¡æ•°ï¼Ÿ')){ stats.count=0; saveStats(stats); render(); } });

// keyboard shortcuts
document.addEventListener('keydown', (e)=>{
  if(e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA')) return; // avoid interfering
  if(e.code === 'Space') { e.preventDefault(); state.running ? pause() : start(); }
  if(e.key.toUpperCase() === 'R'){ reset(); }
  if(e.key.toUpperCase() === 'S'){ skip(); }
});

// save settings in UI initial states
function applySettingsToUI(){ elWork.value = settings.work; elShort.value = settings.short; elLong.value = settings.long; elVolume.value = settings.volume; elAutoPlay.checked = settings.autoPlay; elLongEvery.value = settings.longEvery }
applySettingsToUI();

// small pixel builder for logo
(function drawLogo(){ const root = document.getElementById('logo'); const colors = ['#fff0f6','#ffd0e6','#ff9ab6','#a0d1ff','#9ad7a8']; 
 for(let i=0;i<64;i++){ const div=document.createElement('div'); div.className='pixel'; if(Math.random()>0.85) div.className+=' off'; root.appendChild(div);} })();

// pixel sprite drawing
function drawSprite(){ // cute simple face using canvas grid
  const ctx = canvas.getContext('2d'); ctx.imageSmoothingEnabled=false;
  const map = [
    [0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,1,1,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [1,1,2,2,2,2,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [1,2,2,3,3,2,2,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [1,2,3,3,3,3,2,2,2,2,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [1,2,3,3,3,3,2,2,2,2,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [1,2,2,3,3,2,2,2,2,1,1,1,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0],
    [0,1,1,2,2,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
  ];
  const colors = ['transparent','#ffe5f0','#f7a9c4','#000','#ffded5','#9ad7a8','#a0d1ff'];
  const w = map[0].length, h = map.length; 
  for(let y=0;y<h;y++){ for(let x=0;x<w;x++){ const c = map[y][x]||0; ctx.fillStyle = colors[c]; ctx.fillRect(x,y,1,1) }}
}

// animate pixel on play
function pulseSprite(){ const canvasWrap = document.querySelector('.pixel-sprite'); canvasWrap.classList.toggle('live'); }

// draw sprite and wire to start/pause
drawSprite();

// small theme toggle
let dark=false; elThemeToggle.addEventListener('click', ()=>{ dark=!dark; if(dark){ document.documentElement.style.setProperty('--bg','#111'); document.documentElement.style.setProperty('--card','#1a1a2e'); document.documentElement.style.setProperty('--accent','#6a2c70'); document.documentElement.style.setProperty('--accent-2','#b3fffd'); document.documentElement.style.setProperty('--muted','#9a9a9a'); } else { document.documentElement.style.setProperty('--bg','#f7f3ff'); document.documentElement.style.setProperty('--card','#fff'); document.documentElement.style.setProperty('--accent','#ff9ab6'); document.documentElement.style.setProperty('--accent-2','#a0d1ff'); document.documentElement.style.setProperty('--muted','#bdb6c9'); } });

// settings toggles
elSettingsToggle.addEventListener('click', ()=>{ document.getElementById('settings').classList.toggle('open'); });

// audio volume control bind
elVolume.addEventListener('input', (e)=>{ masterGain.gain.value = parseFloat(e.target.value); settings.volume = masterGain.gain.value; saveSettings(settings); });

// apply work duration change live
elWork.addEventListener('change', ()=>{ settings.work = Math.max(1, parseInt(elWork.value)); saveSettings(settings); state.duration.work = settings.work*60; if(state.phase==='work'){ state.remaining=state.duration.work; } render(); });
elShort.addEventListener('change', ()=>{ settings.short = Math.max(1, parseInt(elShort.value)); saveSettings(settings); state.duration.short = settings.short*60; if(state.phase==='short_break'){ state.remaining=state.duration.short; } render(); });
elLong.addEventListener('change', ()=>{ settings.long = Math.max(1, parseInt(elLong.value)); saveSettings(settings); state.duration.long = settings.long*60; if(state.phase==='long_break'){ state.remaining=state.duration.long; } render(); });

// ensure page title synced
setInterval(()=>{ if(!document.hidden) updateTitle(); },1000);

// small interval to animate pixel char when running
setInterval(()=>{ if(state.running){ pulseSprite(); } },1000);

// initial
render();

// share-friendly: if tab hidden, continue timing using Date
(function robustTick(){
  let last = Date.now();
  setInterval(()=>{ if(state.running){ const now = Date.now(); const diff = Math.floor((now-last)/1000); if(diff>0){ state.remaining -= diff; if(state.remaining <=0){ onTimerEnd(); } last = now; render(); } } else { last = Date.now(); } }, 1000);
})();

</script>
</body>
</html>